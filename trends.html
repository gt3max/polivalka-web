<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"><title>PlantApp â€” Trends</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="api-adapter.js"></script>
<script src="common.js"></script>
<style>
    body{font-family:system-ui,Arial;margin:0;padding:0;max-width:100%;background:#fafafa}
    .header{position:sticky;top:0;z-index:1000;background:#2c5f2d;color:#fff;padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .header h1{margin:0;font-size:18px}
    .header-info{font-size:12px;text-align:right;line-height:1.3}
    .nav{position:sticky;top:65px;z-index:999;background:#f0f0f0;padding:5px 8px;display:flex;gap:2px;border-bottom:1px solid #ddd;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch}
    .nav a{text-decoration:none;color:#333;padding:6px 8px;border-radius:6px;font-size:14px;flex-shrink:0}
    .nav a.active{background:#2c5f2d;color:#fff}
    .nav a:hover{background:#ddd}
    .container{padding:12px;max-width:900px;margin:0 auto}
    .card{border:1px solid #ddd;padding:16px;border-radius:12px;margin:12px 0;background:#fff}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .mono{font-family:ui-monospace,monospace}
    button{padding:8px 12px;border-radius:8px;border:1px solid #888;background:#fafafa;cursor:pointer}
    button.primary{background:#2c5f2d;color:#fff;border-color:#2c5f2d}
    button.active{background:#2c5f2d;color:#fff}
    .muted{color:#666;font-size:14px}
    .danger{color:#b00}
    .ok{color:#0a0}
    .status-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:13px;font-weight:600}
    .status-timer{background:#e3f2fd;color:#1976d2}
    .status-sensor{background:#fff3e0;color:#f57c00}
    .status-off{background:#fce4ec;color:#c2185b}
    .status-manual{background:#e0e0e0;color:#616161}
    .chart-container{position:relative;height:250px;margin:16px 0}
    .period-selector{display:flex;gap:4px;margin-bottom:12px}
    .period-selector button{padding:6px 12px;font-size:13px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin:16px 0}
    .stat-box{background:#f5f5f5;padding:12px;border-radius:8px;text-align:center}
    .stat-value{font-size:24px;font-weight:600;color:#2c5f2d}
    .stat-label{font-size:11px;color:#666;margin-top:4px}
    .event-row{padding:10px 12px;margin:4px 0;border-radius:6px;font-size:13px;display:flex;justify-content:space-between;align-items:center}
    .event-pump{background:#e3f2fd;border-left:3px solid #1976d2}
    .event-sensor{background:#e8f5e9;border-left:3px solid #4caf50}
    .event-battery{background:#fff3e0;border-left:3px solid #ff9800}
    .event-system{background:#f5f5f5;border-left:3px solid #9e9e9e}
    .loading{text-align:center;padding:40px;color:#666}
    .error-msg{background:#ffebee;color:#c62828;padding:12px;border-radius:8px;margin:12px 0}
    .tab-buttons{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid #ddd;padding-bottom:8px}
    .tab-buttons button{background:none;border:none;padding:8px 16px;cursor:pointer;border-radius:8px 8px 0 0;color:#666}
    .tab-buttons button.active{background:#2c5f2d;color:#fff}
    .tab-content{display:none}
    .tab-content.active{display:block}
</style>
</head><body>
<div class="header"><div><h1 id="device-id-header" style="margin:0;font-size:15px">ğŸŒ± Polivalka</h1><div style="font-size:13px">ğŸ“ <span id="location-text">â€”</span> / <span id="room-text">â€”</span><span id="custom-name-suffix"></span></div><div style="font-size:11px;margin-top:4px"><span id="battery-status">ğŸ”‹ â€”</span> Â· <span id="header-state">ğŸ’¤ Standby</span></div></div><div class="header-info"><div id="header-time" class="mono" style="font-size:11px">--:--</div><div style="font-size:11px" id="header-mode"><span id="mode-badge" class="status-badge">â€”</span></div><div style="font-size:11px" id="header-conn">ğŸ“¡ <span id="conn-text">Offline</span></div></div></div>
<div class="nav"><a href="/">Fleet</a><a href="home.html">Home</a><a href="identify.html" style="background:#e8f5e9">ğŸŒ± Plant</a><a href="timer.html">Timer</a><a href="sensor.html">Sensor</a><a href="settings.html">Settings</a><a href="calibration.html">Calibration</a><a href="online.html">Online</a><a href="trends.html" class="active">Trends</a><a href="ota.html">Update</a><a href="admin.html" id="admin-nav-link" style="display:none">Admin</a></div>

<div class="container">
  <!-- Stats Summary -->
  <div class="card">
    <h3 style="margin-top:0">ğŸ“Š Summary (<span id="period-label">7 days</span>)</h3>
    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-value" id="stat-waterings">â€”</div>
        <div class="stat-label">Waterings</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="stat-volume">â€”</div>
        <div class="stat-label">Total ml</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="stat-avg-moisture">â€”</div>
        <div class="stat-label">Avg Moisture</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="stat-min-battery">â€”</div>
        <div class="stat-label">Min Battery</div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tab-buttons">
    <button class="active" onclick="showTab('moisture')">ğŸ’§ Moisture</button>
    <button onclick="showTab('battery')">ğŸ”‹ Battery</button>
    <button onclick="showTab('watering')">ğŸš¿ Watering</button>
    <button onclick="showTab('activity')">ğŸ“ Activity</button>
  </div>

  <!-- Period & Chart Controls (right above charts) -->
  <div class="row" style="justify-content:space-between;flex-wrap:wrap;gap:8px;margin:12px 0">
    <div class="period-selector">
      <button onclick="setPeriod(1)" id="btn-1d">24h</button>
      <button onclick="setPeriod(3)" id="btn-3d">3 days</button>
      <button onclick="setPeriod(7)" id="btn-7d" class="active">7 days</button>
    </div>
    <div class="row" style="gap:8px">
      <div class="chart-type-selector" style="display:flex;gap:2px;border:1px solid #ddd;border-radius:8px;overflow:hidden">
        <button onclick="setChartType('line')" id="btn-line" class="active" style="border:none;border-radius:0;padding:6px 10px;font-size:13px">Line</button>
        <button onclick="setChartType('scatter')" id="btn-scatter" style="border:none;border-radius:0;padding:6px 10px;font-size:13px">Dots</button>
      </div>
      <button onclick="exportCSV()" style="padding:6px 10px;font-size:13px">Export</button>
    </div>
  </div>

  <!-- Moisture Chart -->
  <div id="tab-moisture" class="tab-content active">
    <div class="card">
      <h3 style="margin-top:0">ğŸ’§ Capacitive Sensor (J6)</h3>
      <div class="chart-container">
        <canvas id="moisture-chart"></canvas>
      </div>
      <div id="moisture-nodata" class="muted" style="display:none;text-align:center;padding:40px">No moisture data for this period</div>
    </div>
    <div class="card" id="sensor2-chart-card" style="display:none">
      <h3 style="margin-top:0;color:#9c27b0">ğŸŒ¡ï¸ Resistive Sensor (J7)</h3>
      <div class="chart-container">
        <canvas id="sensor2-chart"></canvas>
      </div>
    </div>
    <div id="moisture-loading" class="loading">Loading moisture data...</div>
    <div id="moisture-error" class="error-msg" style="display:none"></div>
  </div>

  <!-- Battery Chart -->
  <div id="tab-battery" class="tab-content">
    <div class="card">
      <h3 style="margin-top:0">ğŸ”‹ Battery Trend</h3>
      <div class="chart-container">
        <canvas id="battery-chart"></canvas>
      </div>
      <div id="battery-nodata" class="muted" style="display:none;text-align:center;padding:40px">No battery data (device on AC power)</div>
      <div id="battery-loading" class="loading">Loading battery data...</div>
      <div id="battery-error" class="error-msg" style="display:none"></div>
    </div>
  </div>

  <!-- Watering Events -->
  <div id="tab-watering" class="tab-content">
    <div class="card">
      <h3 style="margin-top:0">ğŸš¿ Watering Events</h3>
      <div id="watering-summary" class="stats-grid" style="margin-bottom:16px">
        <div class="stat-box"><div class="stat-value" id="watering-count">â€”</div><div class="stat-label">Events</div></div>
        <div class="stat-box"><div class="stat-value" id="watering-total-ml">â€”</div><div class="stat-label">Total ml</div></div>
        <div class="stat-box"><div class="stat-value" id="watering-total-sec">â€”</div><div class="stat-label">Total sec</div></div>
      </div>
      <div id="watering-list"></div>
      <div id="watering-nodata" class="muted" style="display:none;text-align:center;padding:20px">No watering events in this period</div>
      <div id="watering-loading" class="loading">Loading watering events...</div>
    </div>
  </div>

  <!-- Activity Log -->
  <div id="tab-activity" class="tab-content">
    <div class="card">
      <h3 style="margin-top:0">ğŸ“ Activity Log</h3>
      <div id="activity-list"></div>
      <div id="activity-loading" class="loading">Loading activity...</div>
    </div>
  </div>

  <!-- Long-term Trends (from GitHub JSON) -->
  <div class="card" style="margin-top:24px;border-top:3px solid #2c5f2d">
    <h3 style="margin-top:0">ğŸ“ˆ Long-term (<span id="longterm-period-label">6 months</span>)</h3>

    <!-- Long-term Tabs (same style as short-term) -->
    <div class="tab-buttons" id="lt-tab-buttons">
      <button class="active" onclick="showLtTab('moisture')">ğŸ’§ Moisture</button>
      <button onclick="showLtTab('battery')">ğŸ”‹ Battery</button>
      <button onclick="showLtTab('watering')">ğŸš¿ Watering</button>
    </div>

    <!-- Long-term Period & Export (same layout as short-term) -->
    <div class="row" style="justify-content:space-between;flex-wrap:wrap;gap:8px;margin:12px 0">
      <div class="period-selector">
        <button onclick="setLongTermPeriod(4)" id="btn-lt-4w">1mo</button>
        <button onclick="setLongTermPeriod(26)" id="btn-lt-26w" class="active">6mo</button>
        <button onclick="setLongTermPeriod(52)" id="btn-lt-52w">1y</button>
        <button onclick="setLongTermPeriod(104)" id="btn-lt-104w">2y</button>
        <button onclick="setLongTermPeriod(156)" id="btn-lt-156w">3y</button>
      </div>
      <button onclick="exportLongTermCSV()" style="padding:6px 10px;font-size:13px">Export</button>
    </div>

    <!-- Long-term Tab Contents -->
    <div id="lt-tabs-container">
      <!-- Long-term Moisture -->
      <div id="lt-tab-moisture" class="lt-tab-content" style="display:block">
        <h4 style="margin:0 0 8px 0">ğŸ’§ Capacitive Sensor (J6)</h4>
        <div class="chart-container" style="height:250px">
          <canvas id="lt-moisture-chart"></canvas>
        </div>
        <div id="lt-moisture-nodata" class="muted" style="display:none;text-align:center;padding:40px">No moisture data for this period</div>

        <div id="lt-sensor2-section" style="margin-top:16px;display:none">
          <h4 style="margin:0 0 8px 0;color:#9c27b0">ğŸŒ¡ï¸ Resistive Sensor (J7)</h4>
          <div class="chart-container" style="height:250px">
            <canvas id="lt-sensor2-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- Long-term Battery -->
      <div id="lt-tab-battery" class="lt-tab-content" style="display:none">
        <h4 style="margin:0 0 8px 0">ğŸ”‹ Battery Trend</h4>
        <div class="chart-container" style="height:250px">
          <canvas id="lt-battery-chart"></canvas>
        </div>
        <div id="lt-battery-nodata" class="muted" style="display:none;text-align:center;padding:40px">No battery data (device on AC power)</div>
      </div>

      <!-- Long-term Watering -->
      <div id="lt-tab-watering" class="lt-tab-content" style="display:none">
        <h4 style="margin:0 0 8px 0">ğŸš¿ Watering Events</h4>
        <div class="chart-container" style="height:250px">
          <canvas id="lt-watering-chart"></canvas>
        </div>
        <div id="lt-watering-nodata" class="muted" style="display:none;text-align:center;padding:40px">No watering events in this period</div>
      </div>
    </div>

    <div id="longterm-loading" class="loading">Loading long-term data...</div>
    <div id="longterm-error" class="error-msg" style="display:none"></div>
  </div>

  <!-- History List -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
      <h3 style="margin:0">ğŸ“‹ Weekly History</h3>
      <button onclick="exportLongTermCSV()" style="padding:6px 10px;font-size:13px">ğŸ“¥ Export CSV</button>
    </div>
    <div id="history-list" style="margin-top:12px"></div>
  </div>
</div>

<script>
// State
let currentPeriod = 7; // days
let chartType = 'line'; // 'line' (connected) or 'scatter' (points only)
let sensorData = [];
let batteryData = [];
let activityData = [];
let pumpData = []; // Pump events for chart annotations
let moistureChart = null;
let batteryChart = null;

// mapStateToDisplay() - moved to common.js

// Header updates
async function updateHeader() {
  try {
    const s = await API.get('/status');

    // Battery (Cloud mode)
    const batteryStatus = document.getElementById('battery-status');
    if (s.battery && s.battery.percent !== null && s.battery.percent !== undefined) {
      batteryStatus.textContent = `ğŸ”‹ ${Math.round(s.battery.percent)}%${s.battery.charging ? ' âš¡' : ''}`;
    } else {
      batteryStatus.textContent = 'âš¡ AC';
    }
    if (s.system_state?.location) document.getElementById('location-text').textContent = s.system_state.location;
    if (s.system_state?.room) document.getElementById('room-text').textContent = s.system_state.room;
    let customName = s.system_state?.device_name || 'Plant';
    if (customName === 'Polivalka' || customName.toLowerCase().startsWith('polivalka-')) customName = 'Plant';
    document.getElementById('custom-name-suffix').textContent = ' / ' + customName;

    const mode = s.system_state?.mode || 'off';
    const modeBadge = document.getElementById('mode-badge');
    modeBadge.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
    modeBadge.className = 'status-badge status-' + mode;

    document.getElementById('conn-text').textContent = s.wifi_connected ? 'Online' : 'Offline';
    document.getElementById('conn-text').style.color = s.wifi_connected ? '#0a0' : '#999';

    const displayState = mapStateToDisplay(s.system_state?.state, s.pump_running);
    document.getElementById('header-state').textContent = `${displayState.emoji} ${displayState.text}`;
  } catch(e) { console.error('Header update failed:', e); }
}

async function updateBattery() {
  try {
    const b = await API.get('/battery/status');
    const el = document.getElementById('battery-status');
    if (b.percent !== null && b.percent !== undefined) {
      el.textContent = `ğŸ”‹ ${Math.round(b.percent)}%${b.charging ? ' âš¡' : ''}`;
    } else {
      el.textContent = 'âš¡ AC';
    }
  } catch(e) { document.getElementById('battery-status').textContent = 'âš¡ AC'; }
}

async function updateTime() {
  try {
    const t = await API.get('/time/status');
    const timeEl = document.getElementById('header-time');
    if (t.time_set && t.current_time) {
      timeEl.textContent = t.current_time.substring(11,16);
      timeEl.className = 'mono';
    } else {
      timeEl.textContent = '--:--';
      timeEl.className = 'mono danger';
    }
  } catch(e) {}
}

// Period selector
function setPeriod(days) {
  currentPeriod = days;
  document.querySelectorAll('.period-selector button').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-' + days + 'd').classList.add('active');
  document.getElementById('period-label').textContent = days === 1 ? '24 hours' : days + ' days';
  refreshAll();
}

// Chart type selector (line = connected, scatter = points only)
function setChartType(type) {
  chartType = type;
  document.getElementById('btn-line').classList.toggle('active', type === 'line');
  document.getElementById('btn-scatter').classList.toggle('active', type === 'scatter');
  // Re-render charts with new type
  const cutoff = Date.now() - (currentPeriod * 24 * 60 * 60 * 1000);
  const filteredSensor = sensorData.filter(d => d.timestamp * 1000 > cutoff);
  const filteredBattery = batteryData.filter(d => d.timestamp * 1000 > cutoff);
  renderMoistureChart(filteredSensor);
  renderBatteryChart(filteredBattery);
}

// Tab switching
function showTab(name) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  event.target.classList.add('active');
}

// Load sensor history
async function loadSensorHistory() {
  const loading = document.getElementById('moisture-loading');
  const error = document.getElementById('moisture-error');
  loading.style.display = 'block';
  error.style.display = 'none';

  try {
    const data = await API.get('/sensor/history');
    sensorData = data || [];

    // Filter by period
    const cutoff = Date.now() - (currentPeriod * 24 * 60 * 60 * 1000);
    const filtered = sensorData.filter(d => d.timestamp * 1000 > cutoff);

    loading.style.display = 'none';
    renderMoistureChart(filtered);
    updateStats();
  } catch(e) {
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = 'Failed to load sensor data: ' + e.message;
  }
}

// Load battery history
async function loadBatteryHistory() {
  const loading = document.getElementById('battery-loading');
  const error = document.getElementById('battery-error');
  loading.style.display = 'block';
  error.style.display = 'none';

  try {
    const data = await API.get('/battery/history');
    batteryData = data || [];

    const cutoff = Date.now() - (currentPeriod * 24 * 60 * 60 * 1000);
    const filtered = batteryData.filter(d => d.timestamp * 1000 > cutoff);

    loading.style.display = 'none';
    renderBatteryChart(filtered);
    updateStats();
  } catch(e) {
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = 'Failed to load battery data: ' + e.message;
  }
}

// Load pump history (for chart annotations)
// NOTE: Endpoint not implemented yet - silently skip
async function loadPumpHistory() {
  // TODO: Implement /pump/history endpoint when needed
  pumpData = [];
}

// Load activity
async function loadActivity() {
  const loading = document.getElementById('activity-loading');
  const wateringLoading = document.getElementById('watering-loading');
  loading.style.display = 'block';
  wateringLoading.style.display = 'block';

  try {
    const data = await API.get('/activity');
    activityData = data.activity || [];

    const cutoff = Date.now() / 1000 - (currentPeriod * 24 * 60 * 60);
    const filtered = activityData.filter(a => a.timestamp > cutoff);

    loading.style.display = 'none';
    wateringLoading.style.display = 'none';

    const pumpEvents = filtered.filter(a => a.type === 'PUMP');
    renderActivityList(filtered);
    renderWateringSummary(pumpEvents);
    renderWateringList(pumpEvents);
    updateStats();
  } catch(e) {
    loading.style.display = 'none';
    wateringLoading.style.display = 'none';
    document.getElementById('activity-list').innerHTML = '<div class="error-msg">Failed to load activity</div>';
  }
}

// Render moisture chart
function renderMoistureChart(data) {
  const canvas = document.getElementById('moisture-chart');
  const nodata = document.getElementById('moisture-nodata');

  if (moistureChart) {
    moistureChart.destroy();
    moistureChart = null;
  }

  if (data.length === 0) {
    canvas.style.display = 'none';
    nodata.style.display = 'block';
    return;
  }

  // Show canvas, hide nodata message
  canvas.style.display = 'block';
  nodata.style.display = 'none';

  const ctx = canvas.getContext('2d');

  // Sort by timestamp ascending
  data.sort((a, b) => a.timestamp - b.timestamp);

  const labels = data.map(d => new Date(d.timestamp * 1000));
  const values = data.map(d => d.moisture_percent);

  // Create pump event annotations (vertical lines) from activityData
  const cutoff = Date.now() - (currentPeriod * 24 * 60 * 60 * 1000);
  const pumpAnnotations = {};

  // Filter pump events from activity (type=PUMP, message includes 'started')
  const pumpEvents = activityData.filter(a =>
    a.type === 'PUMP' &&
    a.timestamp * 1000 > cutoff &&
    a.message && a.message.toLowerCase().includes('start')
  );

  pumpEvents.forEach((p, i) => {
    // Determine pump type: microprime, manual, or normal watering
    const msg = (p.message || '').toLowerCase();
    let icon = 'ğŸ’§'; // Normal watering
    let color = 'rgba(76, 175, 80, 0.7)'; // Green

    if (msg.includes('microprime')) {
      icon = 'ğŸ’¦'; // Microprime
      color = 'rgba(33, 150, 243, 0.7)'; // Blue
    } else if (msg.includes('manual')) {
      icon = 'âœ‹'; // Manual
      color = 'rgba(255, 152, 0, 0.7)'; // Orange
    }

    pumpAnnotations['pump' + i] = {
      type: 'line',
      xMin: new Date(p.timestamp * 1000),
      xMax: new Date(p.timestamp * 1000),
      borderColor: color,
      borderWidth: 2,
      borderDash: [5, 5],
      label: {
        display: true,
        content: icon,
        position: 'start',
        backgroundColor: 'transparent',
        font: { size: 14 }
      }
    };
  });

  // Chart type settings
  const isScatter = chartType === 'scatter';

  // Capacitive sensor data
  const adcValues = data.map(d => d.adc_raw);
  const hasAdc = adcValues.some(v => v != null);

  // Sensor 2 data (resistive sensor J7)
  const sensor2AdcValues = data.map(d => d.sensor2_adc);
  const sensor2PctValues = data.map(d => d.sensor2_percent);
  const hasSensor2 = sensor2AdcValues.some(v => v != null && v !== undefined);

  // Chart options template
  const chartOptions = (annotations) => ({
    responsive: true,
    maintainAspectRatio: false,
    interaction: { mode: 'nearest', axis: 'x', intersect: false },
    plugins: {
      legend: { position: 'top' },
      tooltip: {
        enabled: true,
        position: 'nearest',
        callbacks: {
          title: (items) => new Date(items[0].parsed.x).toLocaleString(),
          label: (item) => {
            const label = item.dataset.label;
            if (label.includes('%')) return `${label}: ${item.parsed.y}%`;
            return `${label}: ${item.parsed.y}`;
          }
        }
      },
      annotation: { annotations: annotations || {} }
    },
    scales: {
      x: {
        type: 'time',
        time: {
          unit: currentPeriod === 1 ? 'hour' : 'day',
          displayFormats: { hour: 'HH:mm', day: 'MMM d' }
        },
        grid: { display: false }
      },
      y: { type: 'linear', position: 'left', min: 0, max: 100, ticks: { callback: v => v + '%' } },
      y1: { type: 'linear', position: 'right', min: 0, max: 4095, grid: { drawOnChartArea: false } }
    }
  });

  // === Chart 1: Capacitive Sensor (J6) ===
  moistureChart = new Chart(ctx, {
    type: isScatter ? 'scatter' : 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Moisture %',
          data: isScatter ? data.map(d => ({ x: new Date(d.timestamp * 1000), y: d.moisture_percent })) : values,
          borderColor: '#1976d2',
          backgroundColor: isScatter ? '#1976d2' : 'rgba(25, 118, 210, 0.1)',
          fill: !isScatter,
          tension: 0.3,
          pointRadius: isScatter ? 6 : 3,
          yAxisID: 'y'
        },
        {
          label: 'ADC',
          data: isScatter ? data.map(d => ({ x: new Date(d.timestamp * 1000), y: d.adc_raw })) : adcValues,
          borderColor: '#ff9800',
          borderDash: [5, 5],
          fill: false,
          tension: 0.3,
          pointRadius: isScatter ? 5 : 2,
          yAxisID: 'y1',
          hidden: !hasAdc
        }
      ]
    },
    options: chartOptions(pumpAnnotations)
  });

  // === Chart 2: Resistive Sensor (J7) - only if data exists ===
  const sensor2Card = document.getElementById('sensor2-chart-card');
  if (hasSensor2) {
    sensor2Card.style.display = 'block';
    const ctx2 = document.getElementById('sensor2-chart').getContext('2d');

    // Destroy existing chart if any
    if (window.sensor2Chart) window.sensor2Chart.destroy();

    window.sensor2Chart = new Chart(ctx2, {
      type: isScatter ? 'scatter' : 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Moisture %',
            data: isScatter ? data.map(d => ({ x: new Date(d.timestamp * 1000), y: d.sensor2_percent })) : sensor2PctValues,
            borderColor: '#9c27b0',
            backgroundColor: isScatter ? '#9c27b0' : 'rgba(156, 39, 176, 0.1)',
            fill: !isScatter,
            tension: 0.3,
            pointRadius: isScatter ? 6 : 3,
            yAxisID: 'y'
          },
          {
            label: 'ADC',
            data: isScatter ? data.map(d => ({ x: new Date(d.timestamp * 1000), y: d.sensor2_adc })) : sensor2AdcValues,
            borderColor: '#e91e63',
            borderDash: [5, 5],
            fill: false,
            tension: 0.3,
            pointRadius: isScatter ? 5 : 2,
            yAxisID: 'y1'
          }
        ]
      },
      options: chartOptions({})
    });
  } else {
    sensor2Card.style.display = 'none';
  }
}

// Render battery chart
function renderBatteryChart(data) {
  const canvas = document.getElementById('battery-chart');
  const nodata = document.getElementById('battery-nodata');

  if (batteryChart) {
    batteryChart.destroy();
    batteryChart = null;
  }

  // Filter out null percent (AC power)
  const withBattery = data.filter(d => d.percent !== null);

  if (withBattery.length === 0) {
    canvas.style.display = 'none';
    nodata.style.display = 'block';
    return;
  }

  // Show canvas, hide nodata message
  canvas.style.display = 'block';
  nodata.style.display = 'none';

  const ctx = canvas.getContext('2d');

  withBattery.sort((a, b) => a.timestamp - b.timestamp);

  const labels = withBattery.map(d => new Date(d.timestamp * 1000));
  const percentValues = withBattery.map(d => d.percent);

  // Li-Po discharge curve: voltage â†’ percent
  const lipoCurve = [
    { v: 4.20, p: 100 }, { v: 4.00, p: 80 }, { v: 3.85, p: 60 },
    { v: 3.75, p: 40 }, { v: 3.65, p: 15 }, { v: 3.55, p: 7 },
    { v: 3.45, p: 4 }, { v: 3.35, p: 2 }, { v: 3.00, p: 0 }
  ];

  function voltageToPercent(voltage) {
    if (voltage >= 4.20) return 100;
    if (voltage <= 3.00) return 0;
    for (let i = 0; i < lipoCurve.length - 1; i++) {
      if (voltage <= lipoCurve[i].v && voltage > lipoCurve[i + 1].v) {
        const v1 = lipoCurve[i].v, p1 = lipoCurve[i].p;
        const v2 = lipoCurve[i + 1].v, p2 = lipoCurve[i + 1].p;
        return p1 + (p2 - p1) * (voltage - v1) / (v2 - v1);
      }
    }
    return 0;
  }

  // Convert voltage to equivalent % (for same Y scale)
  const voltageAsPercent = withBattery.map(d => voltageToPercent(d.voltage));

  // Chart type settings
  const isScatter = chartType === 'scatter';

  batteryChart = new Chart(ctx, {
    type: isScatter ? 'scatter' : 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Battery %',
          data: isScatter ? withBattery.map(d => ({ x: new Date(d.timestamp * 1000), y: d.percent })) : percentValues,
          borderColor: '#4caf50',
          backgroundColor: isScatter ? '#4caf50' : 'rgba(76, 175, 80, 0.1)',
          fill: !isScatter,
          tension: isScatter ? 0 : 0.3,
          pointRadius: isScatter ? 4 : 2,
          showLine: !isScatter
        },
        {
          label: 'Voltage V',
          data: isScatter ? withBattery.map((d, i) => ({ x: new Date(d.timestamp * 1000), y: voltageAsPercent[i] })) : voltageAsPercent,
          borderColor: '#ff9800',
          borderDash: isScatter ? [] : [5, 5],
          fill: false,
          tension: isScatter ? 0 : 0.3,
          pointRadius: isScatter ? 3 : 1,
          showLine: !isScatter,
          voltageData: withBattery.map(d => d.voltage)
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            title: (items) => new Date(items[0].parsed.x).toLocaleString(),
            label: (ctx) => {
              if (ctx.datasetIndex === 0) {
                return `Battery: ${ctx.parsed.y.toFixed(1)}%`;
              } else {
                const voltage = ctx.dataset.voltageData[ctx.dataIndex];
                return `Voltage: ${voltage.toFixed(2)}V`;
              }
            }
          }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: {
            unit: currentPeriod === 1 ? 'hour' : 'day',
            displayFormats: { hour: 'HH:mm', day: 'MMM d' }
          },
          grid: { display: false }
        },
        y: {
          type: 'linear',
          position: 'left',
          min: 0,
          max: 100,
          ticks: { callback: v => v + '%' }
        },
        y1: {
          type: 'linear',
          position: 'right',
          min: 0,
          max: 100,
          grid: { drawOnChartArea: false },
          afterBuildTicks: (axis) => {
            // Voltages at correct % positions (Li-Po curve)
            axis.ticks = [
              { value: 100, label: '4.2V' },
              { value: 90, label: '4.1V' },
              { value: 80, label: '4.0V' },
              { value: 67, label: '3.9V' },
              { value: 50, label: '3.8V' },
              { value: 28, label: '3.7V' },
              { value: 11, label: '3.6V' },
              { value: 2, label: '3.3V' },
              { value: 0, label: '3.0V' }
            ];
          },
          ticks: { callback: (v, i, ticks) => ticks[i]?.label || '' }
        }
      }
    }
  });
}

// Render watering summary and list
function renderWateringSummary(events) {
  const nodata = document.getElementById('watering-nodata');
  const summary = document.getElementById('watering-summary');

  // Filter to start events only (they have duration/volume info)
  const startEvents = events.filter(e => e.message && e.message.toLowerCase().includes('start'));

  if (startEvents.length === 0) {
    nodata.style.display = 'block';
    summary.style.display = 'none';
    return;
  }

  nodata.style.display = 'none';
  summary.style.display = 'grid';

  // Calculate totals
  let totalMl = 0;
  let totalSec = 0;

  for (const e of startEvents) {
    const volMatch = e.message.match(/(\d+)\s*ml/i);
    const secMatch = e.message.match(/(\d+)\s*s[,\)]/i);
    if (volMatch) totalMl += parseInt(volMatch[1]);
    if (secMatch) totalSec += parseInt(secMatch[1]);
  }

  document.getElementById('watering-count').textContent = startEvents.length;
  document.getElementById('watering-total-ml').textContent = totalMl > 0 ? totalMl + 'ml' : 'â€”';
  document.getElementById('watering-total-sec').textContent = totalSec > 0 ? totalSec + 's' : 'â€”';
}

// Render watering list with clear info
function renderWateringList(events) {
  const container = document.getElementById('watering-list');

  // Filter to start events (they have the key info)
  const startEvents = events.filter(e => e.message && e.message.toLowerCase().includes('start'));

  if (startEvents.length === 0) {
    container.innerHTML = '';
    return;
  }

  // Sort by timestamp DESC (newest first)
  startEvents.sort((a, b) => b.timestamp - a.timestamp);

  let html = '';
  for (const e of startEvents) {
    const date = new Date(e.timestamp * 1000);
    const timeStr = date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    const dateStr = date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });

    // Parse duration and volume from message
    const msg = e.message || '';
    const secMatch = msg.match(/(\d+)\s*s[,\)]/i);
    const volMatch = msg.match(/(\d+)\s*ml/i);
    const duration = secMatch ? secMatch[1] + 's' : 'â€”';
    const volume = volMatch ? volMatch[1] + 'ml' : 'â€”';

    // Determine type
    const msgLower = msg.toLowerCase();
    let type = 'Normal';
    let typeColor = '#4caf50';
    let icon = 'ğŸ’§';
    if (msgLower.includes('microprime')) { type = 'Microprime'; typeColor = '#2196f3'; icon = 'ğŸ’¦'; }
    else if (msgLower.includes('manual')) { type = 'Manual'; typeColor = '#ff9800'; icon = 'âœ‹'; }

    html += `<div class="event-row event-pump" style="border-left-color:${typeColor}">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-size:18px">${icon}</span>
        <div>
          <div style="font-weight:500">${type}</div>
          <div class="muted" style="font-size:12px">${duration} Â· ${volume}</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:500">${timeStr}</div>
        <div class="muted" style="font-size:12px">${dateStr}</div>
      </div>
    </div>`;
  }
  container.innerHTML = html;
}

// Render activity list
function renderActivityList(events) {
  const container = document.getElementById('activity-list');

  if (events.length === 0) {
    container.innerHTML = '<div class="muted">No activity in this period</div>';
    return;
  }

  let html = '';
  // Limit to 50 most recent
  const recent = events.slice(0, 50);

  for (const e of recent) {
    const time = new Date(e.timestamp * 1000).toLocaleString();
    const typeClass = e.type === 'PUMP' ? 'event-pump' :
                      e.type === 'SENSOR' ? 'event-sensor' :
                      e.type === 'BATTERY' ? 'event-battery' : 'event-system';
    html += `<div class="event-row ${typeClass}">
      <div>${e.message || e.type}</div>
      <div class="muted">${time}</div>
    </div>`;
  }
  container.innerHTML = html;
}

// Update summary stats
function updateStats() {
  const cutoff = Date.now() / 1000 - (currentPeriod * 24 * 60 * 60);

  // Watering count and volume from activity
  const pumpEvents = activityData.filter(a => a.type === 'PUMP' && a.timestamp > cutoff && a.message.includes('started'));
  document.getElementById('stat-waterings').textContent = pumpEvents.length;

  // Estimate volume (parse from message or count * avg)
  let totalVolume = 0;
  for (const e of pumpEvents) {
    const match = e.message.match(/(\d+)ml/);
    if (match) totalVolume += parseInt(match[1]);
  }
  document.getElementById('stat-volume').textContent = totalVolume > 0 ? totalVolume : 'â€”';

  // Average moisture
  const moistureFiltered = sensorData.filter(d => d.timestamp > cutoff && d.moisture_percent != null);
  if (moistureFiltered.length > 0) {
    const avg = moistureFiltered.reduce((sum, d) => sum + d.moisture_percent, 0) / moistureFiltered.length;
    document.getElementById('stat-avg-moisture').textContent = Math.round(avg) + '%';
  } else {
    document.getElementById('stat-avg-moisture').textContent = 'â€”';
  }

  // Min battery
  const batteryFiltered = batteryData.filter(d => d.timestamp > cutoff && d.percent != null);
  if (batteryFiltered.length > 0) {
    const min = Math.min(...batteryFiltered.map(d => d.percent));
    document.getElementById('stat-min-battery').textContent = Math.round(min) + '%';
  } else {
    document.getElementById('stat-min-battery').textContent = 'â€”';
  }
}

// Export CSV
function exportCSV() {
  let csv = 'timestamp,type,moisture_cap_pct,moisture_res_pct,adc_capacitive,adc_resistive,battery_percent,battery_voltage,charging,boot_type,reset_reason,message\n';

  // Add sensor data
  for (const d of sensorData) {
    const time = new Date(d.timestamp * 1000).toISOString();
    csv += `${time},sensor,${d.moisture_percent || ''},${d.sensor2_percent || ''},${d.adc_raw || ''},${d.sensor2_adc || ''},,,,,,""\n`;
  }

  // Add battery data
  for (const d of batteryData) {
    const time = new Date(d.timestamp * 1000).toISOString();
    csv += `${time},battery,,,,,${d.percent || ''},${d.voltage || ''},${d.charging || ''},,,\n`;
  }

  // Add activity (includes boot events with boot_type and reset_reason)
  for (const a of activityData) {
    const time = new Date(a.timestamp * 1000).toISOString();
    const msg = (a.message || '').replace(/,/g, ';').replace(/\n/g, ' ');
    const bootType = a.boot_type || '';
    const resetReason = a.reset_reason || '';
    csv += `${time},${a.type},,,,,,,,${bootType},${resetReason},"${msg}"\n`;
  }

  // Download with standardized filename: DeviceID_date_type-period.csv
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const date = new Date().toISOString().split('T')[0];
  const periodLabel = currentPeriod === 1 ? '24h' : currentPeriod + 'd';
  a.download = `${DEVICE_ID}_${date}_trends-${periodLabel}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// Refresh all data
async function refreshAll() {
  // Load pump data first (needed for chart annotations)
  await loadPumpHistory();

  // Then load all other data in parallel
  await Promise.all([
    loadSensorHistory(),
    loadBatteryHistory(),
    loadActivity()
  ]);
}

// Admin nav link - moved to common.js

// ============ LONG-TERM DATA (from GitHub JSON) ============
let longTermData = []; // Weekly summaries from GitHub

// Load weekly summaries from GitHub
async function loadLongTermData() {
  const loading = document.getElementById('longterm-loading');
  const error = document.getElementById('longterm-error');

  loading.style.display = 'block';
  error.style.display = 'none';

  try {
    // Extract short device ID (BB00C1) from DEVICE_ID (Polivalka-BB00C1 or BB00C1)
    const shortId = DEVICE_ID.replace('Polivalka-', '');
    const url = `data/weekly/${shortId}.json`;

    const response = await fetch(url, { cache: 'no-store' });
    if (!response.ok) {
      if (response.status === 404) {
        loading.style.display = 'none';
        longTermData = [];
        renderAllLtCharts([]);
        renderHistoryList([]);
        return;
      }
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    longTermData = data.summaries || [];

    loading.style.display = 'none';

    // Filter and render based on selected period
    const filtered = filterLongTermData(longTermPeriod);
    renderAllLtCharts(filtered);
    renderHistoryList(longTermData); // History shows all data

  } catch(e) {
    loading.style.display = 'none';
    error.style.display = 'block';
    error.textContent = 'Failed to load long-term data: ' + e.message;
    console.error('Long-term data error:', e);
  }
}

// Current long-term period (weeks)
let longTermPeriod = 26; // 6 months by default

// Filter data by period
function filterLongTermData(weeks) {
  if (longTermData.length === 0) return [];

  // Sort by week descending
  const sorted = [...longTermData].sort((a, b) => b.week.localeCompare(a.week));

  // Take last N weeks
  return sorted.slice(0, weeks).reverse();
}

// Set long-term period
function setLongTermPeriod(weeks) {
  longTermPeriod = weeks;
  // Find period-selector inside long-term card (not the short-term one)
  const ltCard = document.querySelector('.card[style*="border-top:3px"]');
  if (ltCard) {
    ltCard.querySelectorAll('.period-selector button').forEach(b => b.classList.remove('active'));
  }
  const btn = document.getElementById('btn-lt-' + weeks + 'w');
  if (btn) btn.classList.add('active');

  const labels = { 4: '1 month', 26: '6 months', 52: '1 year', 104: '2 years', 156: '3 years' };
  document.getElementById('longterm-period-label').textContent = labels[weeks] || weeks + ' weeks';

  const filtered = filterLongTermData(weeks);
  renderAllLtCharts(filtered);
}

// Long-term chart instances
let ltMoistureChart = null;
let ltSensor2Chart = null;
let ltBatteryChart = null;
let ltWateringChart = null;

// Long-term tab switching
function showLtTab(name) {
  // Hide all long-term tabs
  document.querySelectorAll('.lt-tab-content').forEach(t => t.style.display = 'none');
  // Remove active from all buttons
  document.querySelectorAll('#lt-tab-buttons button').forEach(b => b.classList.remove('active'));
  // Show selected tab
  document.getElementById('lt-tab-' + name).style.display = 'block';
  // Mark button as active
  event.target.classList.add('active');
}

// Render long-term moisture chart
function renderLtMoistureChart(data) {
  const canvas = document.getElementById('lt-moisture-chart');
  const nodata = document.getElementById('lt-moisture-nodata');

  if (ltMoistureChart) { ltMoistureChart.destroy(); ltMoistureChart = null; }

  const hasData = data.some(d => d.moisture?.avg_percent != null);
  if (!hasData) {
    canvas.style.display = 'none';
    nodata.style.display = 'block';
    return;
  }

  canvas.style.display = 'block';
  nodata.style.display = 'none';

  const labels = data.map(d => d.week);
  const avgValues = data.map(d => d.moisture?.avg_percent || null);
  const minValues = data.map(d => d.moisture?.min_percent || null);
  const maxValues = data.map(d => d.moisture?.max_percent || null);

  ltMoistureChart = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'Avg %', data: avgValues, borderColor: '#1976d2', backgroundColor: 'rgba(25,118,210,0.1)', fill: true, tension: 0.3 },
        { label: 'Min %', data: minValues, borderColor: '#90caf9', borderDash: [3,3], fill: false, tension: 0.3, pointRadius: 2 },
        { label: 'Max %', data: maxValues, borderColor: '#1565c0', borderDash: [3,3], fill: false, tension: 0.3, pointRadius: 2 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'top' } },
      scales: { x: { grid: { display: false } }, y: { min: 0, max: 100, ticks: { callback: v => v + '%' } } }
    }
  });
}

// Render long-term sensor2 (J7) chart
function renderLtSensor2Chart(data) {
  const canvas = document.getElementById('lt-sensor2-chart');
  const section = document.getElementById('lt-sensor2-section');

  if (ltSensor2Chart) { ltSensor2Chart.destroy(); ltSensor2Chart = null; }

  const hasData = data.some(d => d.sensor2?.avg_percent != null);
  if (!hasData) {
    section.style.display = 'none';
    return;
  }

  section.style.display = 'block';

  const labels = data.map(d => d.week);
  const avgValues = data.map(d => d.sensor2?.avg_percent || null);
  const minValues = data.map(d => d.sensor2?.min_percent || null);
  const maxValues = data.map(d => d.sensor2?.max_percent || null);

  ltSensor2Chart = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'Avg %', data: avgValues, borderColor: '#9c27b0', backgroundColor: 'rgba(156,39,176,0.1)', fill: true, tension: 0.3 },
        { label: 'Min %', data: minValues, borderColor: '#ce93d8', borderDash: [3,3], fill: false, tension: 0.3, pointRadius: 2 },
        { label: 'Max %', data: maxValues, borderColor: '#7b1fa2', borderDash: [3,3], fill: false, tension: 0.3, pointRadius: 2 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'top' } },
      scales: { x: { grid: { display: false } }, y: { min: 0, max: 100, ticks: { callback: v => v + '%' } } }
    }
  });
}

// Render long-term battery chart
function renderLtBatteryChart(data) {
  const canvas = document.getElementById('lt-battery-chart');
  const nodata = document.getElementById('lt-battery-nodata');

  if (ltBatteryChart) { ltBatteryChart.destroy(); ltBatteryChart = null; }

  const hasData = data.some(d => d.battery?.avg_percent != null);
  if (!hasData) {
    canvas.style.display = 'none';
    nodata.style.display = 'block';
    return;
  }

  canvas.style.display = 'block';
  nodata.style.display = 'none';

  const labels = data.map(d => d.week);
  const avgValues = data.map(d => d.battery?.avg_percent || null);
  const minValues = data.map(d => d.battery?.min_percent || null);

  ltBatteryChart = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'Avg %', data: avgValues, borderColor: '#4caf50', backgroundColor: 'rgba(76,175,80,0.1)', fill: true, tension: 0.3 },
        { label: 'Min %', data: minValues, borderColor: '#81c784', borderDash: [3,3], fill: false, tension: 0.3, pointRadius: 2 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'top' } },
      scales: { x: { grid: { display: false } }, y: { min: 0, max: 100, ticks: { callback: v => v + '%' } } }
    }
  });
}

// Render long-term watering chart
function renderLtWateringChart(data) {
  const canvas = document.getElementById('lt-watering-chart');
  const nodata = document.getElementById('lt-watering-nodata');

  if (ltWateringChart) { ltWateringChart.destroy(); ltWateringChart = null; }

  const hasData = data.some(d => (d.watering?.events_count || 0) > 0);
  if (!hasData) {
    canvas.style.display = 'none';
    nodata.style.display = 'block';
    return;
  }

  canvas.style.display = 'block';
  nodata.style.display = 'none';

  const labels = data.map(d => d.week);
  const countValues = data.map(d => d.watering?.events_count || 0);
  const mlValues = data.map(d => d.watering?.total_ml || 0);

  ltWateringChart = new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: 'Waterings', data: countValues, backgroundColor: 'rgba(33,150,243,0.7)', borderColor: '#2196f3', borderWidth: 1, yAxisID: 'y' },
        { label: 'Volume ml', data: mlValues, type: 'line', borderColor: '#ff9800', fill: false, tension: 0.3, yAxisID: 'y1' }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'top' } },
      scales: {
        x: { grid: { display: false } },
        y: { type: 'linear', position: 'left', min: 0, title: { display: true, text: 'Count' } },
        y1: { type: 'linear', position: 'right', min: 0, grid: { drawOnChartArea: false }, ticks: { callback: v => v + 'ml' } }
      }
    }
  });
}

// Render all long-term charts
function renderAllLtCharts(data) {
  renderLtMoistureChart(data);
  renderLtSensor2Chart(data);
  renderLtBatteryChart(data);
  renderLtWateringChart(data);
}

// Render history list
function renderHistoryList(data) {
  const container = document.getElementById('history-list');

  if (data.length === 0) {
    container.innerHTML = '<div class="muted">No historical data available yet</div>';
    return;
  }

  // Sort by week descending (newest first)
  const sorted = [...data].sort((a, b) => b.week.localeCompare(a.week));

  let html = '';
  for (const w of sorted) {
    const moisture = w.moisture?.avg_percent != null ? Math.round(w.moisture.avg_percent) + '%' : 'â€”';
    const battery = w.battery?.avg_percent != null ? Math.round(w.battery.avg_percent) + '%' : 'â€”';
    const waterings = w.watering?.events_count ?? 0;
    const volume = w.watering?.total_ml ?? 0;
    const online = w.system?.online_hours != null ? Math.round(w.system.online_hours) + 'h' : 'â€”';

    html += `<div class="event-row event-system" style="flex-direction:column;align-items:stretch">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Week ${w.week}</strong>
        <span class="muted">${w.start_date} â€” ${w.end_date}</span>
      </div>
      <div style="display:flex;gap:16px;margin-top:8px;font-size:13px;color:#666">
        <span>ğŸ’§ Moisture: ${moisture}</span>
        <span>ğŸ”‹ Battery: ${battery}</span>
        <span>ğŸš¿ ${waterings} waterings (${volume}ml)</span>
        <span>ğŸ“¡ Online: ${online}</span>
      </div>
    </div>`;
  }

  container.innerHTML = html;
}

// Export long-term data as CSV
function exportLongTermCSV() {
  if (longTermData.length === 0) {
    alert('No long-term data to export');
    return;
  }

  let csv = 'week,start_date,end_date,moisture_avg,moisture_min,moisture_max,battery_avg,battery_min,battery_max,waterings,total_ml,auto_events,manual_events,online_hours,offline_hours,restarts,firmware\n';

  for (const w of longTermData) {
    csv += `${w.week},${w.start_date},${w.end_date},`;
    csv += `${w.moisture?.avg_percent || ''},${w.moisture?.min_percent || ''},${w.moisture?.max_percent || ''},`;
    csv += `${w.battery?.avg_percent || ''},${w.battery?.min_percent || ''},${w.battery?.max_percent || ''},`;
    csv += `${w.watering?.events_count || 0},${w.watering?.total_ml || 0},${w.watering?.auto_events || 0},${w.watering?.manual_events || 0},`;
    csv += `${w.system?.online_hours || ''},${w.system?.offline_hours || ''},${w.system?.restarts || 0},${w.system?.firmware_version || ''}\n`;
  }

  // Download with standardized filename: DeviceID_date_type-period.csv
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const date = new Date().toISOString().split('T')[0];
  const periodLabels = { 4: '1mo', 26: '6mo', 52: '1y', 104: '2y', 156: '3y' };
  const periodLabel = periodLabels[longTermPeriod] || longTermPeriod + 'w';
  a.download = `${DEVICE_ID}_${date}_longterm-${periodLabel}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// Init
if (IS_CLOUD && DEVICE_ID) {
  document.getElementById('device-id-header').textContent = 'ğŸŒ± ' + DEVICE_ID;
  document.title = `${DEVICE_ID} â€” Trends`;

  // Load data (time handled by common.js universal clock)
  refreshAll();
  updateHeader();
  updateBattery();
  loadLongTermData(); // Load weekly summaries from GitHub

  // Auto-refresh every 5 minutes
  setInterval(refreshAll, 300000);
  setInterval(updateHeader, 30000);
  setInterval(updateBattery, 60000);
  setInterval(loadLongTermData, 3600000); // Refresh long-term data every hour
} else {
  // AP mode - show message
  document.querySelector('.container').innerHTML = `
    <div class="card">
      <h3>ğŸ“Š Trends</h3>
      <p class="muted">Historical trends are only available in Cloud mode.</p>
      <p>Connect your device to WiFi and access via <a href="https://gt3max.github.io/polivalka-web/trends.html?device=${location.hostname.includes('polivalka') ? location.hostname.split('.')[0].replace('polivalka-','').toUpperCase() : 'YOUR_DEVICE'}">Cloud Dashboard</a></p>
    </div>
  `;
}
</script>
</body></html>
