<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"><title>PlantApp ‚Äî Admin</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<script src="api-adapter.js"></script>
<style>
    body{font-family:system-ui,Arial;margin:0;padding:0;max-width:100%;background:#1a1a2e}
    .header{position:sticky;top:0;z-index:1000;background:#b00;color:#fff;padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .header h1{margin:0;font-size:18px}
    .header-info{font-size:12px;text-align:right;line-height:1.3}
    .container{padding:18px;max-width:760px;margin:0 auto}
    .card{border:1px solid #333;padding:16px;border-radius:12px;margin:12px 0;background:#252540}
    .card h3{color:#fff;margin-top:0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .mono{font-family:ui-monospace,monospace}
    button{padding:8px 12px;border-radius:8px;border:1px solid #888;background:#fafafa;cursor:pointer}
    button.primary{background:#2c5f2d;color:#fff;border-color:#2c5f2d}
    button.danger{background:#b00;color:#fff;border-color:#900}
    .muted{color:#999;font-size:14px}
    .danger{color:#f44}
    .ok{color:#4f4}
    .warning-banner{background:#ff9800;color:#000;padding:12px;text-align:center;font-weight:600}
    .info-banner{background:#2196f3;color:#fff;padding:12px;text-align:center;font-size:13px}

    /* Status indicator */
    .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
    .status-dot.online{background:#4caf50}
    .status-dot.offline{background:#f44}

    /* Device selector */
    select{padding:8px 12px;border:1px solid #555;border-radius:8px;background:#1a1a2e;color:#fff;font-size:14px;width:100%;max-width:300px}

    /* Info table */
    .info-table{width:100%;border-collapse:collapse}
    .info-table td{padding:8px 0;border-bottom:1px solid #333;color:#fff}
    .info-table td:first-child{color:#999;width:40%}
    .info-table tr:last-child td{border-bottom:none}
</style>
</head><body>
<div class="warning-banner">ADMIN PANEL ‚Äî NOT FOR USERS</div>
<div class="info-banner">This page is READ-ONLY. Device configuration is done via AP web interface (192.168.4.1)</div>
<div class="header">
<div style="display:flex;align-items:center;gap:12px">
  <a id="back-link" href="fleet.html" style="color:#fff;text-decoration:none;font-size:14px">‚Üê Fleet</a>
  <div><h1 style="margin:0">üîß Admin Panel</h1><div style="font-size:11px;opacity:0.8">Device Information</div></div>
</div>
<div class="header-info"><div class="mono" style="font-size:11px"><span class="status-dot" id="aws-status-dot"></span><span id="aws-status">Checking...</span></div></div>
</div>

<div class="container">

<!-- Device Selector -->
<div class="card">
<h3>üì± Select Device</h3>
<select id="device-select" onchange="loadDeviceInfo()">
<option value="">‚Äî Select device ‚Äî</option>
</select>
</div>

<!-- Device Info (read-only) -->
<div id="device-info-card" class="card" style="display:none">
<h3>üìä Device Information</h3>
<table class="info-table">
<tr><td>Device ID</td><td id="info-device-id" class="mono">‚Äî</td></tr>
<tr><td>Custom Name</td><td id="info-name">‚Äî</td></tr>
<tr><td>Status</td><td id="info-status">‚Äî</td></tr>
<tr><td>Firmware</td><td id="info-firmware" class="mono">‚Äî</td></tr>
<tr><td>Reboot Count</td><td id="info-reboots" class="mono">‚Äî</td></tr>
<tr><td>Mode</td><td id="info-mode">‚Äî</td></tr>
<tr><td>Controller State</td><td id="info-state">‚Äî</td></tr>
<tr><td>Moisture</td><td id="info-moisture">‚Äî</td></tr>
<tr><td>Battery</td><td id="info-battery">‚Äî</td></tr>
<tr><td>Last Update</td><td id="info-last-update">‚Äî</td></tr>
<tr><td>Owner</td><td id="info-owner">‚Äî</td></tr>
</table>
<div class="row" style="margin-top:16px">
<button onclick="refreshDevice()">üîÑ Refresh</button>
<button onclick="viewDevicePage()">üè† Open Device Page</button>
</div>
</div>

<!-- Telemetry Info -->
<div id="telemetry-card" class="card" style="display:none">
<h3>üìà Telemetry Intervals (firmware defaults)</h3>
<p class="muted">These are compiled into firmware. To change, update app_main.c and reflash.</p>
<table class="info-table">
<tr><td>Sensor Telemetry</td><td class="mono">60 min</td></tr>
<tr><td>Battery Telemetry</td><td class="mono">60 min</td></tr>
<tr><td>System Heartbeat</td><td class="mono">30 min</td></tr>
</table>
</div>

<!-- Quick Actions -->
<div class="card">
<h3>üöÄ Quick Actions</h3>
<div class="row">
<button onclick="window.location.href='fleet.html'">üìã Fleet View</button>
<button onclick="window.location.href='ota.html'">üì¶ OTA Update</button>
</div>
</div>

</div>

<script>
let selectedDevice = null;

// Admin email whitelist
const ADMIN_EMAILS = ['mrmaximshurigin@gmail.com', 'admin@plantapp.pro'];

// Check admin access
function checkAdminAccess() {
  const userEmail = localStorage.getItem('user_email');
  if (!userEmail) {
    window.location.href = 'login.html';
    return false;
  }
  if (!ADMIN_EMAILS.includes(userEmail.toLowerCase())) {
    document.body.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#1a1a2e">
        <div style="text-align:center;color:#fff">
          <h1 style="color:#f44">‚õî Access Denied</h1>
          <p>This page is for administrators only.</p>
          <a href="fleet.html" style="color:#4caf50">‚Üê Back to Fleet</a>
        </div>
      </div>
    `;
    return false;
  }
  return true;
}

// Load device list
async function loadDevices() {
  try {
    const url = `${API.cloudBase}/devices`;
    const res = await fetch(url, {
      headers: API.getAuthHeaders(),
      cache: 'no-store'
    });
    if (!res.ok) throw new Error((await res.json().catch(() => ({}))).error || res.status);
    const devices = await res.json();

    const select = document.getElementById('device-select');
    select.innerHTML = '<option value="">‚Äî Select device ‚Äî</option>';

    if (!devices || devices.length === 0) {
      document.getElementById('aws-status').textContent = 'No devices found';
      document.getElementById('aws-status-dot').className = 'status-dot offline';
      return;
    }

    for (const d of devices) {
      const opt = document.createElement('option');
      opt.value = d.device_id;
      const shortId = d.device_id.replace('Polivalka-', '');
      const customName = (d.name && d.name !== d.device_id && d.name !== 'Polivalka') ? ` "${d.name}"` : '';
      opt.textContent = shortId + customName + (d.online ? ' (online)' : ' (offline)');
      select.appendChild(opt);
    }

    document.getElementById('aws-status').textContent = 'Connected (' + devices.length + ' devices)';
    document.getElementById('aws-status-dot').className = 'status-dot online';
  } catch(e) {
    document.getElementById('aws-status').textContent = 'Error: ' + e.message;
    document.getElementById('aws-status-dot').className = 'status-dot offline';
  }
}

// Load device info
async function loadDeviceInfo() {
  const deviceId = document.getElementById('device-select').value;
  if (!deviceId) {
    document.getElementById('device-info-card').style.display = 'none';
    document.getElementById('telemetry-card').style.display = 'none';
    return;
  }

  try {
    // Get device from /devices list
    const url = `${API.cloudBase}/devices`;
    const res = await fetch(url, { headers: API.getAuthHeaders() });
    const devices = await res.json();
    selectedDevice = devices.find(d => d.device_id === deviceId);

    if (!selectedDevice) {
      alert('Device not found');
      return;
    }

    // Fill info
    document.getElementById('info-device-id').textContent = selectedDevice.device_id;
    document.getElementById('info-name').textContent = selectedDevice.name || '‚Äî';
    document.getElementById('info-status').innerHTML = selectedDevice.online ?
      '<span style="color:#4f4">‚óè Online</span>' : '<span style="color:#f44">‚óã Offline</span>';
    document.getElementById('info-firmware').textContent = selectedDevice.firmware_version || '‚Äî';
    document.getElementById('info-reboots').textContent = selectedDevice.reboot_count ?? '‚Äî';
    document.getElementById('info-mode').textContent = selectedDevice.mode || '‚Äî';
    document.getElementById('info-state').textContent = selectedDevice.state || '‚Äî';
    document.getElementById('info-moisture').textContent = selectedDevice.moisture_pct !== null ?
      selectedDevice.moisture_pct + '%' : '‚Äî';

    // Battery
    if (selectedDevice.battery_pct !== null) {
      const charging = selectedDevice.battery_charging ? ' ‚ö°' : '';
      document.getElementById('info-battery').textContent = selectedDevice.battery_pct + '%' + charging;
    } else {
      document.getElementById('info-battery').textContent = '‚ö° AC Power';
    }

    // Last update
    if (selectedDevice.last_update) {
      const ts = selectedDevice.last_update < 10000000000 ? selectedDevice.last_update * 1000 : selectedDevice.last_update;
      document.getElementById('info-last-update').textContent = new Date(ts).toLocaleString();
    } else {
      document.getElementById('info-last-update').textContent = '‚Äî';
    }

    document.getElementById('info-owner').textContent = selectedDevice.owner_email || '‚Äî';

    document.getElementById('device-info-card').style.display = 'block';
    document.getElementById('telemetry-card').style.display = 'block';

  } catch(e) {
    alert('Error loading device: ' + e.message);
  }
}

// Refresh device via MQTT
async function refreshDevice() {
  if (!selectedDevice) return;

  try {
    const res = await fetch(`${API.cloudBase}/device/${selectedDevice.device_id}/sensor`, {
      headers: API.getAuthHeaders()
    });

    if (res.ok) {
      alert('‚úì Device refreshed');
      loadDeviceInfo();
    } else {
      const err = await res.json().catch(() => ({}));
      alert('Failed: ' + (err.error || err.hint || res.status));
    }
  } catch(e) {
    alert('Error: ' + e.message);
  }
}

// Open device page
function viewDevicePage() {
  if (!selectedDevice) return;
  window.location.href = `home.html?device=${selectedDevice.device_id}`;
}

// Get device from URL if present
const urlDeviceId = new URLSearchParams(window.location.search).get('device');

// Update back link
if (urlDeviceId) {
  const backLink = document.getElementById('back-link');
  backLink.href = `home.html?device=${urlDeviceId}`;
  backLink.textContent = '‚Üê Device';
}

// Init
if (checkAdminAccess()) {
  loadDevices().then(() => {
    if (urlDeviceId) {
      const select = document.getElementById('device-select');
      select.value = urlDeviceId;
      if (select.value === urlDeviceId) {
        loadDeviceInfo();
      }
    }
  });
}
</script>
</body></html>
