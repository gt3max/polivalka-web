<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"><title>PlantApp ‚Äî Admin</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<script src="api-adapter.js"></script>
<script src="common.js"></script>
<style>
    body{font-family:system-ui,Arial;margin:0;padding:0;max-width:100%;background:#1a1a2e}
    .header{position:sticky;top:0;z-index:1000;background:#b00;color:#fff;padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .header h1{margin:0;font-size:18px}
    .header-info{font-size:12px;text-align:right;line-height:1.3}
    .container{padding:18px;max-width:760px;margin:0 auto}
    .card{border:1px solid #333;padding:16px;border-radius:12px;margin:12px 0;background:#252540}
    .card h3{color:#fff;margin-top:0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .mono{font-family:ui-monospace,monospace}
    button{padding:8px 12px;border-radius:8px;border:1px solid #888;background:#fafafa;cursor:pointer}
    button.primary{background:#2c5f2d;color:#fff;border-color:#2c5f2d}
    button.danger{background:#b00;color:#fff;border-color:#900}
    input[type="number"]{padding:8px 10px;border:1px solid #555;border-radius:8px;background:#1a1a2e;color:#fff;width:80px;font-size:16px}
    .muted{color:#999;font-size:14px}
    .danger{color:#f44}
    .ok{color:#4f4}
    .warning-banner{background:#ff9800;color:#000;padding:12px;text-align:center;font-weight:600}

    /* Toggle switch */
    .toggle-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #333}
    .toggle-row:last-child{border-bottom:none}
    .toggle-label{color:#fff}
    .toggle-desc{color:#999;font-size:12px;margin-top:2px}
    .toggle-switch{position:relative;display:inline-block;width:51px;height:31px;flex-shrink:0}
    .toggle-switch input{opacity:0;width:0;height:0}
    .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#555;border-radius:31px;transition:0.3s}
    .toggle-slider:before{position:absolute;content:"";height:27px;width:27px;left:2px;bottom:2px;background:#fff;border-radius:50%;transition:0.3s}
    input:checked+.toggle-slider{background:#4caf50}
    input:checked+.toggle-slider:before{transform:translateX(20px)}

    /* Section headers */
    .section-header{color:#ff9800;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #333}

    /* Status indicator */
    .status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px}
    .status-dot.online{background:#4caf50}
    .status-dot.offline{background:#f44}

    /* Device selector */
    select{padding:8px 12px;border:1px solid #555;border-radius:8px;background:#1a1a2e;color:#fff;font-size:14px;width:100%;max-width:300px}

    /* Info list (read-only) */
    .info-list{margin-top:12px}
    .info-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #333}
    .info-row:last-child{border-bottom:none}
    .info-label{color:#ccc}
    .info-value{color:#4caf50;font-family:ui-monospace,monospace}
</style>
</head><body>
<div class="warning-banner">ADMIN PANEL ‚Äî NOT FOR USERS</div>
<div class="header">
<div style="display:flex;align-items:center;gap:12px">
  <a id="back-link" href="fleet.html" style="color:#fff;text-decoration:none;font-size:14px">‚Üê Fleet</a>
  <div><h1 style="margin:0">üîß Admin Panel</h1><div style="font-size:11px;opacity:0.8">AWS IoT Configuration</div></div>
</div>
<div class="header-info"><div class="mono" style="font-size:11px"><span class="status-dot" id="aws-status-dot"></span><span id="aws-status">Checking...</span></div></div>
</div>

<div class="container">

<!-- Device Selector -->
<div class="card">
<h3>üì± Select Device</h3>
<select id="device-select" onchange="loadDeviceConfig()">
<option value="">‚Äî Select device ‚Äî</option>
</select>
<div id="device-info" style="margin-top:12px;display:none">
<div class="muted">Device ID: <span id="selected-device-id" class="mono">‚Äî</span></div>
<div class="muted">Last seen: <span id="selected-device-lastseen" class="mono">‚Äî</span></div>
</div>
</div>

<!-- Periodic Telemetry (Info only - hardcoded in firmware) -->
<div class="card">
<h3>üìä Periodic Telemetry</h3>
<p class="muted">Intervals are hardcoded in firmware (app_main.c). To change, reflash device.</p>
<div class="info-list">
<div class="info-row"><span class="info-label">Sensor Telemetry</span><span class="info-value">60 min</span></div>
<div class="info-row"><span class="info-label">Battery Telemetry</span><span class="info-value">60 min</span></div>
<div class="info-row"><span class="info-label">System Heartbeat</span><span class="info-value">30 min</span></div>
</div>
</div>

<!-- Event Telemetry (Info only) -->
<div class="card">
<h3>‚ö° Event Telemetry</h3>
<p class="muted">Events published to AWS IoT when triggered (not configurable).</p>
<div class="info-list">
<div class="info-row"><span class="info-label">Pump Events</span><span class="info-value">On start/stop</span></div>
<div class="info-row"><span class="info-label">Config Changes</span><span class="info-value">On save</span></div>
<div class="info-row"><span class="info-label">Command Responses</span><span class="info-value">On command</span></div>
</div>
</div>

<!-- Factory Presets -->
<div class="card">
<h3>üìã Factory Presets</h3>
<p class="muted">Default values for uncalibrated devices. User's physical calibration (Calibration page) takes priority.</p>

<div class="section-header">Pump Preset</div>
<div class="toggle-row">
<div><div class="toggle-label">Default Flow Rate</div><div class="toggle-desc">Used if pump not calibrated <span class="mono">(ml_per_sec)</span></div></div>
<div class="row"><input type="number" id="calib-pump-mlsec" min="0.1" max="50" step="0.1" value="2.5" style="width:80px"><span class="muted">ml/sec</span></div>
</div>
<div class="row" style="margin-top:8px">
<button onclick="savePumpPreset()">Set Pump Preset</button>
</div>

<div class="section-header" style="margin-top:20px">Sensor Preset (ADC values)</div>
<div class="toggle-row">
<div><div class="toggle-label">ADC Water</div><div class="toggle-desc">Default 100% moisture <span class="mono">(adc_water)</span></div></div>
<div class="row"><input type="number" id="calib-adc-water" min="0" max="4095" value="1200" style="width:80px"></div>
</div>
<div class="toggle-row">
<div><div class="toggle-label">ADC Dry Soil</div><div class="toggle-desc">Default 0% moisture <span class="mono">(adc_dry_soil)</span></div></div>
<div class="row"><input type="number" id="calib-adc-dry" min="0" max="4095" value="2800" style="width:80px"></div>
</div>
<div class="toggle-row">
<div><div class="toggle-label">ADC Air</div><div class="toggle-desc">Default air reference <span class="mono">(adc_air)</span></div></div>
<div class="row"><input type="number" id="calib-adc-air" min="0" max="4095" value="3200" style="width:80px"></div>
</div>
<div class="row" style="margin-top:8px">
<button onclick="saveSensorPreset()">Set Sensor Preset</button>
</div>
</div>

<!-- WiFi Settings -->
<div class="card">
<h3>üì∂ WiFi Settings</h3>
<p class="muted">WiFi reconnect behavior when connection is lost.</p>

<div class="section-header">Phase 2: Periodic Scan</div>
<div class="toggle-row">
<div><div class="toggle-label">Scan Interval</div><div class="toggle-desc">How often to scan for saved WiFi when disconnected <span class="mono">(wifi_scan_interval_hours)</span></div></div>
<div class="row"><input type="number" id="wifi-scan-interval" min="1" max="168" value="24" style="width:80px"><span class="muted">hours</span></div>
</div>
<div class="row" style="margin-top:8px">
<button onclick="saveWifiSettings()">Set WiFi Settings</button>
</div>
<div class="muted" style="margin-top:12px;font-size:12px">
üí° Phase 1 (immediate): 5 reconnect attempts √ó 30 sec<br>
üí° Phase 2 (long-term): Scan every N hours until WiFi returns
</div>
</div>


<!-- Costs Estimate -->
<div class="card">
<h3>üí∞ AWS Cost Estimate</h3>
<p class="muted">Based on current settings</p>
<div id="cost-estimate" style="color:#fff;font-size:14px">
<div>Messages/month: <span id="est-messages" class="mono ok">‚Äî</span></div>
<div>Within Free Tier: <span id="est-free-tier" class="mono">‚Äî</span></div>
<div>Estimated cost: <span id="est-cost" class="mono">‚Äî</span></div>
</div>
</div>

<!-- Archived Devices -->
<div class="card">
<h3>üóÑÔ∏è Archived Devices</h3>
<p class="muted">Hidden from Fleet but still receiving data if online</p>
<div id="archived-list" style="margin-top:12px">
<div class="muted">Loading...</div>
</div>
</div>

<!-- Deleted Devices -->
<div class="card">
<h3>üóëÔ∏è Deleted Devices</h3>
<p class="muted">Certificate deactivated, cannot connect to cloud</p>
<div id="deleted-list" style="margin-top:12px">
<div class="muted">Loading...</div>
</div>
</div>

<!-- Danger Zone -->
<div class="card" style="border-color:#b00;background:#2a1a1a">
<h3 style="color:#f44">‚ö†Ô∏è DANGER ZONE</h3>
<p class="muted">Actions below affect the selected device. Use with caution.</p>

<div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap">
<button class="danger" onclick="archiveDevice()" id="btn-archive" disabled style="opacity:0.5">
üóÑÔ∏è Archive Device
</button>
<button class="danger" onclick="deleteDevice()" id="btn-delete" disabled style="opacity:0.5">
üóëÔ∏è Delete Device
</button>
</div>
<p class="muted" style="margin-top:12px;font-size:11px">
<b>Archive:</b> Hides from Fleet, device keeps working.<br>
<b>Delete:</b> Deactivates certificate, device cannot connect to cloud.
</p>
</div>

</div>

<script>
let selectedDeviceId = null;

// Load device list - call /devices directly (no device prefix!)
async function loadDevices() {
  console.log('[Admin] Loading devices...');
  try {
    // Call API directly without device prefix (admin needs ALL devices, not device-specific)
    const url = `${API.cloudBase}/devices`;
    const res = await fetch(url, {
      headers: API.getAuthHeaders(),
      cache: 'no-store'
    });
    if (!res.ok) throw new Error((await res.json().catch(() => ({}))).error || res.status);
    const devices = await res.json();
    console.log('[Admin] Got devices:', devices);
    const select = document.getElementById('device-select');
    select.innerHTML = '<option value="">‚Äî Select device ‚Äî</option>';

    if (!devices || devices.length === 0) {
      document.getElementById('aws-status').textContent = 'No devices found';
      document.getElementById('aws-status-dot').className = 'status-dot offline';
      return;
    }

    for (const d of devices) {
      const opt = document.createElement('option');
      opt.value = d.device_id;
      // Admin needs device_id, show custom name in parentheses if different
      const shortId = d.device_id.replace('Polivalka-', '');
      const customName = (d.name && d.name !== d.device_id && d.name !== 'Polivalka') ? ` "${d.name}"` : '';
      opt.textContent = shortId + customName + (d.online ? ' (online)' : ' (offline)');
      select.appendChild(opt);
    }

    // Check AWS connection
    document.getElementById('aws-status').textContent = 'Connected (' + devices.length + ' devices)';
    document.getElementById('aws-status-dot').className = 'status-dot online';
  } catch(e) {
    console.error('[Admin] Failed to load devices:', e);
    document.getElementById('aws-status').textContent = 'Error: ' + e.message;
    document.getElementById('aws-status-dot').className = 'status-dot offline';
  }
}

// Load config for selected device
async function loadDeviceConfig() {
  const deviceId = document.getElementById('device-select').value;
  if (!deviceId) {
    document.getElementById('device-info').style.display = 'none';
    updateDangerButtons(false);
    return;
  }

  selectedDeviceId = deviceId;
  document.getElementById('selected-device-id').textContent = deviceId;
  updateDangerButtons(true);  // Enable Archive/Delete buttons
  document.getElementById('device-info').style.display = 'block';
  document.getElementById('selected-device-lastseen').textContent = 'Loading...';

  // Fetch current device data to populate fields
  try {
    const res = await fetch(`${API.cloudBase}/devices`, {
      headers: API.getAuthHeaders(),
      cache: 'no-store'
    });
    if (res.ok) {
      const devices = await res.json();
      const device = devices.find(d => d.device_id === deviceId);
      if (device) {
        // Populate pump calibration (from DynamoDB)
        const pumpCalib = device.pump_calibration || 2.5;
        document.getElementById('calib-pump-mlsec').value = pumpCalib;
        console.log('[Admin] Loaded pump_calibration:', pumpCalib);

        // Populate sensor calibration (from DynamoDB)
        const sensorCalib = device.sensor_calibration || {};
        document.getElementById('calib-adc-water').value = sensorCalib.water || 1200;
        document.getElementById('calib-adc-dry').value = sensorCalib.dry_soil || 2400;
        document.getElementById('calib-adc-air').value = sensorCalib.air || 2800;
        console.log('[Admin] Loaded sensor_calibration:', sensorCalib);

        // Show last seen info
        if (device.last_update) {
          const lastSeen = new Date(device.last_update * 1000);
          document.getElementById('selected-device-lastseen').textContent = 'Last update: ' + lastSeen.toLocaleString();
        } else {
          document.getElementById('selected-device-lastseen').textContent = 'Ready for preset changes';
        }

        // Load WiFi scan interval from device data (from system telemetry)
        const wifiScanInterval = device.wifi_scan_interval_hours || device.system?.wifi_scan_interval_hours;
        if (wifiScanInterval) {
          document.getElementById('wifi-scan-interval').value = wifiScanInterval;
          console.log('[Admin] Loaded wifi_scan_interval:', wifiScanInterval);
        }
      }
    }
  } catch(e) {
    console.warn('[Admin] Failed to load device data:', e);
    document.getElementById('selected-device-lastseen').textContent = 'Ready for preset changes';
  }

  updateCostEstimate();
}

// Save pump preset (factory default)
async function savePumpPreset() {
  const selectedDeviceId = document.getElementById('device-select').value;
  if (!selectedDeviceId) {
    alert('Please select a device first');
    return;
  }

  const mlPerSec = parseFloat(document.getElementById('calib-pump-mlsec').value);
  if (isNaN(mlPerSec) || mlPerSec < 0.1 || mlPerSec > 50) {
    alert('ml/sec must be between 0.1 and 50');
    return;
  }

  try {
    const res = await fetch(`${API.cloudBase}/device/${selectedDeviceId}/command`, {
      method: 'POST',
      headers: { ...API.getAuthHeaders(), 'Content-Type': 'application/json' },
      body: JSON.stringify({
        command: 'set_pump_preset',
        params: { ml_per_sec: mlPerSec }
      })
    });

    if (res.ok) {
      alert(`‚úì Pump preset set to ${mlPerSec} ml/sec`);
    } else {
      const err = await res.json().catch(() => ({}));
      alert('Failed: ' + (err.error || res.status));
    }
  } catch(e) {
    alert('Error: ' + e.message);
  }
}

// Save sensor preset (factory defaults)
async function saveSensorPreset() {
  const selectedDeviceId = document.getElementById('device-select').value;
  if (!selectedDeviceId) {
    alert('Please select a device first');
    return;
  }

  const adcWater = parseInt(document.getElementById('calib-adc-water').value);
  const adcDry = parseInt(document.getElementById('calib-adc-dry').value);
  const adcAir = parseInt(document.getElementById('calib-adc-air').value);

  if ([adcWater, adcDry, adcAir].some(v => isNaN(v) || v < 0 || v > 4095)) {
    alert('ADC values must be between 0 and 4095');
    return;
  }

  try {
    const res = await fetch(`${API.cloudBase}/device/${selectedDeviceId}/command`, {
      method: 'POST',
      headers: { ...API.getAuthHeaders(), 'Content-Type': 'application/json' },
      body: JSON.stringify({
        command: 'set_sensor_preset',
        params: { adc_water: adcWater, adc_dry_soil: adcDry, adc_air: adcAir }
      })
    });

    if (res.ok) {
      alert(`‚úì Sensor preset saved: water=${adcWater}, dry=${adcDry}, air=${adcAir}`);
    } else {
      const err = await res.json().catch(() => ({}));
      alert('Failed: ' + (err.error || res.status));
    }
  } catch(e) {
    alert('Error: ' + e.message);
  }
}

// WiFi settings
async function saveWifiSettings() {
  if (!selectedDeviceId) {
    alert('Select a device first');
    return;
  }

  const scanInterval = parseInt(document.getElementById('wifi-scan-interval').value);

  if (isNaN(scanInterval) || scanInterval < 1 || scanInterval > 168) {
    alert('Scan interval must be between 1 and 168 hours');
    return;
  }

  try {
    const res = await fetch(`${API.cloudBase}/device/${selectedDeviceId}/command`, {
      method: 'POST',
      headers: { ...API.getAuthHeaders(), 'Content-Type': 'application/json' },
      body: JSON.stringify({
        command: 'set_wifi_config',
        params: { wifi_scan_interval_hours: scanInterval }
      })
    });

    if (res.ok) {
      alert(`‚úì WiFi settings saved: scan every ${scanInterval} hours`);
    } else {
      const err = await res.json().catch(() => ({}));
      alert('Failed: ' + (err.error || res.status));
    }
  } catch(e) {
    alert('Error: ' + e.message);
  }
}


// Cost estimate (using hardcoded firmware intervals)
function updateCostEstimate() {
  // Hardcoded in firmware: sensor=60min, battery=60min, system=30min
  const sensorMin = 60;
  const batteryMin = 60;
  const systemMin = 30;

  // Messages per month (30 days)
  const msgsPerDay = (1440/sensorMin) + (1440/batteryMin) + (1440/systemMin);
  const msgsPerMonth = Math.round(msgsPerDay * 30);

  // Free tier: 250,000 messages/month (first 12 months), then 0
  // Cost: $1 per million messages after free tier
  const freeTierLimit = 250000;
  const withinFreeTier = msgsPerMonth < freeTierLimit;
  const cost = withinFreeTier ? 0 : ((msgsPerMonth - freeTierLimit) / 1000000).toFixed(4);

  document.getElementById('est-messages').textContent = msgsPerMonth.toLocaleString();
  document.getElementById('est-free-tier').textContent = withinFreeTier ? '‚úì Yes' : '‚úó No';
  document.getElementById('est-free-tier').className = 'mono ' + (withinFreeTier ? 'ok' : 'danger');
  document.getElementById('est-cost').textContent = '$' + cost + '/month';
  document.getElementById('est-cost').className = 'mono ' + (cost == 0 ? 'ok' : 'danger');
}

// Admin email whitelist - uses ADMIN_EMAILS from common.js

// ============ Device Management Functions ============

// Load archived devices list
async function loadArchivedDevices() {
  const container = document.getElementById('archived-list');
  try {
    const res = await fetch(`${API.cloudBase}/admin/devices/archived`, {
      headers: API.getAuthHeaders()
    });
    if (!res.ok) throw new Error('Failed to load');
    const devices = await res.json();

    if (devices.length === 0) {
      container.innerHTML = '<div class="muted">No archived devices</div>';
      return;
    }

    container.innerHTML = devices.map(d => {
      const shortId = d.device_id.replace('Polivalka-', '');
      const date = d.archived_at ? new Date(d.archived_at * 1000).toLocaleDateString() : '‚Äî';
      return `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #333">
          <div>
            <span class="mono" style="color:#ff9800">${shortId}</span>
            <span class="muted" style="margin-left:8px">${d.name !== d.device_id ? d.name : ''}</span>
            <div class="muted" style="font-size:11px">Archived: ${date}</div>
          </div>
          <button onclick="restoreArchived('${d.device_id}')" style="font-size:12px;padding:4px 8px">Restore</button>
        </div>
      `;
    }).join('');
  } catch(e) {
    container.innerHTML = '<div class="danger">Error loading archived devices</div>';
  }
}

// Load deleted devices list
async function loadDeletedDevices() {
  const container = document.getElementById('deleted-list');
  try {
    const res = await fetch(`${API.cloudBase}/admin/devices/deleted`, {
      headers: API.getAuthHeaders()
    });
    if (!res.ok) throw new Error('Failed to load');
    const devices = await res.json();

    if (devices.length === 0) {
      container.innerHTML = '<div class="muted">No deleted devices</div>';
      return;
    }

    container.innerHTML = devices.map(d => {
      const shortId = d.device_id.replace('Polivalka-', '');
      const date = d.deleted_at ? new Date(d.deleted_at * 1000).toLocaleDateString() : '‚Äî';
      return `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #333">
          <div>
            <span class="mono" style="color:#f44">${shortId}</span>
            <span class="muted" style="margin-left:8px">${d.name !== d.device_id ? d.name : ''}</span>
            <div class="muted" style="font-size:11px">Deleted: ${date}</div>
          </div>
          <button onclick="restoreDeleted('${d.device_id}')" style="font-size:12px;padding:4px 8px">Restore</button>
        </div>
      `;
    }).join('');
  } catch(e) {
    container.innerHTML = '<div class="danger">Error loading deleted devices</div>';
  }
}

// Archive selected device
async function archiveDevice() {
  if (!selectedDeviceId) {
    alert('Select a device first');
    return;
  }

  const shortId = selectedDeviceId.replace('Polivalka-', '');
  if (!confirm(`Archive device ${shortId}?\n\nIt will be hidden from Fleet but continue to work and send data.`)) {
    return;
  }

  try {
    const res = await fetch(`${API.cloudBase}/admin/device/${selectedDeviceId}/archive`, {
      method: 'POST',
      headers: API.getAuthHeaders()
    });
    const data = await res.json();

    if (res.ok) {
      alert(`‚úì Device ${shortId} archived`);
      loadDevices();  // Refresh device list
      loadArchivedDevices();  // Refresh archived list
      document.getElementById('device-select').value = '';
      document.getElementById('device-info').style.display = 'none';
      updateDangerButtons(false);
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  } catch(e) {
    alert('Error: ' + e.message);
  }
}

// Hard delete selected device
async function deleteDevice() {
  if (!selectedDeviceId) {
    alert('Select a device first');
    return;
  }

  const shortId = selectedDeviceId.replace('Polivalka-', '');

  // Double confirmation with ID input
  const confirmId = prompt(`‚ö†Ô∏è DELETE DEVICE\n\nThis will deactivate the certificate and the device will no longer be able to connect to the cloud.\n\nTo confirm, type the device ID: ${shortId}`);

  if (confirmId !== shortId) {
    if (confirmId !== null) alert('Device ID does not match. Deletion cancelled.');
    return;
  }

  try {
    const res = await fetch(`${API.cloudBase}/admin/device/${selectedDeviceId}/delete`, {
      method: 'POST',
      headers: API.getAuthHeaders()
    });
    const data = await res.json();

    if (res.ok) {
      alert(`‚úì Device ${shortId} deleted\n\nCertificate deactivated.`);
      loadDevices();
      loadDeletedDevices();
      document.getElementById('device-select').value = '';
      document.getElementById('device-info').style.display = 'none';
      updateDangerButtons(false);
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  } catch(e) {
    alert('Error: ' + e.message);
  }
}

// Restore device from archive
async function restoreArchived(deviceId) {
  const shortId = deviceId.replace('Polivalka-', '');
  if (!confirm(`Restore ${shortId} from archive?`)) return;

  try {
    const res = await fetch(`${API.cloudBase}/admin/device/${deviceId}/restore-archive`, {
      method: 'POST',
      headers: API.getAuthHeaders()
    });
    const data = await res.json();

    if (res.ok) {
      alert(`‚úì Device ${shortId} restored`);
      loadDevices();
      loadArchivedDevices();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  } catch(e) {
    alert('Error: ' + e.message);
  }
}

// Restore deleted device (reactivate certificate)
async function restoreDeleted(deviceId) {
  const shortId = deviceId.replace('Polivalka-', '');
  if (!confirm(`Restore ${shortId}?\n\nThis will reactivate the certificate and the device will be able to connect again.`)) return;

  try {
    const res = await fetch(`${API.cloudBase}/admin/device/${deviceId}/restore`, {
      method: 'POST',
      headers: API.getAuthHeaders()
    });
    const data = await res.json();

    if (res.ok) {
      alert(`‚úì Device ${shortId} restored\n\nCertificate reactivated.`);
      loadDevices();
      loadDeletedDevices();
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  } catch(e) {
    alert('Error: ' + e.message);
  }
}

// Enable/disable danger zone buttons
function updateDangerButtons(enabled) {
  const archiveBtn = document.getElementById('btn-archive');
  const deleteBtn = document.getElementById('btn-delete');
  archiveBtn.disabled = !enabled;
  deleteBtn.disabled = !enabled;
  archiveBtn.style.opacity = enabled ? '1' : '0.5';
  deleteBtn.style.opacity = enabled ? '1' : '0.5';
}

// Check admin access
function checkAdminAccess() {
  const userEmail = localStorage.getItem('user_email');
  if (!userEmail) {
    // Not logged in
    window.location.href = 'login.html';
    return false;
  }
  if (!isAdmin()) {
    // Not admin - show access denied
    document.body.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#1a1a2e">
        <div style="text-align:center;color:#fff">
          <h1 style="color:#f44">‚õî Access Denied</h1>
          <p>This page is for administrators only.</p>
          <a href="fleet.html" style="color:#4caf50">‚Üê Back to Fleet</a>
        </div>
      </div>
    `;
    return false;
  }
  return true;
}

// Get device from URL if present
const urlDeviceId = new URLSearchParams(window.location.search).get('device');

// Update back link - if came from device page, go back there
if (urlDeviceId) {
  const backLink = document.getElementById('back-link');
  backLink.href = `home.html?device=${urlDeviceId}`;
  backLink.textContent = '‚Üê Device';
}

// Init
if (checkAdminAccess()) {
  loadDevices().then(() => {
    // Auto-select device if came from device page
    if (urlDeviceId) {
      const select = document.getElementById('device-select');
      select.value = urlDeviceId;
      if (select.value === urlDeviceId) {
        loadDeviceConfig();  // Load config for pre-selected device
      }
    }
  });
  loadArchivedDevices();
  loadDeletedDevices();
  updateCostEstimate();
}
</script>
</body></html>
