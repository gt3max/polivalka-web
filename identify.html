<!doctype html>
<html>
<head>
<script src="api-adapter.js"></script>
<script src="common.js"></script>
<meta charset="utf-8"/>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Plant Identification</title>
<style>
  body{font-family:system-ui,Arial;margin:0;padding:0;max-width:100%;background:#fafafa}
  .header{position:sticky;top:0;z-index:1000;background:#2c5f2d;color:#fff;padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .header-info{font-size:12px;text-align:right;line-height:1.3}
  .nav{position:sticky;top:65px;z-index:999;background:#f0f0f0;padding:5px 8px;display:flex;gap:2px;border-bottom:1px solid #ddd;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch}
  .nav a{text-decoration:none;color:#333;padding:6px 8px;border-radius:6px;font-size:14px;flex-shrink:0}
  .nav a.active{background:#2c5f2d;color:#fff}
  .nav a:hover{background:#ddd}
  .container{padding:18px;max-width:600px;margin:0 auto}
  .card{border:1px solid #ddd;padding:16px;border-radius:12px;margin:12px 0;background:#fff}
  button{padding:10px 16px;border-radius:8px;border:1px solid #888;background:#fafafa;cursor:pointer;font-size:14px}
  button.primary{background:#2c5f2d;color:#fff;border-color:#2c5f2d}
  button.secondary{background:#f5f5f5;border-color:#ccc}
  button:hover{opacity:0.9}
  button:disabled{opacity:0.5;cursor:not-allowed}
  .muted{color:#666;font-size:14px}

  /* Upload Section */
  .upload-area{border:2px dashed #ccc;border-radius:12px;padding:40px 20px;text-align:center;cursor:pointer;transition:all 0.3s}
  .upload-area:hover{border-color:#2c5f2d;background:#f0f8f0}
  .upload-area.dragover{border-color:#2c5f2d;background:#e8f5e9}
  .upload-icon{font-size:48px;margin-bottom:12px}
  .upload-text{color:#666;margin-bottom:8px}
  .upload-hint{font-size:12px;color:#999}
  .upload-buttons{display:flex;gap:12px;justify-content:center;margin-top:16px}

  /* Preview */
  .preview-area{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0}
  .preview-item{position:relative;width:80px;height:80px;border-radius:8px;overflow:hidden}
  .preview-item img{width:100%;height:100%;object-fit:cover}
  .preview-item .remove-btn{position:absolute;top:2px;right:2px;background:#fff;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;border:none;box-shadow:0 1px 3px rgba(0,0,0,0.2)}

  /* Results */
  .results-section{display:none}
  .result-item{border:1px solid #ddd;border-radius:10px;padding:12px;margin:10px 0;cursor:pointer;transition:all 0.2s}
  .result-item:hover{border-color:#2c5f2d;background:#f9fff9}
  .result-item.selected{border-color:#2c5f2d;background:#e8f5e9;border-width:2px}
  .result-header{display:flex;gap:12px;align-items:start}
  .result-radio{margin-top:4px}
  .result-info{flex:1}
  .result-name{font-weight:600;color:#2c5f2d;font-size:16px}
  .result-common{font-size:13px;color:#666}
  .result-score{font-size:12px;color:#999;margin-top:4px}
  .result-images{display:flex;gap:4px;margin-top:8px;overflow-x:auto}
  .result-images img{width:60px;height:60px;border-radius:6px;object-fit:cover}

  /* Plant Card */
  .plant-card{display:none}
  .plant-card.visible{display:block}
  .plant-card-header{display:flex;gap:16px;align-items:start;margin-bottom:16px}
  .plant-card-photo{width:100px;height:100px;border-radius:12px;object-fit:cover;background:#f0f0f0}
  .plant-card-info{flex:1}
  .plant-card-name{font-size:20px;font-weight:600;color:#2c5f2d}
  .plant-card-scientific{font-size:14px;color:#666;font-style:italic}
  .plant-card-names{font-size:12px;color:#999;margin-top:4px}
  .care-section{margin:16px 0}
  .care-section h4{margin:0 0 8px 0;font-size:14px;color:#666}
  .care-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .care-item{background:#f5f5f5;padding:10px;border-radius:8px;font-size:13px}
  .care-label{font-size:11px;color:#999;display:block}
  .care-value{font-weight:600;color:#333}
  .tips-list{margin:0;padding-left:20px;font-size:13px;color:#666}
  .tips-list li{margin:4px 0}

  /* Actions */
  .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:20px}
  .actions button{flex:1;min-width:140px}


  /* Loading */
  .loading{text-align:center;padding:40px}
  .spinner{width:40px;height:40px;border:3px solid #f0f0f0;border-top-color:#2c5f2d;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Error */
  .error-message{background:#ffebee;border:1px solid #ffcdd2;color:#c62828;padding:12px;border-radius:8px;margin:16px 0;font-size:14px}

  /* Manual search */
  .manual-search{margin-top:20px;padding-top:16px;border-top:1px solid #eee}
  .manual-search input{width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:8px;font-size:14px;margin-bottom:12px;box-sizing:border-box}

  /* Catalog fallback */
  .catalog-section{display:none}
  .category-tabs{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:16px}
  .category-tab{padding:8px 16px;border:1px solid #ddd;border-radius:20px;background:#fff;cursor:pointer;font-size:13px}
  .category-tab.active{background:#2c5f2d;color:#fff;border-color:#2c5f2d}
  .plant-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
  .plant-list-item{border:1px solid #ddd;border-radius:10px;padding:10px;text-align:center;cursor:pointer;transition:all 0.2s}
  .plant-list-item:hover{border-color:#2c5f2d;background:#f9fff9}
  .plant-list-item img{width:60px;height:60px;border-radius:8px;object-fit:cover;margin-bottom:6px}
  .plant-list-item .name{font-size:13px;font-weight:500}

  /* Navigation */
  .nav-back{display:inline-flex;align-items:center;gap:6px;color:#666;text-decoration:none;font-size:14px;margin-bottom:16px}
  .nav-back:hover{color:#2c5f2d}

  /* Mock mode banner */
  .mock-banner{background:#fff3cd;border:1px solid #ffc107;color:#856404;padding:10px 16px;border-radius:8px;margin-bottom:16px;font-size:13px}

  /* Status badge */
  .status-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:13px;font-weight:600}
  .status-timer{background:#e3f2fd;color:#1976d2}
  .status-sensor{background:#fff3e0;color:#f57c00}
  .status-off{background:#fce4ec;color:#c2185b}
  .status-manual{background:#e0e0e0;color:#616161}
  .status-active{background:#e0f7fa;color:#00838f}
  .mono{font-family:ui-monospace,monospace}
</style>
</head>
<body>
<div class="header">
  <div>
    <h1 id="device-id-header" style="margin:0;font-size:15px">üå± Polivalka</h1>
    <div style="font-size:13px">üìç <span id="location-text">‚Äî</span> / <span id="room-text">‚Äî</span><span id="custom-name-suffix"></span></div>
    <div style="font-size:11px;margin-top:4px"><span id="battery-status">üîã ‚Äî</span> ¬∑ <span id="header-state">üí§ Standby</span></div>
  </div>
  <div class="header-info">
    <div id="header-time" class="mono" style="font-size:11px">--:--</div>
    <div style="font-size:11px" id="header-mode"><span id="mode-badge" class="status-badge">‚Äî</span></div>
    <div style="font-size:11px" id="header-conn">üì° <span id="conn-text" style="transition:color 0.3s">...</span></div>
  </div>
</div>
<div class="nav">
  <a href="fleet.html">Fleet</a>
  <a href="home.html">Home</a>
  <a href="identify.html" class="active" style="background:#e8f5e9">üå± Plant</a>
  <a href="timer.html">Timer</a>
  <a href="sensor.html">Sensor</a>
  <a href="settings.html">Settings</a>
  <a href="calibration.html">Calibration</a>
  <a href="online.html">Online</a>
  <a href="trends.html">Trends</a>
  <a href="ota.html">Update</a>
  <a href="admin.html" id="admin-nav-link" style="display:none">Admin</a>
</div>

<div class="container">
  <!-- API Status Banner (hidden when working) -->
  <div class="mock-banner" id="mock-banner" style="display:none">
    <strong>Demo Mode:</strong> API not available. Using sample data.
  </div>

  <!-- Device Plant Status (always visible) -->
  <div id="device-status" class="card" style="border-left:4px solid #ccc">
    <div id="status-empty" style="display:flex;align-items:center;gap:12px">
      <div style="font-size:28px;opacity:0.4">ü™¥</div>
      <div style="flex:1">
        <div style="font-weight:600;font-size:15px;color:#999">No plant attached</div>
        <div style="font-size:12px;color:#aaa">Take a photo to identify, or pick from library</div>
      </div>
      <button class="primary" onclick="document.getElementById('step-upload').scrollIntoView({behavior:'smooth'})" style="font-size:13px;padding:6px 14px;white-space:nowrap">üì∑ Identify</button>
    </div>
    <div id="status-attached" style="display:none;align-items:center;gap:8px">
      <span style="font-size:22px">üåø</span>
      <span id="status-plant-name" style="font-weight:600;font-size:15px"></span>
      <span id="status-archived-badge" style="display:none;background:#ff9800;color:#fff;font-size:10px;padding:1px 6px;border-radius:4px">Archived</span>
      <span id="status-since" style="font-size:12px;color:#666;margin-left:auto"></span>
    </div>
  </div>

  <!-- Current Plant details (shown if profile exists) -->
  <div id="step-current" class="card" style="display:none">
    <h2 style="margin-top:0">üåø Current Plant <span id="archived-badge" style="display:none;font-size:12px;background:#ff9800;color:#fff;padding:2px 8px;border-radius:10px;margin-left:8px">Archived</span></h2>
    <div style="display:flex;gap:16px;align-items:flex-start">
      <img id="current-plant-img" src="" alt="" style="width:80px;height:80px;border-radius:12px;object-fit:cover">
      <div style="flex:1">
        <div id="current-plant-name" style="font-weight:600;font-size:16px"></div>
        <div id="current-plant-scientific" style="color:#666;font-size:13px;font-style:italic"></div>
        <div id="current-plant-preset" style="color:#2c5f2d;font-size:12px;margin-top:4px"></div>
      </div>
    </div>
    <div id="plant-actions" style="display:flex;gap:8px;margin-top:16px">
      <button id="btn-archive" class="secondary" onclick="archivePlant()" style="flex:1;font-size:13px">üì¶ Archive</button>
      <button id="btn-unarchive" class="secondary" onclick="unarchivePlant()" style="flex:1;font-size:13px;display:none">üì§ Restore</button>
      <button class="secondary" onclick="deletePlant()" style="flex:1;font-size:13px;color:#c62828;border-color:#c62828">üóëÔ∏è Delete</button>
    </div>
  </div>

  <!-- Plant Library (all user's plants across devices) -->
  <div id="plant-library" class="card" style="display:none">
    <h2 style="margin-top:0;cursor:pointer" onclick="toggleLibrary()">
      üìö My Plants <span id="library-count" style="font-size:14px;color:#666">(0)</span>
      <span id="library-toggle" style="float:right;font-size:14px">‚ñº</span>
    </h2>
    <div id="library-content" style="display:none">
      <p class="muted" style="margin:0 0 12px">Select a plant to assign to this device:</p>
      <div id="library-list" style="display:grid;gap:8px"></div>
      <div id="library-empty" style="display:none;color:#999;font-size:14px;text-align:center;padding:16px">
        No plants in library yet. Identify your first plant above!
      </div>
    </div>
  </div>

  <!-- Step 1: Upload -->
  <div id="step-upload" class="card">
    <h2 style="margin-top:0">Identify Your Plant</h2>

    <div class="upload-area" id="upload-area">
      <div class="upload-icon">üì∑</div>
      <div class="upload-text">Drag & drop a photo or click to upload</div>
      <div class="upload-hint">Supports JPG, PNG, HEIC, WebP (max 20MB)</div>
      <div class="upload-buttons">
        <button type="button" class="primary" onclick="document.getElementById('file-input').click()">
          üìÅ Choose File
        </button>
        <button type="button" class="secondary" id="camera-btn" onclick="openCamera()">
          üì∑ Take Photo
        </button>
      </div>
    </div>

    <input type="file" id="file-input" accept="image/jpeg,image/png,image/heic,image/heif,image/webp,image/*" style="display:none" multiple>
    <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none">

    <p class="muted" style="font-size:11px;margin:8px 0 0;text-align:center">
      JPG, PNG, HEIC, WebP ‚Ä¢ Max 20MB
    </p>

    <div class="preview-area" id="preview-area"></div>

    <div id="gdpr-section" style="display:none;margin:16px 0;padding:10px 12px;background:#e3f2fd;border-radius:8px;font-size:12px;color:#1565c0">
      ‚ÑπÔ∏è Photo will be sent to PlantNet.org for identification
    </div>

    <button class="primary" id="identify-btn" onclick="identifyPlant()" disabled style="width:100%;margin-top:16px">
      Identify Plant
    </button>
  </div>

  <!-- Loading -->
  <div id="loading" class="card loading" style="display:none">
    <div class="spinner"></div>
    <div id="loading-text">Analyzing your plant...</div>
  </div>

  <!-- Error -->
  <div id="error" class="error-message" style="display:none"></div>

  <!-- Step 2: Results -->
  <div id="step-results" class="card results-section">
    <a href="#" class="nav-back" onclick="goBack();return false">‚Üê Back</a>
    <h2 style="margin-top:0">Similar Plants</h2>
    <p class="muted">Select the plant that matches yours:</p>

    <div id="results-list"></div>

  </div>

  <!-- Step 3: Plant Card -->
  <div id="step-card" class="card plant-card">
    <a href="#" class="nav-back" onclick="goBackToResults();return false">‚Üê Back to results</a>

    <div class="plant-card-header">
      <img class="plant-card-photo" id="card-photo" src="" alt="">
      <div class="plant-card-info">
        <div class="plant-card-name" id="card-name">-</div>
        <div class="plant-card-scientific" id="card-scientific">-</div>
        <div class="plant-card-names" id="card-names">-</div>
      </div>
    </div>

    <!-- Safety Warning (CRITICAL - show first!) -->
    <div id="safety-section" class="care-section" style="display:none">
      <h4 style="color:#c62828">Safety Warning</h4>
      <div class="care-grid">
        <div class="care-item" id="toxic-humans-item" style="display:none;background:#ffebee">
          <span class="care-label">Humans</span>
          <span class="care-value" id="toxic-humans" style="color:#c62828">-</span>
        </div>
        <div class="care-item" id="toxic-pets-item" style="display:none;background:#ffebee">
          <span class="care-label">Pets</span>
          <span class="care-value" id="toxic-pets" style="color:#c62828">-</span>
        </div>
      </div>
    </div>

    <!-- Plant Info -->
    <div id="info-section" class="care-section" style="display:none">
      <h4>Plant Info</h4>
      <div class="care-grid">
        <div class="care-item" id="size-item" style="display:none">
          <span class="care-label">Mature Size</span>
          <span class="care-value" id="plant-size">-</span>
        </div>
        <div class="care-item" id="growth-item" style="display:none">
          <span class="care-label">Growth Rate</span>
          <span class="care-value" id="growth-rate">-</span>
        </div>
        <div class="care-item" id="cycle-item" style="display:none">
          <span class="care-label">Life Cycle</span>
          <span class="care-value" id="life-cycle">-</span>
        </div>
        <div class="care-item" id="difficulty-item" style="display:none">
          <span class="care-label">Difficulty</span>
          <span class="care-value" id="care-difficulty">-</span>
        </div>
        <div class="care-item" id="hardiness-item" style="display:none">
          <span class="care-label">Hardiness Zone</span>
          <span class="care-value" id="hardiness-zone">-</span>
        </div>
        <div class="care-item" id="indoor-item" style="display:none">
          <span class="care-label">Indoor</span>
          <span class="care-value" id="indoor-suitable">-</span>
        </div>
      </div>
    </div>

    <div class="care-section">
      <h4>Care Recommendations</h4>
      <div class="care-grid">
        <div class="care-item">
          <span class="care-label">Watering</span>
          <span class="care-value" id="care-watering">-</span>
        </div>
        <div class="care-item">
          <span class="care-label">Soil Moisture</span>
          <span class="care-value" id="care-moisture">-</span>
        </div>
        <div class="care-item">
          <span class="care-label">Light</span>
          <span class="care-value" id="care-light">-</span>
        </div>
        <div class="care-item">
          <span class="care-label">Air Temperature</span>
          <span class="care-value" id="care-temp">-</span>
        </div>
        <div class="care-item">
          <span class="care-label">Air Humidity</span>
          <span class="care-value" id="care-humidity">-</span>
        </div>
      </div>
    </div>

    <!-- Propagation & Maintenance -->
    <div id="propagation-section" class="care-section" style="display:none">
      <h4>Propagation & Maintenance</h4>
      <div class="care-grid">
        <div class="care-item" id="propagation-item" style="display:none">
          <span class="care-label">Propagation</span>
          <span class="care-value" id="propagation-methods">-</span>
        </div>
        <div class="care-item" id="pruning-item" style="display:none">
          <span class="care-label">Pruning</span>
          <span class="care-value" id="pruning-months">-</span>
        </div>
        <div class="care-item" id="soil-item" style="display:none">
          <span class="care-label">Soil</span>
          <span class="care-value" id="soil-type">-</span>
        </div>
        <div class="care-item" id="pests-item" style="display:none">
          <span class="care-label">Pests</span>
          <span class="care-value" id="pest-info">-</span>
        </div>
      </div>
    </div>

    <div class="care-section">
      <h4>Tips</h4>
      <ul class="tips-list" id="care-tips"></ul>
    </div>

    <div class="actions" id="plant-actions">
      <button class="primary" onclick="confirmPlant()" style="width:100%;padding:14px;font-size:16px">
        ‚úì Use This Plant
      </button>
    </div>
    <div id="no-device-promo" style="display:none">
      <div style="background:#f1f8e9;border:1px solid #c5e1a5;border-radius:12px;padding:16px;text-align:center">
        <div style="font-size:32px;margin-bottom:8px">üåø</div>
        <div style="font-weight:600;font-size:15px;margin-bottom:6px">Get a Polivalka device</div>
        <div style="font-size:13px;color:#555;margin-bottom:12px">Save plant profiles, automate watering, and track soil moisture ‚Äî all from your phone.</div>
        <a href="fleet.html" style="text-decoration:none"><button class="primary" style="padding:12px 24px;font-size:14px">Go to My Devices</button></a>
      </div>
    </div>
  </div>

  <!-- Catalog Fallback -->
  <div id="step-catalog" class="card catalog-section">
    <a href="#" class="nav-back" onclick="goBack();return false">‚Üê Back</a>
    <h2 style="margin-top:0">Browse Plant Catalog</h2>

    <div class="category-tabs" id="category-tabs"></div>
    <div class="plant-list" id="plant-list"></div>
  </div>
</div>

<script>
// ============ Configuration ============
const CONFIG = {
  // API is now proxied through our Lambda (keys are server-side)
  mockMode: false,

  // Our API endpoint (Lambda handles PlantNet keys securely)
  apiUrl: 'https://p0833p2v29.execute-api.eu-central-1.amazonaws.com'
};

// ============ Header Update (same as home.html) ============
async function updateStatus() {
  try {
    const s = await API.get('/status');

    // Time is handled by universal clock in common.js

    // Battery
    const batteryStatus = document.getElementById('battery-status');
    if (s.battery && s.battery.percent !== null && s.battery.percent !== undefined) {
      const percent = Math.round(s.battery.percent);
      const charging = s.battery.charging ? ' ‚ö°' : '';
      batteryStatus.textContent = `üîã ${percent}%${charging}`;
    } else {
      batteryStatus.textContent = '‚ö° AC';
    }

    // Device ID
    if (IS_CLOUD && DEVICE_ID) {
      document.getElementById('device-id-header').textContent = 'üå± ' + DEVICE_ID;
    }

    // Location and Room
    if (s.system_state?.location) {
      document.getElementById('location-text').textContent = s.system_state.location;
    }
    if (s.system_state?.room) {
      document.getElementById('room-text').textContent = s.system_state.room;
    }

    // Custom name
    let customName = s.system_state?.device_name || 'Device';
    if (customName === 'Polivalka' || customName.toLowerCase().startsWith('polivalka-')) {
      customName = 'Device';
    }
    document.getElementById('custom-name-suffix').textContent = ' / ' + customName;

    // State
    const rawState = s.system_state?.state || 'OFF';
    const displayState = mapStateToDisplay(rawState, s.pump_running);
    document.getElementById('header-state').textContent = `${displayState.emoji} ${displayState.text}`;

    // Mode badge
    const mode = s.system_state?.mode || 'off';
    const modeBadge = document.getElementById('mode-badge');
    modeBadge.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
    modeBadge.className = 'status-badge status-' + mode;

    // Connection
    const connText = document.getElementById('conn-text');
    if (s.wifi_connected) { connText.textContent = 'Online'; connText.style.color = '#fff'; }
    else { connText.textContent = 'Offline'; connText.style.color = '#999'; }

  } catch (e) {
    console.error('[Identify] Status error:', e);
  }
}

// Smart polling: 60 sec for Cloud, 10 sec for Local
// Stop polling when tab is hidden (saves API costs)
const STATUS_INTERVAL = IS_CLOUD ? 60000 : 10000;
let statusIntervalId = null;

function startPolling() {
  if (statusIntervalId) return;
  statusIntervalId = setInterval(updateStatus, STATUS_INTERVAL);
}

function stopPolling() {
  if (statusIntervalId) {
    clearInterval(statusIntervalId);
    statusIntervalId = null;
  }
}

document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    stopPolling();
  } else {
    updateStatus();
    startPolling();
  }
});

if (getDeviceId()) {
  updateStatus();
  startPolling();
}

// ============ Wikipedia Image Fallback ============
function wikiImgFallback(el) {
  el.onerror = null;
  const names = JSON.parse(el.dataset.wikiNames || '[]');
  (function tryNext(img, arr, i) {
    if (i >= arr.length) { img.style.display = 'none'; return; }
    fetch('https://en.wikipedia.org/api/rest_v1/page/summary/' + arr[i])
      .then(function(r) { return r.ok ? r.json() : null; })
      .then(function(d) { if (d && d.thumbnail) img.src = d.thumbnail.source; else tryNext(img, arr, i + 1); })
      .catch(function() { tryNext(img, arr, i + 1); });
  })(el, names, 0);
}

// ============ State ============
let selectedFiles = [];
let identificationResults = [];
let selectedPlant = null;
let selectedResult = null;  // Full API result with details

// ============ Init ============
document.addEventListener('DOMContentLoaded', function() {
  // Hide mock banner if API keys configured
  if (!CONFIG.mockMode) {
    document.getElementById('mock-banner').style.display = 'none';
  }

  // Setup file input
  const fileInput = document.getElementById('file-input');
  fileInput.addEventListener('change', handleFileSelect);

  // Setup camera input
  const cameraInput = document.getElementById('camera-input');
  cameraInput.addEventListener('change', handleFileSelect);

  // Setup drag & drop
  const uploadArea = document.getElementById('upload-area');
  uploadArea.addEventListener('dragover', handleDragOver);
  uploadArea.addEventListener('dragleave', handleDragLeave);
  uploadArea.addEventListener('drop', handleDrop);

  // Check camera availability
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    document.getElementById('camera-btn').style.display = 'none';
  }

  // Load saved plant profile (only with device)
  if (getDeviceId()) {
    loadSavedProfile();
  } else {
    // No device mode: hide device-dependent sections
    document.getElementById('device-status').style.display = 'none';
    document.getElementById('step-current').style.display = 'none';
    document.getElementById('plant-library').style.display = 'none';
  }

  console.log('[Identify] Page initialized, mockMode:', CONFIG.mockMode, 'device:', getDeviceId() || 'none');
});

// ============ Plant Profile Loading ============
async function loadSavedProfile() {
  const deviceId = getDeviceId();
  if (!deviceId) {
    console.log('[Identify] No device selected');
    return;
  }

  try {
    const response = await API.fetchGlobal(`/plants/${deviceId}`);
    const data = await response.json();

    if (data.success && data.plant) {
      showCurrentPlant(data.plant);
    } else {
      console.log('[Identify] No saved plant profile');
      showDeviceEmpty();
      loadPlantLibrary();
    }
  } catch (err) {
    console.error('[Identify] Error loading profile:', err);
    showDeviceEmpty();
    loadPlantLibrary();
  }
}

function showDeviceEmpty() {
  const statusDiv = document.getElementById('device-status');
  statusDiv.style.borderLeftColor = '#ccc';
  document.getElementById('status-empty').style.display = 'flex';
  document.getElementById('status-attached').style.display = 'none';
}

function showCurrentPlant(plant) {
  // Update device status bar
  const isArchived = plant.archived === true;
  const statusDiv = document.getElementById('device-status');
  statusDiv.style.borderLeftColor = isArchived ? '#ff9800' : '#4caf50';
  document.getElementById('status-empty').style.display = 'none';
  document.getElementById('status-attached').style.display = 'flex';
  document.getElementById('status-plant-name').textContent = plant.common_name || plant.scientific;
  document.getElementById('status-archived-badge').style.display = isArchived ? 'inline' : 'none';
  const sinceEl = document.getElementById('status-since');
  if (plant.started_at) {
    sinceEl.textContent = 'since ' + new Date(plant.started_at * 1000).toLocaleDateString();
  } else {
    sinceEl.textContent = '';
  }

  // Current plant card details
  const currentImg = document.getElementById('current-plant-img');
  const wikiNames = [plant.scientific, plant.family].filter(Boolean).map(n => encodeURIComponent(n.replace(/ /g, '_')));
  currentImg.dataset.wikiNames = JSON.stringify(wikiNames);
  if (plant.image_url) {
    currentImg.src = plant.image_url;
    // Timeout fallback: if saved image URL hangs (PlantNet DNS down), try Wikipedia
    const tid = setTimeout(() => {
      if (!currentImg.complete || currentImg.naturalWidth === 0) {
        currentImg.onerror = null;
        wikiImgFallback(currentImg);
      }
    }, 2000);
    currentImg.addEventListener('load', () => clearTimeout(tid), { once: true });
  } else if (wikiNames.length) {
    wikiImgFallback(currentImg);
  }
  document.getElementById('current-plant-name').textContent = plant.common_name || plant.scientific;
  document.getElementById('current-plant-scientific').textContent = plant.scientific || '';

  // Show preset + date
  let presetText = `${plant.preset || 'Standard'} (${plant.start_pct || 35}-${plant.stop_pct || 55}%)`;
  if (plant.started_at) {
    const d = new Date(plant.started_at * 1000);
    presetText += ` ‚Ä¢ since ${d.toLocaleDateString()}`;
  }
  document.getElementById('current-plant-preset').textContent = presetText;

  // Show/hide archived badge and buttons
  document.getElementById('archived-badge').style.display = isArchived ? 'inline' : 'none';
  document.getElementById('btn-archive').style.display = isArchived ? 'none' : 'block';
  document.getElementById('btn-unarchive').style.display = isArchived ? 'block' : 'none';

  document.getElementById('step-current').style.display = 'block';

  // Load plant library after showing current plant
  loadPlantLibrary();
}

// ============ Plant Library ============
let libraryExpanded = false;
let _plantBusy = false;

async function loadPlantLibrary() {
  try {
    const response = await API.fetchGlobal('/plants/library');
    const data = await response.json();

    if (data.success && data.plants) {
      renderPlantLibrary(data.plants);
    }
  } catch (err) {
    console.error('[Identify] Error loading library:', err);
  }
}

function renderPlantLibrary(plants) {
  const libraryDiv = document.getElementById('plant-library');
  const listDiv = document.getElementById('library-list');
  const emptyDiv = document.getElementById('library-empty');
  const countSpan = document.getElementById('library-count');
  const currentDeviceId = getDeviceId();

  // Show ALL plants except the one currently active on THIS device (already shown in "Current Plant")
  const libraryPlants = plants.filter(p => !(p.device_id === currentDeviceId && p.active));

  countSpan.textContent = `(${libraryPlants.length})`;

  if (libraryPlants.length === 0) {
    listDiv.style.display = 'none';
    emptyDiv.style.display = 'block';
    libraryDiv.style.display = plants.length > 0 ? 'block' : 'none';
    return;
  }

  libraryDiv.style.display = 'block';
  listDiv.style.display = 'grid';
  emptyDiv.style.display = 'none';

  // Auto-expand library if it has plants
  if (!libraryExpanded && libraryPlants.length > 0) {
    libraryExpanded = true;
    document.getElementById('library-content').style.display = 'block';
    document.getElementById('library-toggle').textContent = '‚ñ≤';
  }

  listDiv.innerHTML = libraryPlants.map(plant => {
    const deletedBadge = plant.deleted ? '<span style="background:#f44336;color:#fff;font-size:10px;padding:1px 4px;border-radius:4px;margin-left:4px">Deleted</span>' : '';
    const archivedBadge = !plant.deleted && plant.archived ? '<span style="background:#ff9800;color:#fff;font-size:10px;padding:1px 4px;border-radius:4px;margin-left:4px">Archived</span>' : '';
    const activeBadge = plant.active ? '<span style="background:#4caf50;color:#fff;font-size:10px;padding:1px 4px;border-radius:4px;margin-left:4px">Active</span>' : '';
    const ownerBadge = plant.owner ? `<span style="background:#2196f3;color:#fff;font-size:10px;padding:1px 4px;border-radius:4px;margin-left:4px">${plant.owner}</span>` : '';
    const deviceLabel = plant.device_id.replace('Polivalka-', '');

    // Show device + time period
    let timeInfo = '';
    if (plant.started_at && plant.ended_at) {
      const s = new Date(plant.started_at * 1000).toLocaleDateString();
      const e = new Date(plant.ended_at * 1000).toLocaleDateString();
      timeInfo = ` ‚Ä¢ ${s} ‚Äî ${e}`;
    } else if (plant.started_at) {
      timeInfo = ` ‚Ä¢ since ${new Date(plant.started_at * 1000).toLocaleDateString()}`;
    }

    const isDeleted = plant.deleted;
    return `
      <div class="library-item" style="display:flex;gap:12px;padding:10px;border:1px solid ${isDeleted ? '#ffcdd2' : '#ddd'};border-radius:8px;align-items:center;${isDeleted ? 'opacity:0.6;' : 'cursor:pointer;'}transition:all 0.2s"
           ${isDeleted ? '' : `onclick="assignPlantFromLibrary('${plant.plant_id}')"`}
           ${isDeleted ? '' : 'onmouseover="this.style.borderColor=\'#2c5f2d\';this.style.background=\'#f9fff9\'"'}
           ${isDeleted ? '' : 'onmouseout="this.style.borderColor=\'#ddd\';this.style.background=\'#fff\'"'}>
        <img src="${plant.image_url || ''}" style="width:50px;height:50px;border-radius:8px;object-fit:cover;background:#f0f0f0"
             data-wiki-names='${JSON.stringify([plant.scientific, plant.family].filter(Boolean).map(n => encodeURIComponent(n.replace(/ /g, "_"))))}'
             onerror="wikiImgFallback(this)">
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;font-size:14px;line-height:1.4">
            ${plant.common_name || plant.scientific} ${deletedBadge}${archivedBadge}${activeBadge}
          </div>
          <div style="font-size:12px;color:#666">üìü ${deviceLabel} ${ownerBadge}${timeInfo}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          ${!isDeleted && plant.archived && plant.started_at && plant.ended_at && plant.device_id ? `<a href="trends.html?device=${encodeURIComponent(plant.device_id)}&start=${plant.started_at}&end=${plant.ended_at}&plant_name=${encodeURIComponent(plant.common_name || plant.scientific || '')}"
                  onclick="event.stopPropagation()"
                  style="background:none;border:none;cursor:pointer;font-size:16px;padding:4px;opacity:0.5;transition:opacity 0.2s;text-decoration:none"
                  onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'"
                  title="View archived trends">üìä</a>` : ''}
          ${isDeleted ? `<button onclick="event.stopPropagation();unarchivePlant('${plant.plant_id}','${plant.device_id}')"
                  style="background:none;border:none;cursor:pointer;font-size:16px;padding:4px;opacity:0.5;transition:opacity 0.2s"
                  onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'"
                  title="Restore plant">‚ôªÔ∏è</button>` :
            `<button onclick="event.stopPropagation();deleteLibraryPlant('${plant.plant_id}','${plant.device_id}','${(plant.common_name || plant.scientific || '').replace(/'/g, "\\'")}')"
                  style="background:none;border:none;cursor:pointer;font-size:16px;padding:4px;opacity:0.5;transition:opacity 0.2s"
                  onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'"
                  title="Remove from library">üóëÔ∏è</button>`}
          ${isDeleted ? '' : '<div style="color:#2c5f2d;font-size:18px">‚Üí</div>'}
        </div>
      </div>
    `;
  }).join('');

  // Timeout fallback for library images with PlantNet URLs
  listDiv.querySelectorAll('img[data-wiki-names]').forEach(img => {
    const tid = setTimeout(() => {
      if (!img.complete || img.naturalWidth === 0) {
        wikiImgFallback(img);
      }
    }, 2000);
    img.addEventListener('load', () => clearTimeout(tid), { once: true });
  });
}

function toggleLibrary() {
  libraryExpanded = !libraryExpanded;
  document.getElementById('library-content').style.display = libraryExpanded ? 'block' : 'none';
  document.getElementById('library-toggle').textContent = libraryExpanded ? '‚ñ≤' : '‚ñº';
}

async function deleteLibraryPlant(plantId, deviceId, plantName) {
  if (_plantBusy) return;
  if (!confirm(`Remove "${plantName}" from your library? It will be saved in your history.`)) return;
  _plantBusy = true;
  try {
    await API.fetchGlobal(`/plants/${deviceId}?plant_id=${plantId}`, { method: 'DELETE' });
    showToast('Plant removed from library', 'success');
    loadPlantLibrary();
  } catch (e) {
    showToast('Error: ' + e.message, 'error');
  } finally { _plantBusy = false; }
}

async function assignPlantFromLibrary(plantId) {
  if (_plantBusy) return;
  if (!confirm('Assign this plant to current device? This will replace the current plant profile.')) return;
  const deviceId = getDeviceId();
  if (!deviceId) return;
  _plantBusy = true;
  try {
    await API.fetchGlobal(`/plants/${deviceId}/assign`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ plant_id: plantId })
    });
    showToast('Plant assigned successfully!', 'success');
    setTimeout(() => location.reload(), 1000);
  } catch (e) {
    showToast('Error: ' + e.message, 'error');
  } finally { _plantBusy = false; }
}

async function archivePlant() {
  if (_plantBusy) return;
  if (!confirm('Archive this plant profile?\n\nThe device will continue collecting data, but it won\'t be linked to this plant.\n\nTip: remove the device from the plant physically before archiving.')) return;
  const deviceId = getDeviceId();
  if (!deviceId) return;
  _plantBusy = true;
  try {
    await API.fetchGlobal(`/plants/${deviceId}/archive`, { method: 'POST' });
    showToast('Plant archived', 'success');
    document.getElementById('device-status').style.borderLeftColor = '#ff9800';
    document.getElementById('status-archived-badge').style.display = 'inline';
    document.getElementById('archived-badge').style.display = 'inline';
    document.getElementById('btn-archive').style.display = 'none';
    document.getElementById('btn-unarchive').style.display = 'block';
    loadPlantLibrary();
  } catch (e) {
    showToast('Error: ' + e.message, 'error');
  } finally { _plantBusy = false; }
}

async function unarchivePlant() {
  if (_plantBusy) return;
  const deviceId = getDeviceId();
  if (!deviceId) return;
  _plantBusy = true;
  try {
    await API.fetchGlobal(`/plants/${deviceId}/unarchive`, { method: 'POST' });
    showToast('Plant restored', 'success');
    document.getElementById('device-status').style.borderLeftColor = '#4caf50';
    document.getElementById('status-archived-badge').style.display = 'none';
    document.getElementById('archived-badge').style.display = 'none';
    document.getElementById('btn-archive').style.display = 'block';
    document.getElementById('btn-unarchive').style.display = 'none';
    loadPlantLibrary();
  } catch (e) {
    showToast('Error: ' + e.message, 'error');
  } finally { _plantBusy = false; }
}

async function deletePlant() {
  if (_plantBusy) return;
  if (!confirm('Remove this plant from the device? It will be saved in your history.')) return;
  const deviceId = getDeviceId();
  if (!deviceId) return;
  _plantBusy = true;
  try {
    await API.fetchGlobal(`/plants/${deviceId}`, { method: 'DELETE' });
    showToast('Plant removed', 'success');
    document.getElementById('step-current').style.display = 'none';
    showDeviceEmpty();
    loadPlantLibrary();
  } catch (e) {
    showToast('Error: ' + e.message, 'error');
  } finally { _plantBusy = false; }
}

// ============ File Handling ============
function handleDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
  e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('dragover');

  const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
  addFiles(files);
}

function handleFileSelect(e) {
  const files = Array.from(e.target.files);
  addFiles(files);
  e.target.value = ''; // Reset for re-selection
}

function addFiles(files) {
  // Max 5 files
  const remaining = 5 - selectedFiles.length;
  const toAdd = files.slice(0, remaining);

  toAdd.forEach(file => {
    // Validate file size (max 20MB)
    if (file.size > 20 * 1024 * 1024) {
      showToast('File too large (max 20MB)', 'warning');
      return;
    }

    // Validate file type (early rejection of non-images)
    const isImage = file.type.startsWith('image/') ||
                    file.name.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|heic|heif|bmp)$/);
    if (!isImage) {
      showToast('Please select an image file', 'warning');
      return;
    }

    selectedFiles.push(file);
  });

  updatePreview();
  updateIdentifyButton();
}

function removeFile(index) {
  selectedFiles.splice(index, 1);
  updatePreview();
  updateIdentifyButton();
}

function updatePreview() {
  const container = document.getElementById('preview-area');
  container.innerHTML = '';

  selectedFiles.forEach((file, index) => {
    const div = document.createElement('div');
    div.className = 'preview-item';

    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);

    const btn = document.createElement('button');
    btn.className = 'remove-btn';
    btn.textContent = '√ó';
    btn.onclick = () => removeFile(index);

    div.appendChild(img);
    div.appendChild(btn);
    container.appendChild(div);
  });

  // Show GDPR checkbox if files selected
  document.getElementById('gdpr-section').style.display = selectedFiles.length > 0 ? 'flex' : 'none';
}

function updateIdentifyButton() {
  const btn = document.getElementById('identify-btn');
  btn.disabled = selectedFiles.length === 0;
}

function openCamera() {
  document.getElementById('camera-input').click();
}

// ============ Plant Identification ============
async function identifyPlant() {
  if (selectedFiles.length === 0) return;

  showStep('loading');
  hideError();

  try {
    // Convert image to base64
    const imageFile = selectedFiles[0];
    const base64Image = await fileToBase64(imageFile);

    // Call our secure API (keys are server-side)
    const response = await fetch(`${CONFIG.apiUrl}/plants/identify`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ image: base64Image })
    });

    const data = await response.json();

    if (!response.ok || !data.success) {
      throw new Error(data.error || 'Identification failed');
    }

    let results = data.results || [];

    if (results.length === 0) {
      showError('Could not identify the plant. Try a different photo.');
      showStep('upload');
      return;
    }

    // Filter low confidence results
    results = results.filter(r => r.score >= 1);

    if (results.length === 0) {
      showError('No confident matches found. Try a clearer photo of the leaves.');
      showStep('upload');
      return;
    }

    identificationResults = results;
    renderResults(results);
    showStep('results');

  } catch (err) {
    console.error('Identification error:', err);
    showError('Error identifying plant: ' + err.message);
    showStep('upload');
  }
}

// Lazy load heic2any library for Windows/Linux HEIC support
let heic2anyLoaded = false;
async function loadHeic2Any() {
  if (heic2anyLoaded) return;
  await new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js';
    script.onload = () => { heic2anyLoaded = true; resolve(); };
    script.onerror = () => reject(new Error('Failed to load HEIC converter'));
    document.head.appendChild(script);
  });
}

// Check if file is HEIC format
function isHEICFile(file) {
  return file.type === 'image/heic' || file.type === 'image/heif' ||
         file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif');
}

// Convert HEIC to JPEG blob using heic2any
async function convertHEIC(file) {
  console.log('[HEIC] Converting on Windows/Linux...');
  const loadingText = document.getElementById('loading-text');
  if (loadingText) loadingText.textContent = 'Converting HEIC format...';
  await loadHeic2Any();
  const blob = await heic2any({ blob: file, toType: 'image/jpeg', quality: 0.8 });
  if (loadingText) loadingText.textContent = 'Analyzing your plant...';
  console.log('[HEIC] Conversion done');
  return Array.isArray(blob) ? blob[0] : blob;
}

// Compress image using Canvas (max 1024px, JPEG 70%)
function compressWithCanvas(blob, fileName) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const objectUrl = URL.createObjectURL(blob);

    img.onload = () => {
      URL.revokeObjectURL(objectUrl);

      const MAX_SIZE = 1024;
      let width = img.width;
      let height = img.height;

      if (width > height && width > MAX_SIZE) {
        height = Math.round(height * MAX_SIZE / width);
        width = MAX_SIZE;
      } else if (height > MAX_SIZE) {
        width = Math.round(width * MAX_SIZE / height);
        height = MAX_SIZE;
      }

      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);

      const compressed = canvas.toDataURL('image/jpeg', 0.7);
      console.log(`[Compress] ${fileName}: ${img.width}x${img.height} ‚Üí ${width}x${height}, ~${Math.round(compressed.length/1024)}KB`);
      resolve(compressed);
    };

    img.onerror = () => {
      URL.revokeObjectURL(objectUrl);
      reject(new Error('Cannot read image'));
    };

    img.src = objectUrl;
  });
}

// Main function: convert file to base64 with compression
async function fileToBase64(file) {
  // Check file size (max 20MB raw)
  const MAX_FILE_SIZE = 20 * 1024 * 1024;
  if (file.size > MAX_FILE_SIZE) {
    throw new Error(`File too large (${Math.round(file.size/1024/1024)}MB). Max 20MB.`);
  }

  // Validate file type (security: reject non-images early)
  const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/heic', 'image/heif', 'image/gif', 'image/bmp'];
  const isHEIC = isHEICFile(file);
  const hasValidType = allowedTypes.includes(file.type) || isHEIC || file.type.startsWith('image/');

  if (!hasValidType && file.type) {
    console.warn(`[Security] Rejected file type: ${file.type}`);
    throw new Error(`Invalid file type (${file.type}). Please upload an image.`);
  }

  // Try native loading first
  try {
    return await compressWithCanvas(file, file.name);
  } catch (e) {
    // If native failed and it's HEIC, try heic2any converter (Windows/Linux)
    if (isHEIC) {
      try {
        const jpegBlob = await convertHEIC(file);
        return await compressWithCanvas(jpegBlob, file.name);
      } catch (heicError) {
        throw new Error('Cannot convert HEIC. Try converting to JPG first.');
      }
    }
    throw new Error('Cannot read image. Try JPG or PNG format.');
  }
}

// ============ Results Rendering ============
function renderResults(results) {
  const container = document.getElementById('results-list');
  container.innerHTML = '';

  results.forEach((result, index) => {
    const div = document.createElement('div');
    div.className = 'result-item';
    div.onclick = () => selectResult(index);

    let imagesHtml = '';
    // Show PlantNet images with Wikipedia fallback chain (scientific ‚Üí genus ‚Üí family)
    const wikiNames = [result.scientific, result.genus, result.family].filter(Boolean).map(n => encodeURIComponent(n.replace(/ /g, '_')));
    if (result.images && result.images.length > 0) {
      imagesHtml = '<div class="result-images">' +
        result.images.map(url => `<img src="${url}" alt="" data-wiki-names='${JSON.stringify(wikiNames)}' onerror="wikiImgFallback(this)">`).join('') +
        '</div>';
    }

    // Show care preset badge
    const care = result.care || {};
    const presetBadge = care.preset ? `<span style="background:#e8f5e9;color:#2c5f2d;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:8px">${care.preset}</span>` : '';
    const familyInfo = result.family ? `<div style="font-size:11px;color:#888;margin-top:2px">Family: ${result.family}</div>` : '';

    div.innerHTML = `
      <div class="result-header">
        <input type="radio" name="result" class="result-radio" ${index === 0 ? 'checked' : ''}>
        <div class="result-info">
          <div class="result-name">${result.scientific}${presetBadge}</div>
          <div class="result-common">${result.commonNames.slice(0, 2).join(', ') || 'No common name'}</div>
          ${familyInfo}
          <div class="result-score">${result.score}% match${care.watering ? ' ‚Ä¢ ' + care.watering : ''}</div>
        </div>
      </div>
      ${imagesHtml}
    `;

    container.appendChild(div);
  });

  // Timeout fallback: if PlantNet images don't load in 2s (DNS hang), force Wikipedia
  container.querySelectorAll('img[data-wiki-names]').forEach(img => {
    const tid = setTimeout(() => {
      if (!img.complete || img.naturalWidth === 0) {
        wikiImgFallback(img);
      }
    }, 2000);
    img.addEventListener('load', () => clearTimeout(tid));
  });
}

function selectResult(index) {
  // Update UI
  document.querySelectorAll('.result-item').forEach((el, i) => {
    el.classList.toggle('selected', i === index);
    el.querySelector('.result-radio').checked = (i === index);
  });

  const result = identificationResults[index];
  showPlantCard(result);
}

// ============ Plant Card ============
function showPlantCard(result) {
  // Use care data from API (new format with family mapping)
  const apiCare = result.care || {};

  // Build plantData from API result
  const plantData = {
    id: result.id,
    scientific: result.scientific,
    family: result.family || 'Unknown',
    genus: result.genus || '',
    names: { en: result.commonNames[0] || result.scientific },
    care: {
      preset: apiCare.preset || 'Standard',
      start_pct: apiCare.start_pct || 35,
      stop_pct: apiCare.stop_pct || 55,
      watering: apiCare.watering || 'Every 7-10 days',
      light: apiCare.light || 'Bright indirect light'
    },
    photos: result.images || []
  };

  selectedPlant = plantData;
  selectedResult = result;  // Store full result for saveToProfile

  // Populate card photo: PlantNet ‚Üí Wikipedia (scientific name) ‚Üí Wikipedia (genus)
  const cardPhoto = document.getElementById('card-photo');
  const plantNetUrl = plantData.photos[0] || '';
  function tryWikiImage(el, names, idx) {
    if (idx >= names.length) return;
    fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(names[idx])}`)
      .then(r => r.ok ? r.json() : null)
      .then(d => {
        if (d && d.thumbnail) { el.src = d.thumbnail.source; selectedPlant.wikiImage = d.thumbnail.source; }
        else tryWikiImage(el, names, idx + 1);
      })
      .catch(() => tryWikiImage(el, names, idx + 1));
  }
  cardPhoto.onerror = function() {
    this.onerror = null;
    const names = [result.scientific, result.genus, result.family].filter(Boolean).map(n => n.replace(/ /g, '_'));
    tryWikiImage(this, names, 0);
  };
  if (plantNetUrl) {
    cardPhoto.src = plantNetUrl;
    // Timeout fallback: if PlantNet doesn't load in 2s (DNS hang), force Wikipedia
    const cardTimeout = setTimeout(() => {
      if (!cardPhoto.complete || cardPhoto.naturalWidth === 0) {
        cardPhoto.onerror();
      }
    }, 2000);
    cardPhoto.addEventListener('load', () => clearTimeout(cardTimeout), { once: true });
  } else {
    // No PlantNet URL at all ‚Äî go straight to Wikipedia
    const names = [result.scientific, result.genus, result.family].filter(Boolean).map(n => n.replace(/ /g, '_'));
    tryWikiImage(cardPhoto, names, 0);
  }
  document.getElementById('card-name').textContent = plantData.scientific;  // Scientific = primary
  document.getElementById('card-scientific').textContent = plantData.names.en || '';  // Common = secondary

  // Show family info
  const familyText = plantData.family ? `Family: ${plantData.family}` : '';
  document.getElementById('card-names').textContent = familyText;

  // Care info from API
  const care = plantData.care;
  document.getElementById('care-watering').textContent = care.watering;
  document.getElementById('care-moisture').textContent = `${care.start_pct}% - ${care.stop_pct}%`;
  document.getElementById('care-light').textContent = care.light;
  document.getElementById('care-temp').textContent = care.temperature || '18-24¬∞C';
  document.getElementById('care-humidity').textContent = care.humidity || 'Average (40-60%)';

  // Tips from API (use textContent to prevent XSS)
  const tipsList = document.getElementById('care-tips');
  tipsList.innerHTML = '<li></li>';
  tipsList.querySelector('li').textContent = care.tips || 'Water when top inch of soil is dry.';

  // Detailed info from API
  const details = result.details || {};

  // Safety section - toxicity from API (TOXIC_FAMILIES on backend)
  const safetySection = document.getElementById('safety-section');
  const toxicHumansItem = document.getElementById('toxic-humans-item');
  const toxicPetsItem = document.getElementById('toxic-pets-item');
  let showSafety = false;

  // Reset safety section: remove dynamic notes, hide items
  safetySection.querySelectorAll('.toxicity-note').forEach(el => el.remove());
  toxicHumansItem.style.display = 'none';
  toxicPetsItem.style.display = 'none';

  const toxicity = result.toxicity;
  if (toxicity) {
    if (toxicity.toxicity_note) {
      const noteEl = document.createElement('div');
      noteEl.className = 'toxicity-note';
      noteEl.style.cssText = 'font-size:12px;color:#e65100;background:#fff3e0;padding:8px 10px;border-radius:6px;margin-bottom:8px';
      let noteText = `${toxicity.toxicity_note}`;
      if (toxicity.poisonous_to_pets) noteText += ' - Keep away from pets';
      noteEl.textContent = noteText;
      safetySection.insertBefore(noteEl, safetySection.querySelector('.care-grid'));
      showSafety = true;
    } else {
      if (toxicity.poisonous_to_humans === true) {
        toxicHumansItem.style.display = '';
        document.getElementById('toxic-humans').textContent = 'Caution';
        showSafety = true;
      }
      if (toxicity.poisonous_to_pets === true) {
        toxicPetsItem.style.display = '';
        document.getElementById('toxic-pets').textContent = 'Keep away from pets';
        showSafety = true;
      }
    }
  }

  safetySection.style.display = showSafety ? '' : 'none';

  // Plant info section ‚Äî reset all optional items first
  const infoSection = document.getElementById('info-section');
  let showInfo = false;
  ['size-item','growth-item','cycle-item','difficulty-item','hardiness-item','indoor-item'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });

  if (details.dimension) {
    document.getElementById('size-item').style.display = '';
    document.getElementById('plant-size').textContent = details.dimension;
    showInfo = true;
  }
  if (details.growth_rate) {
    document.getElementById('growth-item').style.display = '';
    document.getElementById('growth-rate').textContent = capitalize(details.growth_rate);
    showInfo = true;
  }
  if (details.cycle) {
    document.getElementById('cycle-item').style.display = '';
    document.getElementById('life-cycle').textContent = capitalize(details.cycle);
    showInfo = true;
  }
  if (details.care_level) {
    document.getElementById('difficulty-item').style.display = '';
    document.getElementById('care-difficulty').textContent = capitalize(details.care_level);
    showInfo = true;
  }
  if (details.hardiness_min || details.hardiness_max) {
    document.getElementById('hardiness-item').style.display = '';
    const zone = details.hardiness_min === details.hardiness_max
      ? `Zone ${details.hardiness_min}`
      : `Zone ${details.hardiness_min}-${details.hardiness_max}`;
    document.getElementById('hardiness-zone').textContent = zone;
    showInfo = true;
  }
  if (details.indoor !== undefined) {
    document.getElementById('indoor-item').style.display = '';
    document.getElementById('indoor-suitable').textContent = details.indoor ? '‚úì Yes' : 'Outdoor only';
    showInfo = true;
  }
  infoSection.style.display = showInfo ? '' : 'none';

  // Propagation section ‚Äî reset all optional items first
  const propSection = document.getElementById('propagation-section');
  let showProp = false;
  ['propagation-item','pruning-item','soil-item','pests-item'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });

  if (details.propagation && details.propagation.length > 0) {
    document.getElementById('propagation-item').style.display = '';
    document.getElementById('propagation-methods').textContent = details.propagation.slice(0,3).join(', ');
    showProp = true;
  }
  if (details.pruning_month && details.pruning_month.length > 0) {
    document.getElementById('pruning-item').style.display = '';
    document.getElementById('pruning-months').textContent = details.pruning_month.slice(0,3).join(', ');
    showProp = true;
  }
  if (details.soil && details.soil.length > 0) {
    document.getElementById('soil-item').style.display = '';
    document.getElementById('soil-type').textContent = Array.isArray(details.soil) ? details.soil.join(', ') : details.soil;
    showProp = true;
  }
  if (details.pest_susceptibility) {
    document.getElementById('pests-item').style.display = '';
    document.getElementById('pest-info').textContent = details.pest_susceptibility;
    showProp = true;
  }
  propSection.style.display = showProp ? '' : 'none';

  showStep('card');
}

function capitalize(str) {
  if (!str) return '';
  return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}

// ============ Actions ============

// Main action: Show confirmation, then Apply + Save + Redirect
async function confirmPlant() {
  if (!selectedPlant || !selectedResult) return;

  const deviceId = getDeviceId();
  if (!deviceId) {
    showToast('No device selected. Go to Fleet first.', 'warning');
    return;
  }

  const care = selectedPlant.care;
  const plantName = selectedPlant.scientific;  // Scientific name - universal across all languages

  // Check if auto-watering is enabled
  let autoWateringOn = false;
  try {
    const status = await API.get('/sensor/controller/status');
    autoWateringOn = status.state && status.state !== 'DISABLED';
  } catch (e) {
    console.log('Could not check auto-watering status');
  }

  // Check if there's a current plant that will be detached
  let currentPlantName = null;
  try {
    const profileResp = await fetch(`${CONFIG.apiUrl}/plants/${deviceId}`, {
      headers: API.getAuthHeaders()
    });
    const profileData = await profileResp.json();
    if (profileData.success && profileData.plant && profileData.plant.plant_id) {
      currentPlantName = profileData.plant.common_name || profileData.plant.scientific;
    }
  } catch (e) { /* ignore */ }

  // Build confirmation message
  let message = `Binding "${plantName}" to this device:\n\n`;
  if (currentPlantName) {
    message += `‚Ä¢ Current plant "${currentPlantName}" will be saved to your library\n`;
  }
  message += `‚Ä¢ Device name will change to "${plantName}"\n`;
  message += `‚Ä¢ Sensor mode will use ${care.start_pct}-${care.stop_pct}% moisture range\n`;

  if (autoWateringOn) {
    message += `\n‚ö†Ô∏è AUTO-WATERING IS ON!\n`;
    message += `Watering may start immediately if soil moisture is below ${care.start_pct}%.\n`;
  }

  message += `\nContinue?`;

  // Show confirmation
  if (!confirm(message)) {
    return;
  }

  // User confirmed - proceed
  const btn = document.querySelector('.actions button.primary');
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Saving...';

  try {
    // 1. Apply watering preset to device (loads ALL preset values including max_water_cycle_ml)
    await API.post('/command', {
      command: 'sensor_preset_set',
      params: {
        preset: care.preset
      }
    });

    // 2. Override start_pct and stop_pct if AI recommends different values
    await API.post('/command', {
      command: 'sensor_set',
      params: {
        start_moisture_pct: care.start_pct,
        stop_moisture_pct: care.stop_pct
      }
    });

    // 3. Update device name to plant name
    await API.post('/info', {
      name: plantName
    });

    // 4. Save plant to profile
    await saveToProfile();

    // 5. Success - reload page to show updated plant + library
    btn.textContent = '‚úì Saved!';
    showToast('Plant bound to device!', 'success');

    setTimeout(() => {
      location.reload();
    }, 1500);

  } catch (err) {
    console.error('Confirm error:', err);
    showToast('Error: ' + err.message, 'error');
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

async function saveToProfile() {
  if (!selectedPlant || !selectedResult) return;

  const deviceId = getDeviceId();
  if (!deviceId) {
    showToast('Select a device first', 'warning');
    return;
  }

  const care = selectedResult.care || {};
  const toxicity = selectedResult.toxicity || {};

  // Build plant data for API
  const plantData = {
    scientific: selectedPlant.scientific,
    common_name: selectedPlant.names?.en || selectedPlant.scientific,
    family: selectedPlant.family,
    preset: care.preset || 'standard',
    start_pct: care.start_pct || 35,
    stop_pct: care.stop_pct || 55,
    // Safety info from API (TOXIC_FAMILIES on backend)
    poisonous_to_humans: toxicity.poisonous_to_humans,
    poisonous_to_pets: toxicity.poisonous_to_pets,
    toxicity_note: toxicity.toxicity_note,
    // Image URL: prefer Wikipedia (reliable) over PlantNet (bs.plantnet.org may be down)
    image_url: selectedPlant.wikiImage || selectedPlant.photos?.[0] || ''
  };

  try {
    const response = await API.fetchGlobal('/plants/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ device_id: deviceId, plant: plantData })
    });
    const data = await response.json();

    if (data.success) {
      showToast('Plant saved to profile!', 'success');
    } else {
      throw new Error(data.error || 'Save failed');
    }

  } catch (err) {
    console.error('Save error:', err);
    const errorMsg = err.message || 'Failed to save';

    // Handle specific errors
    if (errorMsg.includes('already saved')) {
      showToast('This plant is already saved', 'warning');
    } else if (errorMsg.includes('limit reached')) {
      showToast('Plant limit reached (20). Delete some plants.', 'warning');
    } else if (errorMsg.includes('Rate limit')) {
      showToast('Too many saves. Wait a bit.', 'warning');
    } else {
      showToast(errorMsg, 'error');
    }
  }
}


// ============ Navigation ============
function showStep(step) {
  document.getElementById('step-upload').style.display = step === 'upload' ? 'block' : 'none';
  document.getElementById('loading').style.display = step === 'loading' ? 'block' : 'none';
  document.getElementById('step-results').style.display = step === 'results' ? 'block' : 'none';
  document.getElementById('step-card').style.display = step === 'card' ? 'block' : 'none';
  document.getElementById('step-catalog').style.display = step === 'catalog' ? 'block' : 'none';

  if (step === 'results') {
    document.getElementById('step-results').classList.add('results-section');
    document.getElementById('step-results').style.display = 'block';
  }

  if (step === 'card') {
    document.getElementById('step-card').classList.add('visible');
    const hasDevice = !!getDeviceId();
    document.getElementById('plant-actions').style.display = hasDevice ? '' : 'none';
    document.getElementById('no-device-promo').style.display = hasDevice ? 'none' : 'block';
  }
}

function goBack() {
  selectedFiles = [];
  updatePreview();
  updateIdentifyButton();
  identificationResults = [];
  selectedPlant = null;
  showStep('upload');
}

function goBackToResults() {
  showStep('results');
}

function showError(message) {
  const el = document.getElementById('error');
  el.textContent = message;
  el.style.display = 'block';
}

function hideError() {
  document.getElementById('error').style.display = 'none';
}

// ============ Helpers ============
function getDeviceId() {
  // Get from URL or localStorage
  const params = new URLSearchParams(window.location.search);
  return params.get('device') || localStorage.getItem('selected_device_id');
}

console.log('[Identify] Script loaded');
</script>
</body>
</html>
