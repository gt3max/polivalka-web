<!doctype html>
<html>
<head>
<script src="api-adapter.js"></script>
<script src="common.js"></script>
<meta charset="utf-8"/>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Plant Identification</title>
<style>
  body{font-family:system-ui,Arial;margin:0;padding:0;max-width:100%;background:#fafafa}
  .header{position:sticky;top:0;z-index:1000;background:#2c5f2d;color:#fff;padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
  .header-info{font-size:12px;text-align:right;line-height:1.3}
  .nav{position:sticky;top:65px;z-index:999;background:#f0f0f0;padding:5px 8px;display:flex;gap:2px;border-bottom:1px solid #ddd;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch}
  .nav a{text-decoration:none;color:#333;padding:6px 8px;border-radius:6px;font-size:14px;flex-shrink:0}
  .nav a.active{background:#2c5f2d;color:#fff}
  .nav a:hover{background:#ddd}
  .container{padding:18px;max-width:600px;margin:0 auto}
  .card{border:1px solid #ddd;padding:16px;border-radius:12px;margin:12px 0;background:#fff}
  button{padding:10px 16px;border-radius:8px;border:1px solid #888;background:#fafafa;cursor:pointer;font-size:14px}
  button.primary{background:#2c5f2d;color:#fff;border-color:#2c5f2d}
  button.secondary{background:#f5f5f5;border-color:#ccc}
  button:hover{opacity:0.9}
  button:disabled{opacity:0.5;cursor:not-allowed}
  .muted{color:#666;font-size:14px}

  /* Upload Section */
  .upload-area{border:2px dashed #ccc;border-radius:12px;padding:40px 20px;text-align:center;cursor:pointer;transition:all 0.3s}
  .upload-area:hover{border-color:#2c5f2d;background:#f0f8f0}
  .upload-area.dragover{border-color:#2c5f2d;background:#e8f5e9}
  .upload-icon{font-size:48px;margin-bottom:12px}
  .upload-text{color:#666;margin-bottom:8px}
  .upload-hint{font-size:12px;color:#999}
  .upload-buttons{display:flex;gap:12px;justify-content:center;margin-top:16px}

  /* Preview */
  .preview-area{display:flex;gap:8px;flex-wrap:wrap;margin:16px 0}
  .preview-item{position:relative;width:80px;height:80px;border-radius:8px;overflow:hidden}
  .preview-item img{width:100%;height:100%;object-fit:cover}
  .preview-item .remove-btn{position:absolute;top:2px;right:2px;background:#fff;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;border:none;box-shadow:0 1px 3px rgba(0,0,0,0.2)}

  /* Results */
  .results-section{display:none}
  .result-item{border:1px solid #ddd;border-radius:10px;padding:12px;margin:10px 0;cursor:pointer;transition:all 0.2s}
  .result-item:hover{border-color:#2c5f2d;background:#f9fff9}
  .result-item.selected{border-color:#2c5f2d;background:#e8f5e9;border-width:2px}
  .result-header{display:flex;gap:12px;align-items:start}
  .result-radio{margin-top:4px}
  .result-info{flex:1}
  .result-name{font-weight:600;color:#2c5f2d;font-size:16px}
  .result-common{font-size:13px;color:#666}
  .result-score{font-size:12px;color:#999;margin-top:4px}
  .result-images{display:flex;gap:4px;margin-top:8px;overflow-x:auto}
  .result-images img{width:60px;height:60px;border-radius:6px;object-fit:cover}

  /* Plant Card */
  .plant-card{display:none}
  .plant-card.visible{display:block}
  .plant-card-header{display:flex;gap:16px;align-items:start;margin-bottom:16px}
  .plant-card-photo{width:100px;height:100px;border-radius:12px;object-fit:cover;background:#f0f0f0}
  .plant-card-info{flex:1}
  .plant-card-name{font-size:20px;font-weight:600;color:#2c5f2d}
  .plant-card-scientific{font-size:14px;color:#666;font-style:italic}
  .plant-card-names{font-size:12px;color:#999;margin-top:4px}
  .care-section{margin:16px 0}
  .care-section h4{margin:0 0 8px 0;font-size:14px;color:#666}
  .care-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .care-item{background:#f5f5f5;padding:10px;border-radius:8px;font-size:13px}
  .care-label{font-size:11px;color:#999;display:block}
  .care-value{font-weight:600;color:#333}
  .tips-list{margin:0;padding-left:20px;font-size:13px;color:#666}
  .tips-list li{margin:4px 0}

  /* Actions */
  .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:20px}
  .actions button{flex:1;min-width:140px}


  /* Loading */
  .loading{text-align:center;padding:40px}
  .spinner{width:40px;height:40px;border:3px solid #f0f0f0;border-top-color:#2c5f2d;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Error */
  .error-message{background:#ffebee;border:1px solid #ffcdd2;color:#c62828;padding:12px;border-radius:8px;margin:16px 0;font-size:14px}

  /* Manual search */
  .manual-search{margin-top:20px;padding-top:16px;border-top:1px solid #eee}
  .manual-search input{width:100%;padding:10px 12px;border:1px solid #ccc;border-radius:8px;font-size:14px;margin-bottom:12px;box-sizing:border-box}

  /* Catalog fallback */
  .catalog-section{display:none}
  .category-tabs{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:16px}
  .category-tab{padding:8px 16px;border:1px solid #ddd;border-radius:20px;background:#fff;cursor:pointer;font-size:13px}
  .category-tab.active{background:#2c5f2d;color:#fff;border-color:#2c5f2d}
  .plant-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
  .plant-list-item{border:1px solid #ddd;border-radius:10px;padding:10px;text-align:center;cursor:pointer;transition:all 0.2s}
  .plant-list-item:hover{border-color:#2c5f2d;background:#f9fff9}
  .plant-list-item img{width:60px;height:60px;border-radius:8px;object-fit:cover;margin-bottom:6px}
  .plant-list-item .name{font-size:13px;font-weight:500}

  /* Navigation */
  .nav-back{display:inline-flex;align-items:center;gap:6px;color:#666;text-decoration:none;font-size:14px;margin-bottom:16px}
  .nav-back:hover{color:#2c5f2d}

  /* Mock mode banner */
  .mock-banner{background:#fff3cd;border:1px solid #ffc107;color:#856404;padding:10px 16px;border-radius:8px;margin-bottom:16px;font-size:13px}

  /* Status badge */
  .status-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:13px;font-weight:600}
  .status-timer{background:#e3f2fd;color:#1976d2}
  .status-sensor{background:#fff3e0;color:#f57c00}
  .status-off{background:#fce4ec;color:#c2185b}
  .status-active{background:#e0f7fa;color:#00838f}
  .mono{font-family:ui-monospace,monospace}
</style>
</head>
<body>
<div class="header">
  <div>
    <h1 id="device-id-header" style="margin:0;font-size:15px">üå± Polivalka</h1>
    <div style="font-size:13px">üìç <span id="location-text">‚Äî</span> / <span id="room-text">‚Äî</span><span id="custom-name-suffix"></span></div>
    <div style="font-size:11px;margin-top:4px"><span id="battery-status">üîã ‚Äî</span> ¬∑ <span id="header-state">üí§ Standby</span></div>
  </div>
  <div class="header-info">
    <div id="header-time" class="mono" style="font-size:11px">--:--</div>
    <div style="font-size:11px" id="header-mode"><span id="mode-badge" class="status-badge status-off">Off</span></div>
    <div style="font-size:11px" id="header-conn">üì° <span id="conn-text">Offline</span></div>
  </div>
</div>
<div class="nav">
  <a href="fleet.html">Fleet</a>
  <a href="home.html">Home</a>
  <a href="identify.html" class="active" style="background:#e8f5e9">üå± Plant</a>
  <a href="timer.html">Timer</a>
  <a href="sensor.html">Sensor</a>
  <a href="settings.html">Settings</a>
  <a href="calibration.html">Calibration</a>
  <a href="online.html">Online</a>
  <a href="trends.html">Trends</a>
  <a href="update.html">Update</a>
  <a href="admin.html" id="admin-nav-link" style="display:none">Admin</a>
</div>

<div class="container">
  <!-- API Status Banner (hidden when working) -->
  <div class="mock-banner" id="mock-banner" style="display:none">
    <strong>Demo Mode:</strong> API not available. Using sample data.
  </div>

  <!-- Step 1: Upload -->
  <div id="step-upload" class="card">
    <h2 style="margin-top:0">Identify Your Plant</h2>

    <div class="upload-area" id="upload-area">
      <div class="upload-icon">üì∑</div>
      <div class="upload-text">Drag & drop a photo or click to upload</div>
      <div class="upload-hint">Supports JPG, PNG (max 5MB)</div>
      <div class="upload-buttons">
        <button type="button" class="primary" onclick="document.getElementById('file-input').click()">
          üìÅ Choose File
        </button>
        <button type="button" class="secondary" id="camera-btn" onclick="openCamera()">
          üì∑ Take Photo
        </button>
      </div>
    </div>

    <input type="file" id="file-input" accept="image/jpeg,image/png,image/heic,image/heif,image/webp,image/*" style="display:none" multiple>
    <input type="file" id="camera-input" accept="image/*" capture="environment" style="display:none">

    <p class="muted" style="font-size:11px;margin:8px 0 0;text-align:center">
      JPG, PNG, HEIC, WebP ‚Ä¢ Max 20MB
    </p>

    <div class="preview-area" id="preview-area"></div>

    <div id="gdpr-section" style="display:none;margin:16px 0;padding:10px 12px;background:#e3f2fd;border-radius:8px;font-size:12px;color:#1565c0">
      ‚ÑπÔ∏è Photo will be sent to PlantNet.org for identification
    </div>

    <button class="primary" id="identify-btn" onclick="identifyPlant()" disabled style="width:100%;margin-top:16px">
      Identify Plant
    </button>
  </div>

  <!-- Loading -->
  <div id="loading" class="card loading" style="display:none">
    <div class="spinner"></div>
    <div id="loading-text">Analyzing your plant...</div>
  </div>

  <!-- Error -->
  <div id="error" class="error-message" style="display:none"></div>

  <!-- Step 2: Results -->
  <div id="step-results" class="card results-section">
    <a href="#" class="nav-back" onclick="goBack();return false">‚Üê Back</a>
    <h2 style="margin-top:0">Similar Plants</h2>
    <p class="muted">Select the plant that matches yours:</p>

    <div id="results-list"></div>

    <div class="manual-search">
      <p class="muted">Not found? Search by name:</p>
      <input type="text" id="manual-search-input" placeholder="Enter plant name...">
      <button class="secondary" onclick="searchByName()">Search</button>
    </div>
  </div>

  <!-- Step 3: Plant Card -->
  <div id="step-card" class="card plant-card">
    <a href="#" class="nav-back" onclick="goBackToResults();return false">‚Üê Back to results</a>

    <div class="plant-card-header">
      <img class="plant-card-photo" id="card-photo" src="" alt="">
      <div class="plant-card-info">
        <div class="plant-card-name" id="card-name">-</div>
        <div class="plant-card-scientific" id="card-scientific">-</div>
        <div class="plant-card-names" id="card-names">-</div>
      </div>
    </div>

    <!-- Safety Warning (CRITICAL - show first!) -->
    <div id="safety-section" class="care-section" style="display:none">
      <h4 style="color:#c62828">Safety Warning</h4>
      <div class="care-grid">
        <div class="care-item" id="toxic-humans-item" style="display:none;background:#ffebee">
          <span class="care-label">Humans</span>
          <span class="care-value" id="toxic-humans" style="color:#c62828">-</span>
        </div>
        <div class="care-item" id="toxic-pets-item" style="display:none;background:#ffebee">
          <span class="care-label">Pets</span>
          <span class="care-value" id="toxic-pets" style="color:#c62828">-</span>
        </div>
      </div>
    </div>

    <!-- Plant Info -->
    <div id="info-section" class="care-section" style="display:none">
      <h4>Plant Info</h4>
      <div class="care-grid">
        <div class="care-item" id="size-item" style="display:none">
          <span class="care-label">Mature Size</span>
          <span class="care-value" id="plant-size">-</span>
        </div>
        <div class="care-item" id="growth-item" style="display:none">
          <span class="care-label">Growth Rate</span>
          <span class="care-value" id="growth-rate">-</span>
        </div>
        <div class="care-item" id="cycle-item" style="display:none">
          <span class="care-label">Life Cycle</span>
          <span class="care-value" id="life-cycle">-</span>
        </div>
        <div class="care-item" id="difficulty-item" style="display:none">
          <span class="care-label">Difficulty</span>
          <span class="care-value" id="care-difficulty">-</span>
        </div>
        <div class="care-item" id="hardiness-item" style="display:none">
          <span class="care-label">Hardiness Zone</span>
          <span class="care-value" id="hardiness-zone">-</span>
        </div>
        <div class="care-item" id="indoor-item" style="display:none">
          <span class="care-label">Indoor</span>
          <span class="care-value" id="indoor-suitable">-</span>
        </div>
      </div>
    </div>

    <div class="care-section">
      <h4>Care Recommendations</h4>
      <div class="care-grid">
        <div class="care-item">
          <span class="care-label">Watering</span>
          <span class="care-value" id="care-watering">-</span>
        </div>
        <div class="care-item">
          <span class="care-label">Soil Moisture</span>
          <span class="care-value" id="care-moisture">-</span>
        </div>
        <div class="care-item">
          <span class="care-label">Light</span>
          <span class="care-value" id="care-light">-</span>
        </div>
        <div class="care-item">
          <span class="care-label">Air Temperature</span>
          <span class="care-value" id="care-temp">-</span>
        </div>
        <div class="care-item">
          <span class="care-label">Air Humidity</span>
          <span class="care-value" id="care-humidity">-</span>
        </div>
      </div>
    </div>

    <!-- Propagation & Maintenance -->
    <div id="propagation-section" class="care-section" style="display:none">
      <h4>Propagation & Maintenance</h4>
      <div class="care-grid">
        <div class="care-item" id="propagation-item" style="display:none">
          <span class="care-label">Propagation</span>
          <span class="care-value" id="propagation-methods">-</span>
        </div>
        <div class="care-item" id="pruning-item" style="display:none">
          <span class="care-label">Pruning</span>
          <span class="care-value" id="pruning-months">-</span>
        </div>
        <div class="care-item" id="soil-item" style="display:none">
          <span class="care-label">Soil</span>
          <span class="care-value" id="soil-type">-</span>
        </div>
        <div class="care-item" id="pests-item" style="display:none">
          <span class="care-label">Pests</span>
          <span class="care-value" id="pest-info">-</span>
        </div>
      </div>
    </div>

    <div class="care-section">
      <h4>Tips</h4>
      <ul class="tips-list" id="care-tips"></ul>
    </div>

    <div class="actions">
      <button class="primary" onclick="confirmPlant()" style="width:100%;padding:14px;font-size:16px">
        ‚úì Use This Plant
      </button>
    </div>
  </div>

  <!-- Catalog Fallback -->
  <div id="step-catalog" class="card catalog-section">
    <a href="#" class="nav-back" onclick="goBack();return false">‚Üê Back</a>
    <h2 style="margin-top:0">Browse Plant Catalog</h2>

    <div class="category-tabs" id="category-tabs"></div>
    <div class="plant-list" id="plant-list"></div>
  </div>
</div>

<script>
// ============ Configuration ============
const CONFIG = {
  // API is now proxied through our Lambda (keys are server-side)
  mockMode: false,

  // Our API endpoint (Lambda handles PlantNet/Perenual keys securely)
  apiUrl: 'https://p0833p2v29.execute-api.eu-central-1.amazonaws.com'
};

// ============ Toxic Plant Families (Source: ASPCA Poison Control) ============
// Fallback when Perenual doesn't have the plant
// Family-based toxicity (ASPCA data)
// Format: WHO affected, WHAT part, HOW serious, WHAT to do
const TOXIC_FAMILIES = {
  // Schefflera, Ivy, Fatsia
  'Araliaceae': { pets: true, humans: true, note: 'Sap causes skin rash. If pet chews leaves: drooling, vomiting. Wash hands after pruning' },
  // Philodendron, Pothos, Monstera, Dieffenbachia, Alocasia
  'Araceae': { pets: true, humans: true, note: 'All parts cause mouth/throat swelling if chewed. Cats/dogs: drooling, pawing at mouth. Call vet if swelling severe' },
  // Lilies - CATS SPECIFICALLY!
  'Liliaceae': { pets: true, humans: false, note: 'üö® CATS: Even pollen can cause kidney failure within 24-72h. Dogs less affected. If cat contacts lily - VET IMMEDIATELY' },
  // Tomatoes, Peppers, Nightshades
  'Solanaceae': { pets: true, humans: false, note: 'Ripe fruits safe to eat. Green parts (leaves, stems, unripe) toxic to pets - vomiting, weakness' },
  // Amaryllis, Daffodils, Snowdrops
  'Amaryllidaceae': { pets: true, humans: true, note: 'Bulbs most dangerous. If pet digs/chews bulb: vomiting, tremors, low blood pressure. Keep bulbs out of reach' },
  // Oleander, Periwinkle, Hoya
  'Apocynaceae': { pets: true, humans: true, note: 'Contains cardiac glycosides. If ingested: heart rhythm problems. Small amounts = vet visit' },
  // Kalanchoe, Sedum, Echeveria
  'Crassulaceae': { pets: true, humans: false, note: 'Pets only: causes vomiting, diarrhea, rarely heart issues. Humans safe to handle' },
  // Rhododendrons, Azaleas
  'Ericaceae': { pets: true, humans: true, note: 'All parts toxic. Even honey from flowers! Causes vomiting, weakness, heart issues. Keep away from pets' },
  // Croton, Poinsettia, Euphorbia
  'Euphorbiaceae': { pets: true, humans: true, note: 'Milky sap irritates skin/eyes. Wear gloves when pruning. If in eyes - rinse 15 min with water' },
  // Cycads (Sago Palm)
  'Cycadaceae': { pets: true, humans: true, note: 'üö® VERY TOXIC - seeds especially. Dogs love to chew them. Causes liver failure. VET IMMEDIATELY if ingested' },
  // Sago Palm, Zamia (same as Cycadaceae)
  'Zamiaceae': { pets: true, humans: true, note: 'üö® VERY TOXIC - seeds especially. Dogs love to chew them. Causes liver failure. VET IMMEDIATELY if ingested' },
  // Hellebores, Buttercups, Ranunculus
  'Ranunculaceae': { pets: true, humans: true, note: 'Sap causes skin blisters. If eaten: mouth pain, vomiting. Wear gloves when handling' },
  // Foxglove (Digitalis)
  'Plantaginaceae': { pets: true, humans: true, note: 'üö® Source of heart medication. Even small amounts affect heart rhythm. Keep away from children and pets' },
  // Chrysanthemums, Daisies
  'Asteraceae': { pets: true, humans: false, note: 'Pets: skin irritation, vomiting if eaten. Humans safe. Contains natural insecticides' },
  // Ficus, Fig, Rubber plant
  'Moraceae': { pets: true, humans: true, note: 'Sap irritates skin. Pets: drooling, vomiting if leaves chewed. Wash hands after pruning' },
  // Asparagus fern, Dracaena, Yucca
  'Asparagaceae': { pets: true, humans: false, note: 'Berries toxic to pets - vomiting, diarrhea. Sap may irritate human skin. Keep berries away from pets' }
};

// ============ Header Update (same as home.html) ============
async function updateStatus() {
  try {
    const s = await API.get('/status');

    // Time is handled by universal clock in common.js

    // Battery
    const batteryStatus = document.getElementById('battery-status');
    if (s.battery && s.battery.percent !== null && s.battery.percent !== undefined) {
      const percent = Math.round(s.battery.percent);
      const charging = s.battery.charging ? ' ‚ö°' : '';
      batteryStatus.textContent = `üîã ${percent}%${charging}`;
    } else {
      batteryStatus.textContent = '‚ö° AC';
    }

    // Device ID
    if (IS_CLOUD && DEVICE_ID) {
      document.getElementById('device-id-header').textContent = 'üå± ' + DEVICE_ID;
    }

    // Location and Room
    if (s.system_state?.location) {
      document.getElementById('location-text').textContent = s.system_state.location;
    }
    if (s.system_state?.room) {
      document.getElementById('room-text').textContent = s.system_state.room;
    }

    // Custom name
    let customName = s.system_state?.device_name || 'Plant';
    if (customName === 'Polivalka' || customName.toLowerCase().startsWith('polivalka-')) {
      customName = 'Plant';
    }
    document.getElementById('custom-name-suffix').textContent = ' / ' + customName;

    // State
    const rawState = s.system_state?.state || 'OFF';
    const displayState = mapStateToDisplay(rawState, s.pump_running);
    document.getElementById('header-state').textContent = `${displayState.emoji} ${displayState.text}`;

    // Mode badge
    const mode = s.system_state?.mode || 'off';
    const modeBadge = document.getElementById('mode-badge');
    modeBadge.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
    modeBadge.className = 'status-badge status-' + mode;

    // Connection
    const connText = document.getElementById('conn-text');
    connText.textContent = s.online ? 'Online' : 'Offline';
    connText.style.color = s.online ? '#0a0' : '#999';

  } catch (e) {
    console.error('[Identify] Status error:', e);
  }
}

// Load on start, refresh every 5 sec
updateStatus();
setInterval(updateStatus, 5000);

// ============ State ============
let selectedFiles = [];
let identificationResults = [];
let selectedPlant = null;
let selectedResult = null;  // Full API result with details

// ============ Mock Data ============
const MOCK_RESULTS = [
  {
    id: 'schefflera',
    scientific: 'Schefflera arboricola',
    commonNames: ['Umbrella tree', 'Dwarf umbrella tree'],
    score: 94.2,
    images: ['https://upload.wikimedia.org/wikipedia/commons/thumb/f/f9/Schefflera_arboricola_3.jpg/220px-Schefflera_arboricola_3.jpg']
  },
  {
    id: 'ficus_benjamina',
    scientific: 'Ficus benjamina',
    commonNames: ['Weeping fig', 'Benjamin fig'],
    score: 3.8,
    images: ['https://upload.wikimedia.org/wikipedia/commons/thumb/6/68/Ficus_benjamina2.jpg/220px-Ficus_benjamina2.jpg']
  },
  {
    id: 'dracaena',
    scientific: 'Dracaena marginata',
    commonNames: ['Dragon tree'],
    score: 1.2,
    images: ['https://upload.wikimedia.org/wikipedia/commons/thumb/2/2d/Dracaena_marginata.jpg/220px-Dracaena_marginata.jpg']
  }
];

const PLANTS_DATABASE = {
  schefflera: {
    id: 'schefflera',
    scientific: 'Schefflera arboricola',
    names: { en: 'Umbrella tree', de: 'Strahlenaralie', ru: '–®–µ—Ñ—Ñ–ª–µ—Ä–∞' },
    category: 'standard',
    care: {
      preset: 'Standard',
      start_pct: 30,
      stop_pct: 50,
      watering_days: '7',
      sunlight: 'part_shade',
      temp_min: 15,
      temp_max: 25
    },
    tips: [
      'Better to underwater than overwater',
      'Water should not stagnate',
      'Prefers bright indirect light'
    ],
    photos: ['https://upload.wikimedia.org/wikipedia/commons/thumb/f/f9/Schefflera_arboricola_3.jpg/220px-Schefflera_arboricola_3.jpg']
  },
  sansevieria: {
    id: 'sansevieria',
    scientific: 'Sansevieria trifasciata',
    names: { en: 'Snake plant', de: 'Bogenhanf', ru: '–°–∞–Ω—Å–µ–≤–∏–µ—Ä–∏—è' },
    category: 'succulents',
    care: {
      preset: 'Succulents',
      start_pct: 15,
      stop_pct: 25,
      watering_days: '10-14',
      sunlight: 'full_sun_to_part_shade',
      temp_min: 15,
      temp_max: 27
    },
    tips: [
      'Better to underwater than overwater',
      'Do not allow water to stagnate',
      'Reduce watering in winter'
    ],
    photos: ['https://upload.wikimedia.org/wikipedia/commons/thumb/7/7f/Snake_Plant_%28Sansevieria_trifasciata_%27Laurentii%27%29.jpg/220px-Snake_Plant_%28Sansevieria_trifasciata_%27Laurentii%27%29.jpg']
  }
};

const CATEGORIES = {
  succulents: { name: 'Succulents', preset: 'Succulents', start_pct: 15, stop_pct: 25 },
  standard: { name: 'Standard', preset: 'Standard', start_pct: 35, stop_pct: 55 },
  tropical: { name: 'Tropical', preset: 'Tropical', start_pct: 55, stop_pct: 75 },
  herbs: { name: 'Herbs', preset: 'Herbs', start_pct: 30, stop_pct: 45 }
};

// ============ Init ============
document.addEventListener('DOMContentLoaded', function() {
  // Hide mock banner if API keys configured
  if (!CONFIG.mockMode) {
    document.getElementById('mock-banner').style.display = 'none';
  }

  // Setup file input
  const fileInput = document.getElementById('file-input');
  fileInput.addEventListener('change', handleFileSelect);

  // Setup camera input
  const cameraInput = document.getElementById('camera-input');
  cameraInput.addEventListener('change', handleFileSelect);

  // Setup drag & drop
  const uploadArea = document.getElementById('upload-area');
  uploadArea.addEventListener('dragover', handleDragOver);
  uploadArea.addEventListener('dragleave', handleDragLeave);
  uploadArea.addEventListener('drop', handleDrop);

  // Check camera availability
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    document.getElementById('camera-btn').style.display = 'none';
  }

  console.log('[Identify] Page initialized, mockMode:', CONFIG.mockMode);
});

// ============ File Handling ============
function handleDragOver(e) {
  e.preventDefault();
  e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
  e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('dragover');

  const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
  addFiles(files);
}

function handleFileSelect(e) {
  const files = Array.from(e.target.files);
  addFiles(files);
  e.target.value = ''; // Reset for re-selection
}

function addFiles(files) {
  // Max 5 files
  const remaining = 5 - selectedFiles.length;
  const toAdd = files.slice(0, remaining);

  toAdd.forEach(file => {
    // Validate file size (max 20MB)
    if (file.size > 20 * 1024 * 1024) {
      showToast('File too large (max 20MB)', 'warning');
      return;
    }

    // Validate file type (early rejection of non-images)
    const isImage = file.type.startsWith('image/') ||
                    file.name.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|heic|heif|bmp)$/);
    if (!isImage) {
      showToast('Please select an image file', 'warning');
      return;
    }

    selectedFiles.push(file);
  });

  updatePreview();
  updateIdentifyButton();
}

function removeFile(index) {
  selectedFiles.splice(index, 1);
  updatePreview();
  updateIdentifyButton();
}

function updatePreview() {
  const container = document.getElementById('preview-area');
  container.innerHTML = '';

  selectedFiles.forEach((file, index) => {
    const div = document.createElement('div');
    div.className = 'preview-item';

    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);

    const btn = document.createElement('button');
    btn.className = 'remove-btn';
    btn.textContent = '√ó';
    btn.onclick = () => removeFile(index);

    div.appendChild(img);
    div.appendChild(btn);
    container.appendChild(div);
  });

  // Show GDPR checkbox if files selected
  document.getElementById('gdpr-section').style.display = selectedFiles.length > 0 ? 'flex' : 'none';
}

function updateIdentifyButton() {
  const btn = document.getElementById('identify-btn');
  btn.disabled = selectedFiles.length === 0;
}

function openCamera() {
  document.getElementById('camera-input').click();
}

// ============ Plant Identification ============
async function identifyPlant() {
  if (selectedFiles.length === 0) return;

  showStep('loading');
  hideError();

  try {
    // Convert image to base64
    const imageFile = selectedFiles[0];
    const base64Image = await fileToBase64(imageFile);

    // Call our secure API (keys are server-side)
    const response = await fetch(`${CONFIG.apiUrl}/plants/identify`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ image: base64Image })
    });

    const data = await response.json();

    if (!response.ok || !data.success) {
      throw new Error(data.error || 'Identification failed');
    }

    let results = data.results || [];

    if (results.length === 0) {
      showError('Could not identify the plant. Try a different photo.');
      showStep('upload');
      return;
    }

    // Filter low confidence results
    results = results.filter(r => r.score >= 1);

    if (results.length === 0) {
      showError('No confident matches found. Try a clearer photo of the leaves.');
      showStep('upload');
      return;
    }

    identificationResults = results;
    renderResults(results);
    showStep('results');

  } catch (err) {
    console.error('Identification error:', err);
    showError('Error identifying plant: ' + err.message);
    showStep('upload');
  }
}

// Lazy load heic2any library for Windows/Linux HEIC support
let heic2anyLoaded = false;
async function loadHeic2Any() {
  if (heic2anyLoaded) return;
  await new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js';
    script.onload = () => { heic2anyLoaded = true; resolve(); };
    script.onerror = () => reject(new Error('Failed to load HEIC converter'));
    document.head.appendChild(script);
  });
}

// Check if file is HEIC format
function isHEICFile(file) {
  return file.type === 'image/heic' || file.type === 'image/heif' ||
         file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif');
}

// Convert HEIC to JPEG blob using heic2any
async function convertHEIC(file) {
  console.log('[HEIC] Converting on Windows/Linux...');
  const loadingText = document.getElementById('loading-text');
  if (loadingText) loadingText.textContent = 'Converting HEIC format...';
  await loadHeic2Any();
  const blob = await heic2any({ blob: file, toType: 'image/jpeg', quality: 0.8 });
  if (loadingText) loadingText.textContent = 'Analyzing your plant...';
  console.log('[HEIC] Conversion done');
  return Array.isArray(blob) ? blob[0] : blob;
}

// Compress image using Canvas (max 1024px, JPEG 70%)
function compressWithCanvas(blob, fileName) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const objectUrl = URL.createObjectURL(blob);

    img.onload = () => {
      URL.revokeObjectURL(objectUrl);

      const MAX_SIZE = 1024;
      let width = img.width;
      let height = img.height;

      if (width > height && width > MAX_SIZE) {
        height = Math.round(height * MAX_SIZE / width);
        width = MAX_SIZE;
      } else if (height > MAX_SIZE) {
        width = Math.round(width * MAX_SIZE / height);
        height = MAX_SIZE;
      }

      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);

      const compressed = canvas.toDataURL('image/jpeg', 0.7);
      console.log(`[Compress] ${fileName}: ${img.width}x${img.height} ‚Üí ${width}x${height}, ~${Math.round(compressed.length/1024)}KB`);
      resolve(compressed);
    };

    img.onerror = () => {
      URL.revokeObjectURL(objectUrl);
      reject(new Error('Cannot read image'));
    };

    img.src = objectUrl;
  });
}

// Main function: convert file to base64 with compression
async function fileToBase64(file) {
  // Check file size (max 20MB raw)
  const MAX_FILE_SIZE = 20 * 1024 * 1024;
  if (file.size > MAX_FILE_SIZE) {
    throw new Error(`File too large (${Math.round(file.size/1024/1024)}MB). Max 20MB.`);
  }

  // Validate file type (security: reject non-images early)
  const allowedTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/heic', 'image/heif', 'image/gif', 'image/bmp'];
  const isHEIC = isHEICFile(file);
  const hasValidType = allowedTypes.includes(file.type) || isHEIC || file.type.startsWith('image/');

  if (!hasValidType && file.type) {
    console.warn(`[Security] Rejected file type: ${file.type}`);
    throw new Error(`Invalid file type (${file.type}). Please upload an image.`);
  }

  // Try native loading first
  try {
    return await compressWithCanvas(file, file.name);
  } catch (e) {
    // If native failed and it's HEIC, try heic2any converter (Windows/Linux)
    if (isHEIC) {
      try {
        const jpegBlob = await convertHEIC(file);
        return await compressWithCanvas(jpegBlob, file.name);
      } catch (heicError) {
        throw new Error('Cannot convert HEIC. Try converting to JPG first.');
      }
    }
    throw new Error('Cannot read image. Try JPG or PNG format.');
  }
}

// ============ Results Rendering ============
function renderResults(results) {
  const container = document.getElementById('results-list');
  container.innerHTML = '';

  results.forEach((result, index) => {
    const div = document.createElement('div');
    div.className = 'result-item';
    div.onclick = () => selectResult(index);

    let imagesHtml = '';
    if (result.images && result.images.length > 0) {
      imagesHtml = '<div class="result-images">' +
        result.images.map(url => `<img src="${url}" alt="" onerror="this.style.display='none'">`).join('') +
        '</div>';
    }

    // Show care preset badge
    const care = result.care || {};
    const presetBadge = care.preset ? `<span style="background:#e8f5e9;color:#2c5f2d;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:8px">${care.preset}</span>` : '';
    const familyInfo = result.family ? `<div style="font-size:11px;color:#888;margin-top:2px">Family: ${result.family}</div>` : '';

    div.innerHTML = `
      <div class="result-header">
        <input type="radio" name="result" class="result-radio" ${index === 0 ? 'checked' : ''}>
        <div class="result-info">
          <div class="result-name">${result.scientific}${presetBadge}</div>
          <div class="result-common">${result.commonNames.slice(0, 2).join(', ') || 'No common name'}</div>
          ${familyInfo}
          <div class="result-score">${result.score}% match${care.watering ? ' ‚Ä¢ ' + care.watering : ''}</div>
        </div>
      </div>
      ${imagesHtml}
    `;

    container.appendChild(div);
  });
}

function selectResult(index) {
  // Update UI
  document.querySelectorAll('.result-item').forEach((el, i) => {
    el.classList.toggle('selected', i === index);
    el.querySelector('.result-radio').checked = (i === index);
  });

  const result = identificationResults[index];
  showPlantCard(result);
}

// ============ Plant Card ============
function showPlantCard(result) {
  // Use care data from API (new format with family mapping)
  const apiCare = result.care || {};

  // Build plantData from API result
  const plantData = {
    id: result.id,
    scientific: result.scientific,
    family: result.family || 'Unknown',
    genus: result.genus || '',
    names: { en: result.commonNames[0] || result.scientific },
    care: {
      preset: apiCare.preset || 'Standard',
      start_pct: apiCare.start_pct || 35,
      stop_pct: apiCare.stop_pct || 55,
      watering: apiCare.watering || 'Every 7-10 days',
      light: apiCare.light || 'Bright indirect light'
    },
    photos: result.images || []
  };

  selectedPlant = plantData;
  selectedResult = result;  // Store full result for saveToProfile

  // Populate card
  document.getElementById('card-photo').src = plantData.photos[0] || '';
  document.getElementById('card-name').textContent = plantData.scientific;  // Scientific = primary
  document.getElementById('card-scientific').textContent = plantData.names.en || '';  // Common = secondary

  // Show family info
  const familyText = plantData.family ? `Family: ${plantData.family}` : '';
  document.getElementById('card-names').textContent = familyText;

  // Care info from API
  const care = plantData.care;
  document.getElementById('care-watering').textContent = care.watering;
  document.getElementById('care-moisture').textContent = `${care.start_pct}% - ${care.stop_pct}%`;
  document.getElementById('care-light').textContent = care.light;
  document.getElementById('care-temp').textContent = care.temperature || '18-24¬∞C';
  document.getElementById('care-humidity').textContent = care.humidity || 'Average (40-60%)';

  // Tips from API
  const tipsList = document.getElementById('care-tips');
  tipsList.innerHTML = `<li>${care.tips || 'Water when top inch of soil is dry.'}</li>`;

  // Detailed info from Perenual (if available)
  const details = result.details || {};

  // Safety section - CRITICAL
  const safetySection = document.getElementById('safety-section');
  const toxicHumansItem = document.getElementById('toxic-humans-item');
  const toxicPetsItem = document.getElementById('toxic-pets-item');
  let showSafety = false;

  // Show toxicity note as main warning (friendlier than "TOXIC")
  if (details.toxicity_note) {
    const noteEl = document.createElement('div');
    noteEl.style.cssText = 'font-size:12px;color:#e65100;background:#fff3e0;padding:8px 10px;border-radius:6px;margin-bottom:8px';
    let noteText = `‚ö†Ô∏è ${details.toxicity_note}`;
    if (details.poisonous_to_pets) noteText += ' ‚Ä¢ Keep away from pets';
    noteEl.textContent = noteText;
    safetySection.insertBefore(noteEl, safetySection.firstChild);
    showSafety = true;
  } else {
    // No note - show simple labels
    if (details.poisonous_to_humans === true) {
      toxicHumansItem.style.display = '';
      document.getElementById('toxic-humans').textContent = '‚ö†Ô∏è Caution';
      showSafety = true;
    } else if (details.poisonous_to_humans === false) {
      toxicHumansItem.style.display = '';
      toxicHumansItem.style.background = '#e8f5e9';
      document.getElementById('toxic-humans').textContent = '‚úì Safe';
      document.getElementById('toxic-humans').style.color = '#2e7d32';
      showSafety = true;
    }

    if (details.poisonous_to_pets === true) {
      toxicPetsItem.style.display = '';
      document.getElementById('toxic-pets').textContent = '‚ö†Ô∏è Keep away from pets';
      showSafety = true;
    } else if (details.poisonous_to_pets === false) {
      toxicPetsItem.style.display = '';
      toxicPetsItem.style.background = '#e8f5e9';
      document.getElementById('toxic-pets').textContent = '‚úì Safe';
      document.getElementById('toxic-pets').style.color = '#2e7d32';
      showSafety = true;
    }
  }

  // ============ Fallback: Check family toxicity if Lambda didn't have data ============
  if (!showSafety && plantData.family) {
    const familyToxicity = TOXIC_FAMILIES[plantData.family];
    if (familyToxicity && familyToxicity.note) {
      const noteEl = document.createElement('div');
      noteEl.style.cssText = 'font-size:12px;color:#e65100;background:#fff3e0;padding:8px 10px;border-radius:6px;margin-bottom:8px';
      let noteText = `‚ö†Ô∏è ${familyToxicity.note}`;
      if (familyToxicity.pets) noteText += ' ‚Ä¢ Keep away from pets';
      noteEl.textContent = noteText;
      safetySection.insertBefore(noteEl, safetySection.firstChild);
      showSafety = true;
      console.log(`[Identify] Toxicity from family ${plantData.family}:`, familyToxicity);
    }
  }

  safetySection.style.display = showSafety ? '' : 'none';

  // Plant info section
  const infoSection = document.getElementById('info-section');
  let showInfo = false;

  if (details.dimension) {
    document.getElementById('size-item').style.display = '';
    document.getElementById('plant-size').textContent = details.dimension;
    showInfo = true;
  }
  if (details.growth_rate) {
    document.getElementById('growth-item').style.display = '';
    document.getElementById('growth-rate').textContent = capitalize(details.growth_rate);
    showInfo = true;
  }
  if (details.cycle) {
    document.getElementById('cycle-item').style.display = '';
    document.getElementById('life-cycle').textContent = capitalize(details.cycle);
    showInfo = true;
  }
  if (details.care_level) {
    document.getElementById('difficulty-item').style.display = '';
    document.getElementById('care-difficulty').textContent = capitalize(details.care_level);
    showInfo = true;
  }
  if (details.hardiness_min || details.hardiness_max) {
    document.getElementById('hardiness-item').style.display = '';
    const zone = details.hardiness_min === details.hardiness_max
      ? `Zone ${details.hardiness_min}`
      : `Zone ${details.hardiness_min}-${details.hardiness_max}`;
    document.getElementById('hardiness-zone').textContent = zone;
    showInfo = true;
  }
  if (details.indoor !== undefined) {
    document.getElementById('indoor-item').style.display = '';
    document.getElementById('indoor-suitable').textContent = details.indoor ? '‚úì Yes' : 'Outdoor only';
    showInfo = true;
  }
  infoSection.style.display = showInfo ? '' : 'none';

  // Propagation section
  const propSection = document.getElementById('propagation-section');
  let showProp = false;

  if (details.propagation && details.propagation.length > 0) {
    document.getElementById('propagation-item').style.display = '';
    document.getElementById('propagation-methods').textContent = details.propagation.slice(0,3).join(', ');
    showProp = true;
  }
  if (details.pruning_month && details.pruning_month.length > 0) {
    document.getElementById('pruning-item').style.display = '';
    document.getElementById('pruning-months').textContent = details.pruning_month.slice(0,3).join(', ');
    showProp = true;
  }
  if (details.soil && details.soil.length > 0) {
    document.getElementById('soil-item').style.display = '';
    document.getElementById('soil-type').textContent = Array.isArray(details.soil) ? details.soil.join(', ') : details.soil;
    showProp = true;
  }
  if (details.pest_susceptibility) {
    document.getElementById('pests-item').style.display = '';
    document.getElementById('pest-info').textContent = details.pest_susceptibility;
    showProp = true;
  }
  propSection.style.display = showProp ? '' : 'none';

  showStep('card');
}

function capitalize(str) {
  if (!str) return '';
  return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}

function getPresetTips(preset) {
  const tips = {
    'Succulents': [
      'Let soil dry completely between waterings',
      'Overwatering is the #1 killer - when in doubt, wait',
      'Needs good drainage - use cactus soil mix'
    ],
    'Standard': [
      'Water when top inch of soil is dry',
      'Most forgiving category for beginners',
      'Avoid direct hot afternoon sun'
    ],
    'Tropical': [
      'Keep soil consistently moist but not soggy',
      'Mist leaves regularly or use a humidifier',
      'Protect from cold drafts and dry air'
    ],
    'Herbs': [
      'Keep soil consistently moist',
      'Needs 6+ hours of sunlight',
      'Harvest regularly to promote growth'
    ]
  };
  return tips[preset] || tips['Standard'];
}

function formatSunlight(sunlight) {
  const map = {
    'full_sun': 'Full sun',
    'part_shade': 'Partial shade',
    'full_sun_to_part_shade': 'Sun to partial shade',
    'shade': 'Shade'
  };
  return map[sunlight] || sunlight || 'Moderate';
}

// ============ Actions ============

// Main action: Show confirmation, then Apply + Save + Redirect
async function confirmPlant() {
  if (!selectedPlant || !selectedResult) return;

  const deviceId = getDeviceId();
  if (!deviceId) {
    showToast('No device selected. Go to Fleet first.', 'warning');
    return;
  }

  const care = selectedPlant.care;
  const plantName = selectedPlant.scientific;  // Scientific name - universal across all languages

  // Check if auto-watering is enabled
  let autoWateringOn = false;
  try {
    const status = await API.get('/sensor/controller/status');
    autoWateringOn = status.state && status.state !== 'DISABLED';
  } catch (e) {
    console.log('Could not check auto-watering status');
  }

  // Build confirmation message
  let message = `Binding "${plantName}" to this device:\n\n`;
  message += `‚Ä¢ Device name will change to "${plantName}"\n`;
  message += `‚Ä¢ Sensor mode will use ${care.start_pct}-${care.stop_pct}% moisture range\n`;

  if (autoWateringOn) {
    message += `\n‚ö†Ô∏è AUTO-WATERING IS ON!\n`;
    message += `Watering may start immediately if soil moisture is below ${care.start_pct}%.\n`;
  }

  message += `\nContinue?`;

  // Show confirmation
  if (!confirm(message)) {
    return;
  }

  // User confirmed - proceed
  const btn = document.querySelector('.actions button.primary');
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Saving...';

  try {
    // 1. Apply watering settings to device
    await API.post('/command', {
      command: 'set_sensor_preset',
      params: {
        preset: care.preset,
        start_pct: care.start_pct,
        stop_pct: care.stop_pct
      }
    });

    // 2. Update device name to plant name
    await API.post('/info', {
      name: plantName
    });

    // 3. Save plant to profile
    await saveToProfile();

    // 4. Success - redirect to home
    btn.textContent = '‚úì Saved!';
    showToast('Plant bound to device!', 'success');

    setTimeout(() => {
      window.location.href = `home.html?device=${deviceId}`;
    }, 1500);

  } catch (err) {
    console.error('Confirm error:', err);
    showToast('Error: ' + err.message, 'error');
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

async function applyToDevice() {
  if (!selectedPlant) return;

  const deviceId = getDeviceId();
  if (!deviceId) {
    showToast('No device selected. Go to Fleet and select a device first.', 'warning');
    return;
  }

  const care = selectedPlant.care;

  try {
    // Send command to device via existing API
    await apiCall('command', {
      device_id: deviceId,
      command: 'set_sensor_preset',
      params: {
        preset: care.preset,
        start_pct: care.start_pct,
        stop_pct: care.stop_pct
      }
    });

    showToast(`Applied ${care.preset} preset (${care.start_pct}%-${care.stop_pct}%)`, 'success');

    // Also save plant to device profile
    await saveToProfile();

  } catch (err) {
    console.error('Apply error:', err);
    showToast('Error applying settings: ' + err.message, 'error');
  }
}

async function saveToProfile() {
  if (!selectedPlant || !selectedResult) return;

  const deviceId = getDeviceId();
  if (!deviceId) {
    showToast('Select a device first', 'warning');
    return;
  }

  const details = selectedResult.details || {};
  const care = selectedResult.care || {};

  // Build plant data for API
  const plantData = {
    scientific: selectedPlant.scientific,
    common_name: selectedPlant.names?.en || selectedPlant.scientific,
    family: selectedPlant.family,
    preset: care.preset || 'standard',
    start_pct: care.start_pct || 35,
    stop_pct: care.stop_pct || 55,
    // Safety info from Perenual
    poisonous_to_humans: details.poisonous_to_humans,
    poisonous_to_pets: details.poisonous_to_pets,
    // Additional details
    hardiness_zone: details.hardiness_min && details.hardiness_max
      ? `${details.hardiness_min}-${details.hardiness_max}`
      : '',
    dimension: details.dimension || '',
    care_level: details.care_level || '',
    indoor: details.indoor,
    // Image URL (external, not blob)
    image_url: selectedPlant.photos?.[0] || ''
  };

  // ============ Fallback: Check family toxicity if Perenual didn't have data ============
  if (plantData.poisonous_to_pets === undefined && plantData.family) {
    const familyToxicity = TOXIC_FAMILIES[plantData.family];
    if (familyToxicity) {
      plantData.poisonous_to_pets = familyToxicity.pets;
      plantData.poisonous_to_humans = familyToxicity.humans;
      plantData.toxicity_source = 'family';  // Mark as family-based (not species-specific)
      plantData.toxicity_note = familyToxicity.note;
      console.log(`[Identify] Toxicity from family ${plantData.family}:`, familyToxicity);
    }
  }

  try {
    // Direct fetch - /plants/save is a global endpoint, not device-prefixed
    const url = `${CONFIG.apiUrl}/plants/save`;
    const headers = {
      'Content-Type': 'application/json',
      ...API.getAuthHeaders()
    };
    const response = await fetch(url, {
      method: 'POST',
      headers,
      body: JSON.stringify({ device_id: deviceId, plant: plantData })
    });
    const data = await response.json();

    if (data.success) {
      showToast('Plant saved to profile!', 'success');
    } else {
      throw new Error(data.error || 'Save failed');
    }

  } catch (err) {
    console.error('Save error:', err);
    const errorMsg = err.message || 'Failed to save';

    // Handle specific errors
    if (errorMsg.includes('already saved')) {
      showToast('This plant is already saved', 'warning');
    } else if (errorMsg.includes('limit reached')) {
      showToast('Plant limit reached (20). Delete some plants.', 'warning');
    } else if (errorMsg.includes('Rate limit')) {
      showToast('Too many saves. Wait a bit.', 'warning');
    } else {
      showToast(errorMsg, 'error');
    }
  }
}


// ============ Navigation ============
function showStep(step) {
  document.getElementById('step-upload').style.display = step === 'upload' ? 'block' : 'none';
  document.getElementById('loading').style.display = step === 'loading' ? 'block' : 'none';
  document.getElementById('step-results').style.display = step === 'results' ? 'block' : 'none';
  document.getElementById('step-card').style.display = step === 'card' ? 'block' : 'none';
  document.getElementById('step-catalog').style.display = step === 'catalog' ? 'block' : 'none';

  if (step === 'results') {
    document.getElementById('step-results').classList.add('results-section');
    document.getElementById('step-results').style.display = 'block';
  }

  if (step === 'card') {
    document.getElementById('step-card').classList.add('visible');
  }
}

function goBack() {
  selectedFiles = [];
  updatePreview();
  updateIdentifyButton();
  identificationResults = [];
  selectedPlant = null;
  showStep('upload');
}

function goBackToResults() {
  showStep('results');
}

function showError(message) {
  const el = document.getElementById('error');
  el.textContent = message;
  el.style.display = 'block';
}

function hideError() {
  document.getElementById('error').style.display = 'none';
}

// ============ Helpers ============
function getDeviceId() {
  // Get from URL or localStorage
  const params = new URLSearchParams(window.location.search);
  return params.get('device') || localStorage.getItem('selected_device_id');
}

async function apiCall(endpoint, data) {
  // Use existing api-adapter.js if available
  if (typeof callCloudAPI === 'function') {
    return await callCloudAPI(endpoint, data);
  }

  // Fallback for mock mode
  console.log('[API Mock]', endpoint, data);
  return { success: true };
}

function searchByName() {
  const query = document.getElementById('manual-search-input').value.trim().toLowerCase();
  if (!query) return;

  // Search in local database
  const matches = Object.values(PLANTS_DATABASE).filter(p =>
    p.scientific.toLowerCase().includes(query) ||
    Object.values(p.names).some(n => n && n.toLowerCase().includes(query))
  );

  if (matches.length > 0) {
    identificationResults = matches.map(p => ({
      id: p.id,
      scientific: p.scientific,
      commonNames: Object.values(p.names).filter(Boolean),
      score: 100,
      images: p.photos
    }));
    renderResults(identificationResults);
  } else {
    showToast('No plants found. Try different keywords.', 'info');
  }
}

console.log('[Identify] Script loaded');
</script>
</body>
</html>
