# Plant Profile - Анализ и Планирование
**Дата:** 09.02.2026
**Статус:** Исследование перед разработкой
**Код заморожен:** Только баг-фиксы, никаких новых фич без явного решения

---

## 1. Проблема

При передаче устройства от разработчика к пользователю (или при смене растения):
- Пользователь видит **тестовые данные, графики, испытания** разработчика
- Нет механизма "чистого старта" для нового владельца/растения
- Нет архивации истории предыдущего растения

---

## 2. Текущее состояние кода

### 2.1 Что РАБОТАЕТ

| Компонент | Статус | Файл |
|-----------|--------|------|
| PlantNet интеграция | ✅ | api_handler.py:200-341 |
| UI идентификации растения | ✅ | identify.html |
| Маппинг семейство → пресет | ✅ | api_handler.py:344-422 |
| Обновление имени устройства | ✅ | identify.html:1160 |
| Применение пресета сенсора | ✅ | identify.html:1143-1157 |
| Предупреждения о токсичности | ✅ | identify.html |

### 2.2 Что НЕ РАБОТАЕТ (критично!)

| Компонент | Статус | Проблема |
|-----------|--------|----------|
| Сохранение профиля растения | ❌ | Endpoint `/plants/save` НЕ СУЩЕСТВУЕТ |
| Персистентность данных растения | ❌ | Данные теряются при перезагрузке страницы |
| Контекст растения в телеметрии | ❌ | Нельзя связать историю полива с конкретным растением |
| История смены растений | ❌ | Нет аудит-лога |
| Weekly aggregates по растениям | ❌ | Агрегаты только по устройству |

### 2.3 Критический баг

**identify.html:1273** вызывает `saveToProfile()` → `POST /plants/save` → **404 Not Found**

```javascript
// Этот код НИКОГДА не сохраняет данные:
async function saveToProfile() {
  const response = await fetch(`${CONFIG.apiUrl}/plants/save`, {...});
  // Endpoint не существует в Lambda!
}
```

**Результат:** Пользователь идентифицирует растение, всё красиво показывается, но при перезагрузке — пустота.

---

## 3. Сценарии использования

### Сценарий A: Переставляю устройство с кактуса на фикус

**Текущее поведение:**
1. Захожу в identify.html
2. Фотографирую фикус → PlantNet распознаёт
3. Нажимаю "Confirm" → имя устройства меняется на "Ficus elastica"
4. Пресет сенсора меняется на Standard (35-55%)
5. **Данные кактуса НЕ архивируются** — просто перезаписываются
6. Weekly aggregates продолжают накапливаться БЕЗ разделения по растениям
7. При просмотре графиков — **смешанные данные кактуса и фикуса**

**Ожидаемое поведение:**
1. Профиль "Кактус" архивируется с датой окончания
2. Создаётся новый профиль "Фикус" с датой начала
3. Телеметрия привязывается к конкретному профилю
4. Графики показывают данные только текущего растения
5. Можно посмотреть историю предыдущего растения

### Сценарий B: Передаю устройство пользователю

**Текущее поведение:**
1. Пользователь делает Claim device (вводит ID)
2. Устройство привязывается к его аккаунту
3. **Пользователь ВИДИТ:**
   - Мои тестовые данные за последние 7 дней (телеметрия)
   - Мои weekly aggregates (навсегда!)
   - Имя моего тестового растения
   - Мои настройки калибровки

**Ожидаемое поведение:**
1. При Claim — опция "Start Fresh" (очистить историю)
2. Или: автоматическая очистка при смене владельца
3. Новый пользователь начинает с чистого листа

### Сценарий C: Новый пользователь после Claim

**Текущее поведение:**
1. Заходит на Fleet → видит устройство
2. Заходит на Home → видит **моё** имя растения (если было)
3. Заходит на Trends → видит **мои** графики
4. Заходит на Activity → видит **мои** логи (7 дней)
5. Заходит на Plant (identify.html) → **пустая страница** (данные не сохранились)

**Ожидаемое поведение:**
1. Чистый старт или явное предупреждение о данных предыдущего владельца
2. Plant страница показывает сохранённый профиль растения
3. Возможность "Reset Device" для полной очистки

---

## 4. Структура данных

### 4.1 Текущая схема DynamoDB

```
polivalka_devices (PK: user_id, SK: device_id)
├─ device_id: "Polivalka-BB00C1"
├─ device_name: "Monstera" (просто строка)
├─ location: "Home"
├─ room: "Living Room"
└─ [НЕТ данных о растении]

polivalka_telemetry (PK: device_id, SK: timestamp)
├─ device_id: "Polivalka-BB00C1"
├─ timestamp: 1707500000
├─ sensor: {moisture: 45, adc: 1200}
├─ battery: {percent: 80}
└─ [НЕТ привязки к растению]
```

### 4.2 Предлагаемая схема (для обсуждения)

**Вариант A: Расширить polivalka_devices**

```
polivalka_devices
├─ device_id
├─ device_name
├─ current_plant: {
│     plant_id: "uuid",
│     scientific: "Monstera deliciosa",
│     common_name: "Swiss Cheese Plant",
│     family: "Araceae",
│     preset: "Tropical",
│     start_pct: 55,
│     stop_pct: 75,
│     image_url: "https://...",
│     bound_at: 1707500000
│   }
└─ plant_history: [
      {plant_id, scientific, bound_at, unbound_at},
      ...
    ]
```

**Вариант B: Отдельная таблица polivalka_plants**

```
polivalka_plants (PK: device_id, SK: plant_id)
├─ device_id: "Polivalka-BB00C1"
├─ plant_id: "uuid"
├─ scientific: "Monstera deliciosa"
├─ status: "active" | "archived"
├─ bound_at: timestamp
├─ unbound_at: timestamp | null
└─ telemetry_count: 1234
```

**Вариант C: Контекст в телеметрии**

```
polivalka_telemetry
├─ device_id
├─ timestamp
├─ plant_id: "uuid"  ← добавить
├─ plant_scientific: "Monstera"  ← добавить (для удобства запросов)
└─ sensor, battery, pump...
```

---

## 5. Вопросы для решения

### 5.1 Бизнес-логика

1. **Одно устройство = одно растение?** Или можно несколько активных?
2. **При смене растения:** архивировать старое или удалять?
3. **При Claim:** очищать историю предыдущего владельца или нет?
4. **Кто видит историю:** только владелец или любой кто Claim-ит?
5. **TTL для архивных профилей:** хранить вечно или 90 дней?

### 5.2 Технические

1. **Где хранить plant_id в телеметрии?** ESP32 отправляет → IoT Rule → DynamoDB
2. **Как ESP32 узнаёт plant_id?** Отправлять с каждым сообщением или добавлять в Lambda?
3. **Weekly aggregates:** разделять по растениям или оставить по устройствам?
4. **Миграция существующих данных:** нужна ли?

### 5.3 UX

1. **Где показывать историю растений?** Отдельная вкладка "Plant History"?
2. **Как переключаться между профилями?** (если храним историю)
3. **Предупреждение при смене растения:** "Вы уверены? Текущий профиль будет архивирован"
4. **Индикация "чужих" данных:** показывать что данные от предыдущего владельца?

---

## 6. Принцип бесплатности (AWS Free Tier)

Любое решение должно оставаться в рамках бесплатного тарифа:

| Ресурс | Free Tier | Текущее использование | После Plant Profile |
|--------|-----------|----------------------|---------------------|
| DynamoDB Storage | 25 GB | ~100 MB | ~150 MB (OK) |
| DynamoDB WCU | 25 | ~5 | ~7 (OK) |
| DynamoDB RCU | 25 | ~10 | ~12 (OK) |
| Lambda Invocations | 1M | ~50K | ~55K (OK) |

**Вывод:** Добавление Plant Profile не выводит за Free Tier.

---

## 7. Приоритизация

### Must Have (без этого нельзя)
1. [ ] Endpoint `/plants/save` — сохранение профиля растения
2. [ ] Plant данные в `polivalka_devices` — персистентность
3. [ ] Загрузка профиля при открытии identify.html/home.html

### Should Have (важно)
4. [ ] История смены растений (plant_history)
5. [ ] "Reset Device" при Claim (опционально)
6. [ ] Разделение weekly aggregates по plant_id

### Nice to Have (потом)
7. [ ] Привязка plant_id к каждой записи телеметрии
8. [ ] UI для просмотра истории растений
9. [ ] Экспорт данных по конкретному растению

---

## 8. Следующие шаги

1. **Принять решения** по вопросам раздела 5
2. **Выбрать схему данных** (Вариант A, B или C)
3. **Создать план реализации** с минимальным изменением кода
4. **Реализовать Must Have** (3 пункта)
5. **Тестирование сценариев** A, B, C
6. **Заморозить** после успешных тестов

---

## 9. Связанные файлы

- `/Users/maximshurygin/polivalka-web/identify.html` — UI идентификации
- `/Users/maximshurygin/polivalka-web/home.html` — Plant card
- `/Users/maximshurygin/polivalka-web/lambda/api_handler.py` — PlantNet API
- `/Users/maximshurygin/polivalka-web/lambda/weekly_aggregator.py` — агрегация

---

**Автор:** Claude Opus 4.5
**Дата создания:** 09.02.2026
