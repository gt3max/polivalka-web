<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"><title>PlantApp ‚Äî Schedule</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<script src="api-adapter.js"></script>
<script src="common.js"></script>
<style>
    body{font-family:system-ui,Arial;margin:0;padding:0;max-width:100%}
    .header{position:sticky;top:0;z-index:1000;background:#2c5f2d;color:#fff;padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .header h1{margin:0;font-size:18px}
    .header-info{font-size:12px;text-align:right;line-height:1.3}
    .nav{position:sticky;top:65px;z-index:999;background:#f0f0f0;padding:5px 8px;display:flex;gap:2px;border-bottom:1px solid #ddd;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch}
    .nav a{text-decoration:none;color:#333;padding:6px 8px;border-radius:6px;font-size:14px;flex-shrink:0}
    .nav a.active{background:#2c5f2d;color:#fff}
    .nav a:hover{background:#ddd}
    .container{padding:18px;max-width:760px}
    .card{border:1px solid #ddd;padding:16px;border-radius:12px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .mono{font-family:ui-monospace,monospace}
    button{padding:8px 12px;border-radius:8px;border:1px solid #888;background:#fafafa;cursor:pointer}
    button:disabled{opacity:0.5;cursor:not-allowed}
    button.danger{background:#ffebee;border-color:#c62828;color:#c62828}
    button.primary{background:#2c5f2d;color:#fff;border-color:#2c5f2d}
    input,select{padding:6px 10px;border:1px solid #ccc;border-radius:8px}
    .muted{color:#666;font-size:14px}
    .danger{color:#b00}
    .ok{color:#0a0}
    .status-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:13px;font-weight:600}
    .status-timer{background:#e3f2fd;color:#1976d2}
    .status-sensor{background:#fff3e0;color:#f57c00}
    .status-off{background:#fce4ec;color:#c2185b}
    .status-manual{background:#e0e0e0;color:#616161}
    .schedule-item{border:1px solid #e0e0e0;padding:12px;border-radius:8px;margin:8px 0;background:#fafafa}
    .schedule-item.disabled{opacity:0.6}
    .schedule-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .schedule-time{font-size:20px;font-weight:600}
    .schedule-days{margin:6px 0;font-size:14px}
    .day-btn{display:inline-block;width:32px;height:32px;line-height:32px;text-align:center;border:1px solid #ccc;border-radius:50%;margin:2px;cursor:pointer;background:#fff}
    .day-btn.active{background:#2c5f2d;color:#fff;border-color:#2c5f2d}
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:#fff;padding:20px;border-radius:12px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
  </style>
</head><body><div class="header"><div><h1 id="device-id-header" style="margin:0;font-size:15px">üå± Polivalka</h1><div style="font-size:13px">üìç <span id="location-text">‚Äî</span> / <span id="room-text">‚Äî</span><span id="custom-name-suffix"></span></div><div style="font-size:11px;margin-top:4px"><span id="battery-status">üîã ‚Äî</span> ¬∑ <span id="header-state">üí§ Standby</span></div></div><div class="header-info"><div id="header-time" class="mono" style="font-size:11px">--:--</div><div style="font-size:11px" id="header-mode"><span id="mode-badge" class="status-badge">‚Äî</span></div><div style="font-size:11px" id="header-conn">üì° <span id="conn-text">Offline</span></div></div></div></div><div class="nav"><a href="/">Fleet</a><a href="home.html">Home</a><a href="identify.html" style="background:#e8f5e9">üå± Plant</a><a href="timer.html" class="active">Timer</a><a href="sensor.html">Sensor</a><a href="settings.html">Settings</a><a href="calibration.html">Calibration</a><a href="online.html">Online</a><a href="trends.html">Trends</a><a href="ota.html">Update</a><a href="admin.html" id="admin-nav-link" style="display:none">Admin</a></div><div class="container"><div class="card"><h3>Timer Mode</h3><p class="muted">Water on a schedule. Add up to 8 schedules with specific days and times.</p><div class="row"><button id="add-schedule-btn" class="primary" onclick="showModalWithCheck()">+ Add Schedule</button><span id="schedule-limit-info" class="muted" style="margin-left:8px"></span></div></div><div class="card"><h3>Active Schedules <span id="schedule-count" class="muted" style="font-weight:400;font-size:14px"></span></h3><div id="schedules-list"><div class="muted">No schedules configured. Click "+ Add Schedule" to create one.</div></div></div></div><div id="modal" class="modal"><div class="modal-content"><h3 id="modal-title">Add Schedule</h3><div style="margin:12px 0"><label>Time</label><br><input id="edit-time" type="time" value="07:00" style="width:150px;font-size:16px"></div><div style="margin:12px 0"><label>Days</label><br><div id="days-selector" style="margin-top:8px"><span class="day-btn" data-day="1">M</span><span class="day-btn" data-day="2">T</span><span class="day-btn" data-day="3">W</span><span class="day-btn" data-day="4">T</span><span class="day-btn" data-day="5">F</span><span class="day-btn" data-day="6">S</span><span class="day-btn" data-day="7">S</span></div><button onclick="selectAllDays()" style="margin-top:8px;font-size:12px">Every day</button><button onclick="selectWeekdays()" style="margin-top:8px;font-size:12px">Weekdays</button></div><div style="margin:12px 0"><label>Duration</label><br><input id="edit-duration" type="number" min="1" max="999" value="30" style="width:100px;text-align:left;font-size:16px"><select id="edit-unit" style="width:100px"><option value="sec">seconds</option><option value="min">minutes</option><option value="hr">hours</option></select></div><div style="margin:12px 0"><label><input id="edit-enabled" type="checkbox" checked>
Enabled
</label></div><div class="row" style="margin-top:16px"><button class="primary" onclick="saveSchedule()">Save</button><button onclick="closeModal()">Cancel</button></div></div></div>
<script>
// Admin nav link handled by common.js showAdminNavLink()

let editingId = null;

async function loadSchedules(){
  try {
    const data = await API.get('/schedules');
    const list = document.getElementById('schedules-list');
    const count = data.schedules ? data.schedules.length : 0;
    const maxSchedules = 8;

    // Update counter
    document.getElementById('schedule-count').textContent = `(${count}/${maxSchedules})`;

    // Update limit info and button state
    const addBtn = document.getElementById('add-schedule-btn');
    const limitInfo = document.getElementById('schedule-limit-info');

    // Cloud mode: editing enabled via MQTT commands
    if (count >= maxSchedules) {
      addBtn.disabled = true;
      limitInfo.textContent = 'Maximum reached';
      limitInfo.style.color = '#b00';
    } else {
      addBtn.disabled = false;
      limitInfo.textContent = '';
    }

    if (!data.schedules || data.schedules.length === 0) {
      list.innerHTML = '<div class="muted">No schedules configured. Click "+ Add Schedule" to create one.</div>';
      return;
    }

    list.innerHTML = data.schedules.map(s => {
      // Handle both formats: days (array from AP) and days_mask (bitmask from Cloud sync)
      let daysText;
      if (s.days) {
        daysText = formatDays(s.days);
      } else if (s.days_mask !== undefined) {
        daysText = formatDaysFromMask(s.days_mask);
      } else {
        daysText = 'Unknown';
      }

      // Handle time format: either "HH:MM" string or separate hour/minute
      let timeText;
      if (s.time) {
        timeText = s.time;
      } else if (s.hour !== undefined && s.minute !== undefined) {
        timeText = `${String(s.hour).padStart(2,'0')}:${String(s.minute).padStart(2,'0')}`;
      } else {
        timeText = '--:--';
      }

      // Handle unit: 0=sec, 1=min, 2=hr OR string 'sec'/'min'/'hr'
      let unitText;
      if (typeof s.unit === 'string') {
        unitText = s.unit;
      } else {
        unitText = ['sec', 'min', 'hr'][s.unit] || 'sec';
      }

      const durationText = `${s.duration} ${unitText}`;
      const statusIcon = s.enabled ? '‚úÖ' : '‚ùå';

      // Edit/Delete buttons (enabled in both Cloud and Local modes)
      const buttons = `
        <div class="row">
          <button onclick="editSchedule(${s.id})">Edit</button>
          <button class="danger" onclick="deleteSchedule(${s.id})">Delete</button>
        </div>`;

      return `
        <div class="schedule-item ${s.enabled?'':'disabled'}">
          <div class="schedule-header">
            <div>
              <span style="font-size:24px">${statusIcon}</span>
              <span class="schedule-time">${timeText}</span>
              <span class="muted">‚Ä¢ ${durationText}</span>
            </div>
            ${buttons}
          </div>
          <div class="schedule-days muted">${daysText}</div>
        </div>
      `;
    }).join('');
  } catch(e) {
    console.error('Load schedules failed:', e);
  }
}

// Convert days_mask bitmask to human-readable text
function formatDaysFromMask(mask) {
  const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const days = [];
  for (let i = 0; i < 7; i++) {
    if (mask & (1 << i)) days.push(dayNames[i]);
  }
  if (days.length === 7) return 'Every day';
  // Check weekdays by mask value: bits 0-4 set = Mon-Fri = 0b00011111 = 31
  if (mask === 31) return 'Weekdays';
  return days.join(', ') || 'No days';
}

function formatDays(days) {
  const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  if (days.length === 7) return 'Every day';
  if (days.length === 5 && days.every(d => d <= 5)) return 'Weekdays';
  return days.map(d => dayNames[d-1]).join(', ');
}

async function showModalWithCheck() {
  // Check if limit reached
  try {
    const data = await API.get('/schedules');
    const count = data.schedules ? data.schedules.length : 0;
    if (count >= 8) {
      alert('Maximum 8 schedules allowed. Please delete an existing schedule first.');
      return;
    }
    showModal();
  } catch(e) {
    console.error('Check schedules failed:', e);
    showModal(); // Fallback: open anyway
  }
}

function showModal(id = null) {
  editingId = id;
  document.getElementById('modal-title').textContent = id !== null ? 'Edit Schedule' : 'Add Schedule';

  if (id !== null) {
    // Load existing schedule for editing
    API.get('/schedules')
      .then(data => {
        const s = data.schedules.find(x => x.id === id);
        if (s) {
          // Handle time format: "HH:MM" string or separate hour/minute
          let timeVal;
          if (s.time) {
            timeVal = s.time;
          } else if (s.hour !== undefined && s.minute !== undefined) {
            timeVal = `${String(s.hour).padStart(2,'0')}:${String(s.minute).padStart(2,'0')}`;
          } else {
            timeVal = '07:00';
          }
          document.getElementById('edit-time').value = timeVal;
          document.getElementById('edit-duration').value = s.duration;

          // Handle unit: number (0/1/2) or string ('sec'/'min'/'hr')
          let unitVal;
          if (typeof s.unit === 'string') {
            unitVal = s.unit;
          } else {
            unitVal = ['sec', 'min', 'hr'][s.unit] || 'sec';
          }
          document.getElementById('edit-unit').value = unitVal;
          document.getElementById('edit-enabled').checked = s.enabled !== false;

          // Convert days_mask to days array if needed, then set UI
          let days = [];
          if (s.days && Array.isArray(s.days)) {
            days = s.days;
          } else if (s.days_mask !== undefined) {
            for (let i = 0; i < 7; i++) {
              if (s.days_mask & (1 << i)) days.push(i + 1);
            }
          }

          document.querySelectorAll('.day-btn').forEach(btn => {
            const day = parseInt(btn.dataset.day);
            btn.classList.toggle('active', days.includes(day));
          });

          // Open modal AFTER data is loaded
          document.getElementById('modal').classList.add('show');
        }
      })
      .catch(e => {
        console.error('Failed to load schedule for editing:', e);
        alert('Failed to load schedule');
      });
  } else {
    // Reset form
    document.getElementById('edit-time').value = '07:00';
    document.getElementById('edit-duration').value = 30;
    document.getElementById('edit-unit').value = 'sec';
    document.getElementById('edit-enabled').checked = true;
    document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));

    // Open modal for new schedule
    document.getElementById('modal').classList.add('show');
  }
}

function closeModal() {
  document.getElementById('modal').classList.remove('show');
  editingId = null;
}

// Toggle day selection
document.querySelectorAll('.day-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    btn.classList.toggle('active');
  });
});

function selectAllDays() {
  const allActive = Array.from(document.querySelectorAll('.day-btn')).every(btn => btn.classList.contains('active'));

  if (allActive) {
    // All selected - deselect all
    document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
  } else {
    // Some not selected - select all
    document.querySelectorAll('.day-btn').forEach(btn => btn.classList.add('active'));
  }
}

function selectWeekdays() {
  const weekdayBtns = Array.from(document.querySelectorAll('.day-btn')).filter(btn => parseInt(btn.dataset.day) <= 5);
  const allWeekdaysActive = weekdayBtns.every(btn => btn.classList.contains('active'));

  if (allWeekdaysActive) {
    // All weekdays selected - deselect all weekdays
    weekdayBtns.forEach(btn => btn.classList.remove('active'));
  } else {
    // Some weekdays not selected - select all weekdays
    weekdayBtns.forEach(btn => btn.classList.add('active'));
  }
}

async function saveSchedule() {
  const time = document.getElementById('edit-time').value;
  const duration = parseInt(document.getElementById('edit-duration').value);
  const unit = document.getElementById('edit-unit').value;
  const enabled = document.getElementById('edit-enabled').checked;

  // Duration validation with reasonable limits
  const maxLimits = { sec: 300, min: 60, hr: 2 };  // 5min, 1hr, 2hr max
  const unitNames = { sec: 'seconds', min: 'minutes', hr: 'hours' };

  if (duration <= 0) {
    alert('Duration must be greater than 0');
    return;
  }

  if (duration > maxLimits[unit]) {
    alert(`Maximum duration for ${unitNames[unit]}: ${maxLimits[unit]}\n\nFor longer watering, consider multiple shorter schedules.`);
    return;
  }

  // Calculate total seconds and warn for large volumes
  const totalSec = duration * (unit === 'hr' ? 3600 : unit === 'min' ? 60 : 1);
  const estimatedMl = totalSec * 2.5;  // ~2.5 ml/sec pump calibration

  if (totalSec > 600 && !confirm(`‚ö†Ô∏è Warning: ${Math.round(totalSec/60)} minutes of watering!\n\nEstimated water: ~${Math.round(estimatedMl)} ml\n\nAre you sure?`)) {
    return;
  }

  const days = Array.from(document.querySelectorAll('.day-btn.active'))
    .map(btn => parseInt(btn.dataset.day));

  if (days.length === 0) {
    alert('Please select at least one day');
    return;
  }

  try {
    let id;
    if (editingId !== null) {
      // Editing existing schedule
      id = editingId;
    } else {
      // Find free slot (0-7)
      const data = await API.get('/schedules');
      const schedules = data.schedules || [];
      const usedIds = schedules.map(s => s.id);
      id = [0,1,2,3,4,5,6,7].find(i => !usedIds.includes(i));
      if (id === undefined) {
        alert('Maximum 8 schedules allowed');
        return;
      }
    }

    const schedule = { id, time, days, duration, unit, enabled };
    console.log('Saving schedule:', schedule);

    // API.post already returns parsed JSON
    const result = await API.post('/schedule/set', schedule);
    console.log('Server response:', result);

    if (!result.success) {
      alert('Error saving schedule');
      return;
    }

    closeModal();
    // Cloud mode: ESP32 publishes to DynamoDB via IoT Rule (async)
    // Wait 1.5 sec for DynamoDB to update before refreshing
    setTimeout(() => loadSchedules(), 1500);
  } catch(e) {
    console.error('Save error:', e);
    alert('Error saving schedule: ' + e.message);
  }
}

async function deleteSchedule(id) {
  if (!confirm('Delete this schedule?')) return;

  try {
    // Cloud mode: use POST with body, Local mode: use GET with query param
    if (IS_CLOUD) {
      await API.post('/schedule/delete', { id: id });
      // Cloud mode: wait for DynamoDB to update
      setTimeout(() => loadSchedules(), 1500);
    } else {
      await API.get('/schedule/delete?id=' + id);
      loadSchedules();
    }
  } catch(e) {
    alert('Error deleting schedule: ' + e.message);
  }
}

async function editSchedule(id) {
  showModal(id);
}

async function updateTime(){
  try {
    const t = await API.get('/time/status');
    const timeEl = document.getElementById('header-time');
    if (t.time_set && t.current_time) {
      timeEl.textContent=t.current_time.substring(11,16);
      timeEl.className = 'mono ok';
    } else {
      timeEl.textContent = '--:--';
      timeEl.className = 'mono danger';
    }
  } catch(e) {}
}

// mapStateToDisplay() - moved to common.js

async function updateBattery(){
  try {
    const b = await API.get('/battery/status');
    const el = document.getElementById('battery-status');
    if (b.percent !== null && b.percent !== undefined) {
      el.textContent = `üîã ${Math.round(b.percent)}%${b.charging ? ' ‚ö°' : ''}`;
    } else {
      el.textContent = '‚ö° AC';
    }
  } catch(e) { document.getElementById('battery-status').textContent = '‚ö° AC'; }
}

async function updateMode(){
  try {
    const s = await API.get('/status');

    // Battery (Cloud mode)
    const batteryStatus = document.getElementById('battery-status');
    if (s.battery && s.battery.percent !== null && s.battery.percent !== undefined) {
      batteryStatus.textContent = `üîã ${Math.round(s.battery.percent)}%${s.battery.charging ? ' ‚ö°' : ''}`;
    } else {
      batteryStatus.textContent = '‚ö° AC';
    }

    // Location, Room, Custom Name
    if (s.system_state?.location) {
      document.getElementById('location-text').textContent = s.system_state.location;
    }
    if (s.system_state?.room) {
      document.getElementById('room-text').textContent = s.system_state.room;
    }
    // Custom name suffix
    let customName = s.system_state?.device_name || 'Plant';
    if (customName === 'Polivalka' || customName.toLowerCase().startsWith('polivalka-')) {
      customName = 'Plant';
    }
    document.getElementById('custom-name-suffix').textContent = ' / ' + customName;

    // Mode
    const mode = s.system_state?.mode || 'off';
    const modeBadge = document.getElementById('mode-badge');
    const modeText = mode.charAt(0).toUpperCase() + mode.slice(1);
    modeBadge.textContent = modeText;
    modeBadge.className = 'status-badge status-' + mode;

    // Connection status
    const connText = document.getElementById('conn-text');
    if (s.wifi_connected) {
      connText.textContent = 'Online';
      connText.style.color = '#0a0';
    } else {
      connText.textContent = 'Offline';
      connText.style.color = '#999';
    }

    // Header state
    const rawState = s.system_state?.state || 'OFF';
    const displayState = mapStateToDisplay(rawState, s.pump_running);
    const headerStateEl = document.getElementById('header-state');
    if (headerStateEl) headerStateEl.textContent = `${displayState.emoji} ${displayState.text}`;
  } catch(e) {}
}

// monitorWiFiMode() - moved to common.js

// Cloud mode: –ø–æ–∫–∞–∑–∞—Ç—å device ID –≤ header —Å—Ä–∞–∑—É
if (IS_CLOUD && DEVICE_ID) {
  document.getElementById('device-id-header').textContent = 'üå± ' + DEVICE_ID;
  document.title = `${DEVICE_ID} ‚Äî Timer Mode`;
}

// Smart polling with visibility pause (saves API costs when tab hidden)
const MODE_INTERVAL = IS_CLOUD ? 60000 : 30000;
let modeIntervalId = null;

function startPolling() {
  if (modeIntervalId) return;
  modeIntervalId = setInterval(updateMode, MODE_INTERVAL);
}

function stopPolling() {
  if (modeIntervalId) {
    clearInterval(modeIntervalId);
    modeIntervalId = null;
  }
}

document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    stopPolling();
  } else {
    updateMode();
    startPolling();
  }
});

setInterval(updateBattery, 60000);   // Battery: every minute
updateBattery();
if (!IS_CLOUD) {
  setInterval(updateTime, 60000);      // Local mode: ESP32 time
  setInterval(monitorWiFiMode, 5000);
  updateTime();
  monitorWiFiMode();
}

// Initial load
updateMode();
startPolling();
loadSchedules();
</script>
</body></html>
