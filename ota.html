<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"><title>PlantApp ‚Äî Update</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<script src="api-adapter.js"></script>
<script src="common.js"></script>
<style>
    body{font-family:system-ui,Arial;margin:0;padding:0;max-width:100%}
    .header{position:sticky;top:0;z-index:1000;background:#2c5f2d;color:#fff;padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
    .header h1{margin:0;font-size:18px}
    .header-info{font-size:12px;text-align:right;line-height:1.3}
    .nav{position:sticky;top:65px;z-index:999;background:#f0f0f0;padding:5px 8px;display:flex;gap:2px;border-bottom:1px solid #ddd;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch}
    .nav a{text-decoration:none;color:#333;padding:6px 8px;border-radius:6px;font-size:14px;flex-shrink:0}
    .nav a.active{background:#2c5f2d;color:#fff}
    .nav a:hover{background:#ddd}
    .container{padding:18px;max-width:760px}
    .card{border:1px solid #ddd;padding:16px;border-radius:12px;margin:12px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .mono{font-family:ui-monospace,monospace}
    button{padding:8px 12px;border-radius:8px;border:1px solid #888;background:#fafafa;cursor:pointer}
    button.primary{background:#2c5f2d;color:#fff;border-color:#2c5f2d}
    button:disabled{background:#ccc;cursor:not-allowed;border-color:#999}
    .muted{color:#666;font-size:14px}
    .danger{color:#b00}
    .ok{color:#0a0}
    .status-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:13px;font-weight:600}
    .status-timer{background:#e3f2fd;color:#1976d2}
    .status-sensor{background:#fff3e0;color:#f57c00}
    .status-off{background:#fce4ec;color:#c2185b}
    .status-manual{background:#e0e0e0;color:#616161}
    .upload-area{border:2px dashed #ccc;border-radius:8px;padding:30px;text-align:center;margin:12px 0;cursor:pointer;transition:all 0.3s}
    .upload-area:hover{border-color:#2c5f2d;background:#f0f7f0}
    .upload-area.dragover{border-color:#2c5f2d;background:#e8f5e9}
    input[type="file"]{display:none}
    .file-info{margin:12px 0;padding:12px;background:#e8f5e9;border-radius:8px;font-size:14px}
    .progress-bar{width:100%;height:24px;background:#f0f0f0;border-radius:8px;overflow:hidden;margin:12px 0}
    .progress-fill{height:100%;background:#2c5f2d;transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;font-weight:600}
    .status-msg{margin:12px 0;padding:12px;border-radius:8px;font-size:14px}
    .status-msg.success{background:#e8f5e9;color:#2e7d32;border:1px solid #2e7d32}
    .status-msg.error{background:#ffebee;color:#c62828;border:1px solid #c62828}
    .warning-box{background:#fff3cd;padding:12px;border-radius:8px;font-size:13px;color:#856404;border:1px solid #ffc107}
</style>
</head><body><div class="header"><div><h1 id="device-id-header" style="margin:0;font-size:15px">üå± Polivalka</h1><div style="font-size:13px">üìç <span id="location-text">‚Äî</span> / <span id="room-text">‚Äî</span><span id="custom-name-suffix"></span></div><div style="font-size:11px;margin-top:4px"><span id="battery-status">üîã ‚Äî</span> ¬∑ <span id="header-state">üí§ Standby</span></div></div><div class="header-info"><div id="header-time" class="mono" style="font-size:11px">--:--</div><div style="font-size:11px" id="header-mode"><span id="mode-badge" class="status-badge">‚Äî</span></div><div style="font-size:11px" id="header-conn">üì° <span id="conn-text" style="transition:color 0.3s">...</span></div></div></div></div><div class="nav"><a href="/">Fleet</a><a href="home.html">Home</a><a href="identify.html" style="background:#e8f5e9">üå± Plant</a><a href="timer.html">Timer</a><a href="sensor.html">Sensor</a><a href="settings.html">Settings</a><a href="calibration.html">Calibration</a><a href="online.html">Online</a><a href="trends.html">Trends</a><a href="ota.html" class="active">Update</a><a href="admin.html" id="admin-nav-link" style="display:none">Admin</a></div><div class="container">

<div class="card">
<h3>üîÑ OTA Firmware Update</h3>
<div class="warning-box" style="margin-bottom:16px">
‚ö†Ô∏è <strong>Warning:</strong> Do NOT power off device during update! Update takes ~2-3 minutes. Device will restart automatically.
</div>

<div style="margin:12px 0">
<span class="muted">Current Firmware:</span> <span class="mono" id="current-version">‚Äî</span>
</div>

<div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
<div style="font-size:36px;margin-bottom:8px">üì¶</div>
<div style="font-size:15px;font-weight:600;margin-bottom:4px">Click to select firmware file</div>
<div style="font-size:12px;color:#666">or drag and drop polivalka.bin here</div>
</div>

<input type="file" id="fileInput" accept=".bin">

<div class="file-info" id="fileInfo" style="display:none">
<div><strong>File:</strong> <span id="fileName">‚Äî</span></div>
<div><strong>Size:</strong> <span id="fileSize">‚Äî</span></div>
<div><strong>New version:</strong> <span id="newVersion" class="ok">‚Äî</span></div>
</div>

<div class="row" style="margin-top:12px">
<button class="primary" id="uploadBtn" disabled onclick="startOTA()" style="width:100%">Upload & Update Firmware</button>
</div>

<div id="progressSection" style="display:none;margin-top:16px">
<div class="progress-bar">
<div class="progress-fill" id="progressFill" style="width:0%">0%</div>
</div>
<div class="muted" style="text-align:center" id="progressText">Uploading firmware...</div>
</div>

<div class="status-msg" id="statusMsg" style="display:none"></div>
</div>

</div>

<script>
let selectedFile = null;

async function loadHeaderData() {
  try {
    const s = await API.get('/status');

    // Battery
    const batteryEl = document.getElementById('battery-status');
    if (s.battery && s.battery.percent !== null && s.battery.percent !== undefined) {
      batteryEl.textContent = `üîã ${Math.round(s.battery.percent)}%${s.battery.charging ? ' ‚ö°' : ''}`;
    } else {
      batteryEl.textContent = '‚ö° AC';
    }

    // Location/Room
    if (s.system_state?.location) document.getElementById('location-text').textContent = s.system_state.location;
    if (s.system_state?.room) document.getElementById('room-text').textContent = s.system_state.room;

    // Custom name
    let customName = s.system_state?.device_name || 'Plant';
    if (customName === 'Polivalka' || customName.toLowerCase().startsWith('polivalka-')) customName = 'Plant';
    document.getElementById('custom-name-suffix').textContent = ' / ' + customName;

    // Mode badge
    const mode = s.system_state?.mode || 'off';
    const modeBadge = document.getElementById('mode-badge');
    modeBadge.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
    modeBadge.className = 'status-badge status-' + mode;

    // Connection
    const connText = document.getElementById('conn-text');
    if (s.wifi_connected) {
      connText.textContent = 'Online';
      connText.style.color = '#fff';
    } else {
      connText.textContent = 'Offline';
      connText.style.color = '#999';
    }

    // State
    const rawState = s.system_state?.state || 'OFF';
    const displayState = mapStateToDisplay(rawState, s.pump_running);
    document.getElementById('header-state').textContent = `${displayState.emoji} ${displayState.text}`;

    // Firmware version
    document.getElementById('current-version').textContent = s.firmware_version || '‚Äî';

  } catch(e) {
    console.error('Failed to load header data:', e);
  }
}

// File input handler
document.getElementById('fileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file && file.name.endsWith('.bin')) {
    selectedFile = file;
    showFileInfo(file);
  } else {
    showStatus('Please select a .bin file', 'error');
  }
});

// Drag & drop
const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadArea.classList.add('dragover');
});
uploadArea.addEventListener('dragleave', () => {
  uploadArea.classList.remove('dragover');
});
uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file && file.name.endsWith('.bin')) {
    selectedFile = file;
    showFileInfo(file);
  } else {
    showStatus('Please select a .bin file', 'error');
  }
});

function showFileInfo(file) {
  document.getElementById('fileName').textContent = file.name;
  document.getElementById('fileSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';

  // Parse version from filename: polivalka_v1.0.4.bin -> v1.0.4
  const versionMatch = file.name.match(/[_-](v\d+\.\d+\.\d+)\.bin$/i);
  document.getElementById('newVersion').textContent = versionMatch ? versionMatch[1] : 'unknown';

  document.getElementById('fileInfo').style.display = 'block';
  document.getElementById('uploadBtn').disabled = false;
}

async function startOTA() {
  if (!selectedFile) return;

  console.log('[OTA] Starting OTA update');
  console.log('[OTA] File:', selectedFile.name, 'Size:', selectedFile.size);

  const uploadBtn = document.getElementById('uploadBtn');
  const progressSection = document.getElementById('progressSection');
  const statusMsg = document.getElementById('statusMsg');

  uploadBtn.disabled = true;
  progressSection.style.display = 'block';
  statusMsg.style.display = 'none';

  try {
    updateProgress(10, 'Uploading to S3...');
    console.log('[OTA] Getting presigned URL...');
    const firmwareUrl = await uploadToS3(selectedFile);
    console.log('[OTA] Firmware uploaded, URL:', firmwareUrl);

    updateProgress(50, 'Triggering OTA update...');

    const versionMatch = selectedFile.name.match(/[_-](v\d+\.\d+\.\d+)\.bin$/i);
    const version = versionMatch ? versionMatch[1] : 'unknown';
    console.log('[OTA] Triggering OTA with version:', version);

    const result = await API.post('/ota', { url: firmwareUrl, version: version });
    console.log('[OTA] OTA trigger result:', result);

    updateProgress(60, 'Waiting for device response...');

    // Poll command status ‚Äî device may reject (battery, pump running, etc.)
    const cmdId = result.command_id;
    if (cmdId) {
      let deviceResponse = null;
      for (let i = 0; i < 15; i++) {
        await new Promise(r => setTimeout(r, 2000));
        updateProgress(60 + i * 2, `Waiting for device response... (${i*2}s)`);
        try {
          const cmdResult = await API.get(`/command/${cmdId}`);
          if (cmdResult.status === 'success') {
            deviceResponse = {ok: true, msg: cmdResult.result || 'OTA started'};
            break;
          } else if (cmdResult.status === 'error') {
            deviceResponse = {ok: false, msg: cmdResult.message || cmdResult.result || 'Device rejected OTA'};
            break;
          }
        } catch(e) { /* pending, keep polling */ }
      }

      if (deviceResponse && !deviceResponse.ok) {
        showStatus(`‚ùå Device rejected OTA: ${deviceResponse.msg}`, 'error');
        progressSection.style.display = 'none';
        uploadBtn.disabled = false;
        return;
      } else if (deviceResponse && deviceResponse.ok) {
        updateProgress(100, 'Device accepted OTA!');
        showStatus('‚úÖ OTA update accepted! Device will restart in ~60 seconds.', 'success');
        progressSection.style.display = 'none';
        return;
      }
    }

    // Timeout ‚Äî no response from device
    updateProgress(100, 'Command sent');
    showStatus('‚ö†Ô∏è OTA command sent but no response from device. It may be offline or updating.', 'error');
    progressSection.style.display = 'none';
    uploadBtn.disabled = false;

  } catch(e) {
    console.error('[OTA] OTA failed:', e);
    showStatus(`‚ùå Failed: ${e.message}`, 'error');
    progressSection.style.display = 'none';
    uploadBtn.disabled = false;
  }
}

async function uploadToS3(file) {
  console.log('[OTA] Requesting presigned URL from API...');
  const urlResponse = await API.get('/ota/upload-url');
  console.log('[OTA] Presigned URL response:', urlResponse);

  if (!urlResponse.upload_url) {
    console.error('[OTA] No upload_url in response');
    throw new Error('Failed to get upload URL');
  }

  const { upload_url, download_url } = urlResponse;
  console.log('[OTA] Uploading to S3...');

  const uploadResponse = await fetch(upload_url, {
    method: 'PUT',
    body: file,
    headers: { 'Content-Type': 'application/octet-stream' }
  });

  console.log('[OTA] S3 upload response:', uploadResponse.status, uploadResponse.statusText);
  if (!uploadResponse.ok) throw new Error(`S3 upload failed: ${uploadResponse.status}`);
  return download_url;
}

function updateProgress(percent, text) {
  document.getElementById('progressFill').style.width = percent + '%';
  document.getElementById('progressFill').textContent = percent + '%';
  document.getElementById('progressText').textContent = text;
}

function showStatus(message, type) {
  const el = document.getElementById('statusMsg');
  el.innerHTML = message;
  el.className = `status-msg ${type}`;
  el.style.display = 'block';
}

loadHeaderData();
</script>
</body></html>
