<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"><title>PlantApp ‚Äî Calibration</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<script src="api-adapter.js"></script>
<style>
body{font-family:system-ui,Arial;margin:0;padding:0;max-width:100%}
.header{position:sticky;top:0;z-index:1000;background:#2c5f2d;color:#fff;padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
.header h1{margin:0;font-size:18px}
.header-info{font-size:12px;text-align:right;line-height:1.3}
.nav{position:sticky;top:65px;z-index:999;background:#f0f0f0;padding:5px 8px;display:flex;gap:2px;border-bottom:1px solid #ddd;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch}
.nav a{text-decoration:none;color:#333;padding:6px 8px;border-radius:6px;font-size:14px;flex-shrink:0}
.nav a.active{background:#2c5f2d;color:#fff}
.nav a:hover{background:#ddd}
.container{padding:18px;max-width:760px}
.card{border:1px solid #ddd;padding:16px;border-radius:12px;margin:12px 0}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.mono{font-family:ui-monospace,monospace}
button{padding:8px 12px;border-radius:8px;border:1px solid #888;background:#fafafa;cursor:pointer}
button.primary{background:#2c5f2d;color:#fff;border-color:#2c5f2d}
.muted{color:#666;font-size:14px}
.danger{color:#b00}
.ok{color:#0a0}
.status-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:13px;font-weight:600}
.status-timer{background:#e3f2fd;color:#1976d2}
.status-sensor{background:#fff3e0;color:#f57c00}
.status-off{background:#fce4ec;color:#c2185b}
</style>
</head><body><div class="header"><div><h1 id="device-id-header" style="margin:0;font-size:15px">üå± Polivalka</h1><div style="font-size:13px">üìç <span id="location-text">‚Äî</span> / <span id="room-text">‚Äî</span><span id="custom-name-suffix"></span></div><div style="font-size:11px;margin-top:4px"><span id="battery-status">üîã ‚Äî</span> ¬∑ <span id="header-state">üí§ Standby</span></div></div><div class="header-info"><div id="header-time" class="mono" style="font-size:11px">--:--</div><div style="font-size:11px" id="header-mode">Mode: <span id="mode-badge" class="status-badge status-off">Off</span></div><div style="font-size:11px" id="header-conn">üì° <span id="conn-text">Offline</span></div></div></div></div><div class="nav"><a href="fleet.html">Fleet</a><a href="home.html">Home</a><a href="timer.html">Timer</a><a href="sensor.html">Sensor</a><a href="settings.html">Settings</a><a href="calibration.html" class="active">Calibration</a><a href="online.html">Online</a><a href="trends.html">Trends</a><a href="update.html">Update</a><a href="admin.html" id="admin-nav-link" style="display:none">Admin</a></div><div class="container"><div class="card"><h3>Sensor Calibration <span id="sensor-cal-badge" class="status-badge" style="font-size:12px;margin-left:8px">‚Äî</span></h3><p class="muted">3-point: Water=100%, Dry Soil=0%, Air=ref</p><div style="background:#f5f5f5;padding:12px;border-radius:8px;margin:8px 0"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div class="muted" style="font-size:12px">Current:</div><button onclick="updateCalibration()" style="padding:4px 8px;font-size:12px">üî¨ Read</button></div><div style="display:flex;gap:16px;align-items:center"><div class="mono" id="live-adc" style="font-size:18px;font-weight:600">ADC: ‚Äî</div><div class="mono" id="live-moisture" style="font-size:18px;font-weight:600;color:#2c5f2d">‚Äî</div></div></div><div class="mono" id="calib" style="font-size:14px">adc_air=‚Äî adc_water=‚Äî adc_dry_soil=‚Äî</div><div class="row" style="margin-top:12px"><button id="btn-air" onclick="calib('air')">Air</button><button id="btn-water" onclick="calib('water')">Water</button><button id="btn-soil" onclick="calib('soil')">Dry Soil</button><button onclick="resetCalib()">Reset</button></div><div class="muted" style="margin-top:8px">1) Water‚ÜíWater 2) Dry sensor+soil‚ÜíDry Soil 3) Air (opt)</div><div id="calib-warning" style="display:none;margin-top:8px;padding:8px;background:#fff3cd;border-radius:6px;color:#856404">‚ö†Ô∏è <span id="warning-text"></span></div></div><div class="card"><h3>Pump Calibration <span id="pump-cal-badge" class="status-badge" style="font-size:12px;margin-left:8px">‚Äî</span></h3><p class="muted">Measure flow rate (ml/sec)</p><div class="muted" style="margin:8px 0;font-size:13px">1) Fill tubes, remove air 2) Prepare cup/scale 3) Test & measure</div><div style="background:#f5f5f5;padding:12px;border-radius:8px;margin:12px 0"><div style="display:flex;justify-content:space-between;align-items:center"><div><div class="muted" style="font-size:12px">Flow:</div><div class="mono" style="font-size:18px;font-weight:600;color:#2c5f2d" id="current-ml-per-sec">-- ml/sec</div></div><button onclick="stopPump()" id="btn-stop-pump" style="background:#c62828;color:#fff;border-color:#c62828">‚èπ Stop</button></div></div><div style="border:1px solid #ddd;padding:12px;border-radius:8px;margin:8px 0"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><b>10s</b><button onclick="pumpTest(10)" id="test-10s">Run 10s</button></div><div style="display:flex;gap:8px;align-items:center"><input type="number" id="ml-10s" placeholder="ml" oninput="calculateResults()" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:4px" min="0" step="1"><span class="mono" id="result-10s" style="color:#666">‚Äî ml/s</span></div></div><div style="border:1px solid #ddd;padding:12px;border-radius:8px;margin:8px 0"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><b>30s</b><button onclick="pumpTest(30)" id="test-30s">Run 30s</button></div><div style="display:flex;gap:8px;align-items:center"><input type="number" id="ml-30s" placeholder="ml" oninput="calculateResults()" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:4px" min="0" step="1"><span class="mono" id="result-30s" style="color:#666">‚Äî ml/s</span></div></div><div style="border:1px solid #ddd;padding:12px;border-radius:8px;margin:8px 0"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><b>60s</b><button onclick="pumpTest(60)" id="test-60s">Run 60s</button></div><div style="display:flex;gap:8px;align-items:center"><input type="number" id="ml-60s" placeholder="ml" oninput="calculateResults()" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:4px" min="0" step="1"><span class="mono" id="result-60s" style="color:#666">‚Äî ml/s</span></div></div><div id="pump-result" style="display:none;background:#e8f5e9;padding:12px;border-radius:8px;margin:12px 0"><div><b>Avg:</b> <span class="mono" id="avg-ml-per-sec" style="font-size:18px">-- ml/s</span></div><div style="display:flex;gap:8px;margin-top:8px"><button onclick="saveCalibration()" class="primary">‚úì Save</button><button onclick="resetPumpCalib()">Reset</button></div></div><div id="pump-warning" style="display:none;margin-top:8px;padding:8px;background:#fff3cd;border-radius:6px;color:#856404">‚ö†Ô∏è <span id="pump-warning-text"></span></div></div></div>
<script>
// Map internal controller states to user-friendly display
function mapStateToDisplay(state, pumpRunning = false) {
  if (pumpRunning) return { text: 'Watering', emoji: 'üíß', color: '#1976d2' };
  const upperState = (state || '').toUpperCase();
  if (upperState === 'EMERGENCY' || upperState.includes('ERROR')) return { text: 'Emergency', emoji: '‚ö†Ô∏è', color: '#c62828' };
  if (['WATERING', 'PULSE', 'SETTLE', 'CHECK'].includes(upperState)) return { text: 'Watering', emoji: 'üíß', color: '#1976d2' };
  return { text: 'Standby', emoji: 'üí§', color: '#666' };
}

async function updateBattery(){
  try {
    const b = await API.get('/battery/status');
    const el = document.getElementById('battery-status');
    if (b.percent !== null && b.percent !== undefined) {
      el.textContent = `üîã ${Math.round(b.percent)}%${b.charging ? ' ‚ö°' : ''}`;
    } else {
      el.textContent = '‚ö° AC';
    }
  } catch(e) { document.getElementById('battery-status').textContent = '‚ö° AC'; }
}

async function loadAllData(){
try {
const s=await API.get('/status');
if(s.system_state?.location){document.getElementById('location-text').textContent=s.system_state.location;}
if(s.system_state?.room){document.getElementById('room-text').textContent=s.system_state.room;}
// Custom name suffix (always show device name, default to Plant)
let customName=s.system_state?.device_name||'Plant';
if(customName==='Polivalka')customName='Plant';
document.getElementById('custom-name-suffix').textContent=' / '+customName;
const mode=s.system_state?.mode||'off';const modeBadge=document.getElementById('mode-badge');
const modeText=mode.charAt(0).toUpperCase()+mode.slice(1);
modeBadge.textContent=modeText;modeBadge.className='status-badge status-'+mode;
const connText=document.getElementById('conn-text');
if(s.wifi_connected){connText.textContent='Online';connText.style.color='#0a0';}else{connText.textContent='Offline';connText.style.color='#999';}
document.getElementById('live-adc').textContent=`ADC: ${s.adc}`;
const moistureEl=document.getElementById('live-moisture');
if(s.percent!==null&&s.percent!==undefined){moistureEl.textContent=`${s.percent}%`;}else{moistureEl.textContent='Not calibrated';}
const air=s.calib.adc_air;const water=s.calib.adc_water;const soil=s.calib.adc_dry_soil;
document.getElementById('calib').textContent=`adc_air=${air}  adc_water=${water}  adc_dry_soil=${soil||'‚Äî'}`;
const sensorBadge=document.getElementById('sensor-cal-badge');
if(s.sensor_calibrated){sensorBadge.textContent='‚úì Calibrated';sensorBadge.style.background='#e8f5e9';sensorBadge.style.color='#2e7d32';}
else{sensorBadge.textContent='‚ö†Ô∏è Defaults';sensorBadge.style.background='#fff3e0';sensorBadge.style.color='#f57c00';}
if(air!==null&&soil!==null&&air!=='‚Äî'&&soil!=='‚Äî'){
const diff=Math.abs(air-soil);const warningDiv=document.getElementById('calib-warning');
const warningText=document.getElementById('warning-text');
if(diff>200){warningText.textContent=`Air (${air}) vs Soil (${soil}) >200! Dry soil first`;warningDiv.style.display='block';}
else{warningDiv.style.display='none';}}
// Header state
const rawState=s.system_state?.state||'OFF';const displayState=mapStateToDisplay(rawState,s.pump_running);
const headerStateEl=document.getElementById('header-state');if(headerStateEl)headerStateEl.textContent=`${displayState.emoji} ${displayState.text}`;
}catch(e){}}
async function updateCalibration(){
const btn=event?event.target:document.querySelector('button[onclick*="updateCalibration"]');
if(btn){btn.disabled=true;btn.textContent='‚è≥';}
try{await API.get('/moisture');
await new Promise(r=>setTimeout(r,500));await loadAllData();}catch(e){alert('Read failed');}
if(btn){btn.disabled=false;btn.textContent='üî¨ Read';}}
async function updateTime(){
try{const t=await API.get('/time/status');
const timeEl=document.getElementById('header-time');
if(t.time_set&&t.current_time){timeEl.textContent=t.current_time.substring(11,16);timeEl.className='mono ok';}
else{timeEl.textContent='--:--';timeEl.className='mono danger';}}catch(e){}}
async function calib(kind){
document.getElementById('btn-air').disabled=true;document.getElementById('btn-water').disabled=true;
document.getElementById('btn-soil').disabled=true;const CAL_SEC=2;
for(let t=CAL_SEC;t>0;t--){await new Promise(r=>setTimeout(r,1000));}
try {
  if (IS_CLOUD) {
    // Cloud: use MQTT command
    await API.post('/command', {command: 'calibrate_sensor', params: {type: kind}});
    await new Promise(r=>setTimeout(r,2000)); // Wait for MQTT propagation
  } else {
    // Local: direct ESP32 API
    const params={'air':'dry=1','water':'wet=1','soil':'soil=1'};
    await fetch('/api/calibrate?'+params[kind]+'&hold='+(CAL_SEC*1000),{cache:'no-store'});
  }
} catch(e) { console.error('Calibration error:', e); }
document.getElementById('btn-air').disabled=false;document.getElementById('btn-water').disabled=false;
document.getElementById('btn-soil').disabled=false;updateCalibration();}
async function resetCalib(){
  try {
    if (IS_CLOUD) {
      await API.post('/command', {command: 'reset_sensor_calibration', params: {}});
      await new Promise(r=>setTimeout(r,2000));
    } else {
      await fetch('/api/reset',{cache:'no-store'});
    }
  } catch(e) { console.error('Reset error:', e); }
  updateCalibration();
}
async function loadPumpCalibration(){
try{const s=await API.get('/pump/status');
const ml=s.ml_per_sec||10.0;document.getElementById('current-ml-per-sec').textContent=ml.toFixed(2)+' ml/sec';
const pumpBadge=document.getElementById('pump-cal-badge');
if(s.calibrated){pumpBadge.textContent='‚úì Calibrated';pumpBadge.style.background='#e8f5e9';pumpBadge.style.color='#2e7d32';}
else{pumpBadge.textContent='‚ö†Ô∏è Defaults';pumpBadge.style.background='#fff3e0';pumpBadge.style.color='#f57c00';}}catch(e){}}
let activePumpTimer=null;
let activePumpBtn=null;
let activePumpDuration=null;

async function pumpTest(duration){
const btn=document.getElementById('test-'+duration+'s');if(!btn)return;
btn.disabled=true;btn.style.background='#1976d2';btn.style.color='#fff';
activePumpBtn=btn;activePumpDuration=duration;
try{
  if (IS_CLOUD) {
    await API.post('/pump?sec='+duration);
  } else {
    await fetch('/api/pump/test?sec='+duration,{cache:'no-store'});
  }
  let remaining=duration;
  btn.textContent='üíß '+remaining+'s';
  activePumpTimer=setInterval(()=>{
    remaining--;
    if(remaining>0){btn.textContent='üíß '+remaining+'s';}
    else{clearPumpTimer();btn.textContent='‚úì Done';btn.style.background='#4caf50';
      setTimeout(()=>{btn.textContent='Run '+duration+'s';btn.disabled=false;btn.style.background='';btn.style.color='';},1500);}
  },1000);
} catch(e){btn.textContent='‚ùå Error';btn.style.background='#c62828';
  setTimeout(()=>{btn.textContent='Run '+duration+'s';btn.disabled=false;btn.style.background='';btn.style.color='';},2000);}}

function clearPumpTimer(){
  if(activePumpTimer){clearInterval(activePumpTimer);activePumpTimer=null;}
}

async function stopPump(){
const btn=document.getElementById('btn-stop-pump');
btn.disabled=true;btn.textContent='‚è≥';
clearPumpTimer();
if(activePumpBtn){
  activePumpBtn.textContent='‚èπ Stopped';activePumpBtn.style.background='#ff9800';
  setTimeout(()=>{activePumpBtn.textContent='Run '+activePumpDuration+'s';activePumpBtn.disabled=false;activePumpBtn.style.background='';activePumpBtn.style.color='';activePumpBtn=null;},1500);
}
try{
  if (IS_CLOUD) {
    await API.post('/pump/stop');
  } else {
    await fetch('/api/pump/stop',{method:'POST',cache:'no-store'});
  }
  btn.textContent='‚úì Stopped';
  setTimeout(()=>{btn.textContent='‚èπ Stop';btn.disabled=false;},2000);
} catch(e){btn.textContent='‚ùå';setTimeout(()=>{btn.textContent='‚èπ Stop';btn.disabled=false;},2000);}}
function calculateResults(){
const ml10=parseFloat(document.getElementById('ml-10s').value)||0;
const ml30=parseFloat(document.getElementById('ml-30s').value)||0;
const ml60=parseFloat(document.getElementById('ml-60s').value)||0;
let rates=[];let hasData=false;
if(ml10>0){const rate=ml10/10;document.getElementById('result-10s').textContent=rate.toFixed(2)+' ml/s';rates.push(rate);hasData=true;}
else{document.getElementById('result-10s').textContent='‚Äî ml/s';}
if(ml30>0){const rate=ml30/30;document.getElementById('result-30s').textContent=rate.toFixed(2)+' ml/s';rates.push(rate);hasData=true;}
else{document.getElementById('result-30s').textContent='‚Äî ml/s';}
if(ml60>0){const rate=ml60/60;document.getElementById('result-60s').textContent=rate.toFixed(2)+' ml/s';rates.push(rate);hasData=true;}
else{document.getElementById('result-60s').textContent='‚Äî ml/s';}
if(rates.length>=2){const avg=rates.reduce((a,b)=>a+b,0)/rates.length;
document.getElementById('avg-ml-per-sec').textContent=avg.toFixed(2)+' ml/s';
document.getElementById('pump-result').style.display='block';
const maxRate=Math.max(...rates);const minRate=Math.min(...rates);const variance=((maxRate-minRate)/avg)*100;
const warningDiv=document.getElementById('pump-warning');const warningText=document.getElementById('pump-warning-text');
if(variance>10){warningText.textContent='Variance '+variance.toFixed(1)+'% - check air bubbles';warningDiv.style.display='block';}
else{warningDiv.style.display='none';}}
else{document.getElementById('pump-result').style.display='none';document.getElementById('pump-warning').style.display='none';}}
async function saveCalibration(){
const avgText=document.getElementById('avg-ml-per-sec').textContent;const ml_per_sec=parseFloat(avgText);
if(!ml_per_sec||ml_per_sec<=0){alert('Invalid value');return;}
try{
  if (IS_CLOUD) {
    await API.post('/command', {command: 'set_pump_calibration', params: {ml_per_sec: ml_per_sec}});
    await new Promise(r=>setTimeout(r,2000));
  } else {
    await fetch('/api/pump/calibrate?ml_per_sec='+ml_per_sec,{cache:'no-store'});
  }
  alert('Saved: '+ml_per_sec.toFixed(2)+' ml/sec');loadPumpCalibration();
}catch(e){alert('Save failed');}}
async function resetPumpCalib(){
try{
  if (IS_CLOUD) {
    await API.post('/command', {command: 'reset_pump_calibration', params: {}});
    await new Promise(r=>setTimeout(r,2000));
  } else {
    await fetch('/api/pump/reset',{cache:'no-store'});
  }
  alert('Pump calibration reset to default (2.5 ml/sec)');loadPumpCalibration();
}catch(e){alert('Reset failed');}}
// Cloud mode: –ø–æ–∫–∞–∑–∞—Ç—å device ID –≤ header —Å—Ä–∞–∑—É
if (IS_CLOUD && DEVICE_ID) {
  document.getElementById('device-id-header').textContent = 'üå± ' + DEVICE_ID;
  document.title = `${DEVICE_ID} ‚Äî Calibration`;
}

// Cloud mode: show remote assistance notice (buttons work!)
if (IS_CLOUD) {
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.container');
    if (container) {
      const notice = document.createElement('div');
      notice.style.cssText = 'background:#e3f2fd;color:#1565c0;padding:12px 16px;border-radius:8px;margin-bottom:12px;font-size:14px';
      notice.innerHTML = '<b>üìû Remote Calibration</b> ‚Äî You can calibrate remotely while someone assists at the device.';
      container.insertBefore(notice, container.firstChild);
    }
  });
}

updateTime();loadAllData();loadPumpCalibration();

// Show Admin nav link only for admins
(function() {
  const ADMIN_EMAILS = ['mrmaximshurigin@gmail.com', 'admin@plantapp.pro'];
  const userEmail = localStorage.getItem('user_email') || '';
  if (ADMIN_EMAILS.includes(userEmail.toLowerCase())) {
    const adminLink = document.getElementById('admin-nav-link');
    if (adminLink) adminLink.style.display = '';
  }
})();

// Track WiFi mode to detect disconnection
var lastWiFiMode = null;
var lastStaIp = null;

async function monitorWiFiMode() {
  try {
    const response = await fetch('/wifi/status', {
      method: 'POST',
      cache: 'no-store'
    });
    const result = await response.json();
    const currentMode = result.mode;
    const currentStaIp = result.sta_ip || null;

    // Initialize on first call
    if (lastWiFiMode === null) {
      lastWiFiMode = currentMode;
      lastStaIp = currentStaIp;
      return;
    }

    // Detect NEW connection to router (sta_ip appeared) - redirect immediately!
    if (!lastStaIp && currentStaIp) {
      console.log('Connected to router, redirecting to ' + currentStaIp);
      window.location.href = 'http://' + currentStaIp + window.location.pathname;
      return;
    }

    if (lastWiFiMode && (lastWiFiMode === 'sta' || lastWiFiMode === 'apsta') && currentMode === 'ap') {
      console.log('WiFi disconnected, redirecting to AP mode...');
      window.location.href = 'http://192.168.4.1' + window.location.pathname;
      return;
    }

    lastWiFiMode = currentMode;
    lastStaIp = currentStaIp;
  } catch(e) {
    // Connection lost - try AP fallback
    console.log('Connection lost, trying AP fallback...');
    try {
      await fetch('http://192.168.4.1/api/wifi/status', {
        method: 'POST',
        cache: 'no-store'
      });
      // AP is accessible - redirect
      console.log('AP accessible, redirecting...');
      window.location.href = 'http://192.168.4.1' + window.location.pathname;
    } catch(e2) {
      // AP not accessible yet, will retry on next poll
    }
  }
}

setInterval(updateTime, 60000);
setInterval(updateBattery, 60000);  // Battery: every minute
updateBattery();
if (!IS_CLOUD) {
  setInterval(monitorWiFiMode, 5000);  // 5 sec - balance UX/load (active calibration operations)
  monitorWiFiMode();  // Initial load - only in local mode
}
</script>
</body></html>
