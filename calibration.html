<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"><title>PlantApp â€” Calibration</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml">
<script src="api-adapter.js"></script>
<script src="common.js"></script>
<style>
body{font-family:system-ui,Arial;margin:0;padding:0;max-width:100%}
.header{position:sticky;top:0;z-index:1000;background:#2c5f2d;color:#fff;padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px}
.header h1{margin:0;font-size:18px}
.header-info{font-size:12px;text-align:right;line-height:1.3}
.nav{position:sticky;top:65px;z-index:999;background:#f0f0f0;padding:5px 8px;display:flex;gap:2px;border-bottom:1px solid #ddd;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch}
.nav a{text-decoration:none;color:#333;padding:6px 8px;border-radius:6px;font-size:14px;flex-shrink:0}
.nav a.active{background:#2c5f2d;color:#fff}
.nav a:hover{background:#ddd}
.container{padding:18px;max-width:760px}
.card{border:1px solid #ddd;padding:16px;border-radius:12px;margin:12px 0}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.mono{font-family:ui-monospace,monospace}
button{padding:8px 12px;border-radius:8px;border:1px solid #888;background:#fafafa;cursor:pointer}
button.primary{background:#2c5f2d;color:#fff;border-color:#2c5f2d}
.muted{color:#666;font-size:14px}
.danger{color:#b00}
.ok{color:#0a0}
.status-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:13px;font-weight:600}
.status-timer{background:#e3f2fd;color:#1976d2}
.status-sensor{background:#fff3e0;color:#f57c00}
.status-off{background:#fce4ec;color:#c2185b}
    .status-manual{background:#e0e0e0;color:#616161}
</style>
</head><body><div class="header"><div><h1 id="device-id-header" style="margin:0;font-size:15px">ğŸŒ± Polivalka</h1><div style="font-size:13px">ğŸ“ <span id="location-text">â€”</span> / <span id="room-text">â€”</span><span id="custom-name-suffix"></span></div><div style="font-size:11px;margin-top:4px"><span id="battery-status">ğŸ”‹ â€”</span> Â· <span id="header-state">ğŸ’¤ Standby</span></div></div><div class="header-info"><div id="header-time" class="mono" style="font-size:11px">--:--</div><div style="font-size:11px" id="header-mode"><span id="mode-badge" class="status-badge">â€”</span></div><div style="font-size:11px" id="header-conn">ğŸ“¡ <span id="conn-text">Offline</span></div></div></div></div><div class="nav"><a href="/">Fleet</a><a href="home.html">Home</a><a href="identify.html" style="background:#e8f5e9">ğŸŒ± Plant</a><a href="timer.html">Timer</a><a href="sensor.html">Sensor</a><a href="settings.html">Settings</a><a href="calibration.html" class="active">Calibration</a><a href="online.html">Online</a><a href="trends.html">Trends</a><a href="ota.html">Update</a><a href="admin.html" id="admin-nav-link" style="display:none">Admin</a></div><div class="container"><div class="card"><h3>Capacitive Sensor <span id="sensor-cal-badge" class="status-badge" style="font-size:12px;margin-left:8px">â€”</span></h3><p class="muted">3-point: Water=100%, Dry Soil=0%, Air=ref</p><div style="background:#f5f5f5;padding:12px;border-radius:8px;margin:8px 0"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div class="muted" style="font-size:12px">Current:</div><button onclick="updateCalibration()" style="padding:4px 8px;font-size:12px">ğŸ”¬ Read</button></div><div style="display:flex;gap:16px;align-items:center"><div class="mono" id="live-adc" style="font-size:18px;font-weight:600">ADC: â€”</div><div class="mono" id="live-moisture" style="font-size:18px;font-weight:600;color:#2c5f2d">â€”</div></div></div><div class="mono" id="calib" style="font-size:14px">adc_air=â€” adc_water=â€” adc_dry_soil=â€”</div><div class="row" style="margin-top:12px"><button id="btn-air" onclick="calib('air')">Air</button><button id="btn-water" onclick="calib('water')">Water</button><button id="btn-soil" onclick="calib('soil')">Dry Soil</button><button onclick="resetCalib()">Reset</button></div><div class="muted" style="margin-top:8px">1) Waterâ†’Water 2) Dry sensor+soilâ†’Dry Soil 3) Air (opt)</div><div id="calib-warning" style="display:none;margin-top:8px;padding:8px;background:#fff3cd;border-radius:6px;color:#856404">âš ï¸ <span id="warning-text"></span></div></div><div class="card"><h3>Resistive Sensor <span id="sensor2-cal-badge" class="status-badge" style="font-size:12px;margin-left:8px">â€”</span></h3><p class="muted">2-point: Wet Soil=100%, Dry Soil=0%</p><div style="background:#f5f5f5;padding:12px;border-radius:8px;margin:8px 0"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div class="muted" style="font-size:12px">Current:</div><button onclick="updateSensor2()" style="padding:4px 8px;font-size:12px">ğŸ”¬ Read</button></div><div style="display:flex;gap:16px;align-items:center"><div class="mono" id="s2-live-adc" style="font-size:18px;font-weight:600">ADC: â€”</div><div class="mono" id="s2-live-moisture" style="font-size:18px;font-weight:600;color:#2c5f2d">â€”</div></div></div><div class="mono" id="s2-calib" style="font-size:14px">adc_dry=â€” adc_wet=â€”</div><div class="row" style="margin-top:12px"><button id="btn-s2-dry" onclick="calib2('dry')">Dry Soil</button><button id="btn-s2-wet" onclick="calib2('wet')">Wet Soil</button><button onclick="resetCalib2()">Reset</button></div><div class="muted" style="margin-top:8px">1) Dry soilâ†’Dry Soil 2) Wet soilâ†’Wet Soil</div></div><div class="card"><h3>Pump Calibration <span id="pump-cal-badge" class="status-badge" style="font-size:12px;margin-left:8px">â€”</span></h3><p class="muted">Measure flow rate (ml/sec)</p><div id="speed-warning" style="display:none;margin:8px 0;padding:10px;background:#e3f2fd;border:1px solid #1976d2;border-radius:8px;color:#1565c0"></div><div class="muted" style="margin:8px 0;font-size:13px">1) Fill tubes, remove air 2) Prepare cup/scale 3) Test & measure</div><div style="background:#f5f5f5;padding:12px;border-radius:8px;margin:12px 0"><div style="display:flex;justify-content:space-between;align-items:center"><div><div class="muted" style="font-size:12px">Flow:</div><div class="mono" style="font-size:18px;font-weight:600;color:#2c5f2d" id="current-ml-per-sec">-- ml/sec</div></div><button onclick="stopPump()" id="btn-stop-pump" style="background:#c62828;color:#fff;border-color:#c62828">â¹ Stop</button></div></div><div style="border:1px solid #ddd;padding:12px;border-radius:8px;margin:8px 0"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><b>10s</b><button onclick="pumpTest(10)" id="test-10s">Run 10s</button></div><div style="display:flex;gap:8px;align-items:center"><input type="number" id="ml-10s" placeholder="ml" oninput="calculateResults()" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:4px" min="0" step="1"><span class="mono" id="result-10s" style="color:#666">â€” ml/s</span></div></div><div style="border:1px solid #ddd;padding:12px;border-radius:8px;margin:8px 0"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><b>30s</b><button onclick="pumpTest(30)" id="test-30s">Run 30s</button></div><div style="display:flex;gap:8px;align-items:center"><input type="number" id="ml-30s" placeholder="ml" oninput="calculateResults()" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:4px" min="0" step="1"><span class="mono" id="result-30s" style="color:#666">â€” ml/s</span></div></div><div style="border:1px solid #ddd;padding:12px;border-radius:8px;margin:8px 0"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><b>60s</b><button onclick="pumpTest(60)" id="test-60s">Run 60s</button></div><div style="display:flex;gap:8px;align-items:center"><input type="number" id="ml-60s" placeholder="ml" oninput="calculateResults()" style="flex:1;padding:6px;border:1px solid #ccc;border-radius:4px" min="0" step="1"><span class="mono" id="result-60s" style="color:#666">â€” ml/s</span></div></div><div id="pump-result" style="display:none;background:#e8f5e9;padding:12px;border-radius:8px;margin:12px 0"><div><b>Avg:</b> <span class="mono" id="avg-ml-per-sec" style="font-size:18px">-- ml/s</span></div><div style="display:flex;gap:8px;margin-top:8px"><button onclick="saveCalibration()" class="primary">âœ“ Save</button><button onclick="resetPumpCalib()">Reset</button></div></div><div id="pump-warning" style="display:none;margin-top:8px;padding:8px;background:#fff3cd;border-radius:6px;color:#856404">âš ï¸ <span id="pump-warning-text"></span></div></div></div>
<script>
// mapStateToDisplay() - moved to common.js

async function updateBattery(){
  try {
    const b = await API.get('/battery/status');
    const el = document.getElementById('battery-status');
    if (b.percent !== null && b.percent !== undefined) {
      el.textContent = `ğŸ”‹ ${Math.round(b.percent)}%${b.charging ? ' âš¡' : ''}`;
    } else {
      el.textContent = 'âš¡ AC';
    }
  } catch(e) { document.getElementById('battery-status').textContent = 'âš¡ AC'; }
}

async function loadAllData(){
try {
const s=await API.get('/status');
// Battery (Cloud mode)
const batteryStatus=document.getElementById('battery-status');
if(s.battery&&s.battery.percent!==null&&s.battery.percent!==undefined){batteryStatus.textContent=`ğŸ”‹ ${Math.round(s.battery.percent)}%${s.battery.charging?' âš¡':''}`;}else{batteryStatus.textContent='âš¡ AC';}
if(s.system_state?.location){document.getElementById('location-text').textContent=s.system_state.location;}
if(s.system_state?.room){document.getElementById('room-text').textContent=s.system_state.room;}
let customName=s.system_state?.device_name||'Plant';
if(customName==='Polivalka'||customName.toLowerCase().startsWith('polivalka-'))customName='Plant';
document.getElementById('custom-name-suffix').textContent=' / '+customName;
const mode=s.system_state?.mode||'off';const modeBadge=document.getElementById('mode-badge');
const modeText=mode.charAt(0).toUpperCase()+mode.slice(1);
modeBadge.textContent=modeText;modeBadge.className='status-badge status-'+mode;
const connText=document.getElementById('conn-text');
if(s.wifi_connected){connText.textContent='Online';connText.style.color='#0a0';}else{connText.textContent='Offline';connText.style.color='#999';}
document.getElementById('live-adc').textContent=`ADC: ${s.adc}`;
const moistureEl=document.getElementById('live-moisture');
const pctVal=(s.percent_float!==undefined&&s.percent_float!==null)?s.percent_float.toFixed(1):(s.percent!==null&&s.percent!==undefined?s.percent:'â€”');
if(pctVal!==null&&pctVal!==undefined&&pctVal!=='â€”'){moistureEl.textContent=`${pctVal}%`;}else{moistureEl.textContent='Not calibrated';}
// Update sensor2 from main status (Cloud mode - no separate /sensor2/status endpoint)
if(s.sensor2_adc!==undefined&&s.sensor2_adc!==null){
const s2pct=(s.sensor2_percent_float!==undefined&&s.sensor2_percent_float!==null)?s.sensor2_percent_float.toFixed(1):(s.sensor2_percent!==null&&s.sensor2_percent!==undefined?s.sensor2_percent:'â€”');
document.getElementById('s2-live-adc').textContent='ADC: '+s.sensor2_adc;
document.getElementById('s2-live-moisture').textContent=s2pct+'%';}
// Sensor2 calibration (Cloud mode)
if(s.sensor2_calib){
document.getElementById('s2-calib').textContent='adc_dry='+s.sensor2_calib.dry+'  adc_wet='+s.sensor2_calib.wet;
const s2badge=document.getElementById('sensor2-cal-badge');
if(s.sensor2_calibrated){s2badge.textContent='âœ“ Calibrated';s2badge.style.background='#e8f5e9';s2badge.style.color='#2e7d32';}
else{s2badge.textContent='âš ï¸ Presets';s2badge.style.background='#fff3e0';s2badge.style.color='#f57c00';}}
const air=s.calib.adc_air;const water=s.calib.adc_water;const soil=s.calib.adc_dry_soil;
document.getElementById('calib').textContent=`adc_air=${air}  adc_water=${water}  adc_dry_soil=${soil||'â€”'}`;
const sensorBadge=document.getElementById('sensor-cal-badge');
if(s.sensor_calibrated){sensorBadge.textContent='âœ“ Calibrated';sensorBadge.style.background='#e8f5e9';sensorBadge.style.color='#2e7d32';}
else{sensorBadge.textContent='âš ï¸ Presets';sensorBadge.style.background='#fff3e0';sensorBadge.style.color='#f57c00';}
if(air!==null&&soil!==null&&air!=='â€”'&&soil!=='â€”'){
const diff=Math.abs(air-soil);const warningDiv=document.getElementById('calib-warning');
const warningText=document.getElementById('warning-text');
if(diff>200){warningText.textContent=`Air (${air}) vs Soil (${soil}) >200! Dry soil first`;warningDiv.style.display='block';}
else{warningDiv.style.display='none';}}
// Header state
const rawState=s.system_state?.state||'OFF';const displayState=mapStateToDisplay(rawState,s.pump_running);
const headerStateEl=document.getElementById('header-state');if(headerStateEl)headerStateEl.textContent=`${displayState.emoji} ${displayState.text}`;
}catch(e){}}
async function updateCalibration(){
const btn=event?event.target:document.querySelector('button[onclick*="updateCalibration"]');
if(btn){btn.disabled=true;btn.textContent='â³';}
try{await API.get('/moisture');
await new Promise(r=>setTimeout(r,500));await loadAllData();}catch(e){alert('Read failed');}
if(btn){btn.disabled=false;btn.textContent='ğŸ”¬ Read';}}
async function updateTime(){
try{const t=await API.get('/time/status');
const timeEl=document.getElementById('header-time');
if(t.time_set&&t.current_time){timeEl.textContent=t.current_time.substring(11,16);timeEl.className='mono ok';}
else{timeEl.textContent='--:--';timeEl.className='mono danger';}}catch(e){}}
async function calib(kind){
document.getElementById('btn-air').disabled=true;document.getElementById('btn-water').disabled=true;
document.getElementById('btn-soil').disabled=true;const CAL_SEC=2;
for(let t=CAL_SEC;t>0;t--){await new Promise(r=>setTimeout(r,1000));}
try {
  if (IS_CLOUD) {
    // Cloud: use MQTT command
    await API.post('/command', {command: 'calibrate_sensor', params: {type: kind}});
    // Wait longer for MQTT propagation + ESP32 response + DynamoDB update
    await new Promise(r=>setTimeout(r,4000));
  } else {
    // Local: direct ESP32 API
    const params={'air':'dry=1','water':'wet=1','soil':'soil=1'};
    await fetch('/api/calibrate?'+params[kind]+'&hold='+(CAL_SEC*1000),{cache:'no-store'});
  }
} catch(e) { console.error('Calibration error:', e); }
document.getElementById('btn-air').disabled=false;document.getElementById('btn-water').disabled=false;
document.getElementById('btn-soil').disabled=false;
// Force fresh data fetch after calibration
await loadAllData();}
async function resetCalib(){
  try {
    if (IS_CLOUD) {
      await API.post('/command', {command: 'reset_sensor_calibration', params: {}});
      await new Promise(r=>setTimeout(r,4000));
    } else {
      await fetch('/api/reset',{cache:'no-store'});
    }
  } catch(e) { console.error('Reset error:', e); }
  await loadAllData();
}
// Sensor 2 (Resistive) functions - Cloud mode: data comes from main status, no separate endpoints
async function loadSensor2Data(){
// Cloud API doesn't have /sensor2/status or /sensor2/settings - data comes from loadAllData()
// This function is kept for local AP mode compatibility
try{
  if(typeof API !== 'undefined' && API.mode === 'local') {
    const s=await API.get('/sensor2/status');
    const pct=(s.percent_float!==undefined&&s.percent_float!==null)?s.percent_float.toFixed(1):s.percent;
    document.getElementById('s2-live-adc').textContent='ADC: '+s.adc;
    document.getElementById('s2-live-moisture').textContent=pct+'%';
    const settings=await API.get('/sensor2/settings');
    document.getElementById('s2-calib').textContent='adc_dry='+settings.dry+'  adc_wet='+settings.wet;
    const badge=document.getElementById('sensor2-cal-badge');
    if(settings.calibrated){badge.textContent='âœ“ Calibrated';badge.style.background='#e8f5e9';badge.style.color='#2e7d32';}
    else{badge.textContent='âš ï¸ Presets';badge.style.background='#fff3e0';badge.style.color='#f57c00';}
  }
}catch(e){console.log('Sensor2 data from main status in cloud mode');}}
async function updateSensor2(){
const btn=event?event.target:document.querySelector('button[onclick*="updateSensor2"]');
if(btn){btn.disabled=true;btn.textContent='â³';}
try{
  if(typeof API !== 'undefined' && API.mode === 'local') {
    await API.get('/sensor2/status');await new Promise(r=>setTimeout(r,500));await loadSensor2Data();
  } else {
    // Cloud mode: refresh from main status
    await loadAllData();
  }
}catch(e){console.log('Sensor2 refresh error:', e);}
if(btn){btn.disabled=false;btn.textContent='ğŸ”¬ Read';}}
async function calib2(kind){
document.getElementById('btn-s2-dry').disabled=true;document.getElementById('btn-s2-wet').disabled=true;
const CAL_SEC=2;for(let t=CAL_SEC;t>0;t--){await new Promise(r=>setTimeout(r,1000));}
try{
if(IS_CLOUD){await API.post('/command',{command:'sensor2_calibrate_'+kind,params:{}});await new Promise(r=>setTimeout(r,4000));}
else{await fetch('/api/sensor2/calibrate?'+kind+'=1',{cache:'no-store'});}
}catch(e){console.error('Calib2 error:',e);}
document.getElementById('btn-s2-dry').disabled=false;document.getElementById('btn-s2-wet').disabled=false;
loadSensor2Data();}
async function resetCalib2(){
try{
if(IS_CLOUD){await API.post('/command',{command:'reset_sensor2_calibration',params:{}});await new Promise(r=>setTimeout(r,4000));}
else{await fetch('/api/sensor2/reset',{cache:'no-store'});}
}catch(e){console.error('Reset2 error:',e);}
loadSensor2Data();}
async function loadPumpCalibration(){
try{const s=await API.get('/pump/status');
const ml=s.ml_per_sec||10.0;document.getElementById('current-ml-per-sec').textContent=ml.toFixed(2)+' ml/sec';
const pumpBadge=document.getElementById('pump-cal-badge');
if(s.calibrated){pumpBadge.textContent='âœ“ Calibrated';pumpBadge.style.background='#e8f5e9';pumpBadge.style.color='#2e7d32';}
else{pumpBadge.textContent='âš ï¸ Presets';pumpBadge.style.background='#fff3e0';pumpBadge.style.color='#f57c00';}
const speed=s.speed!==undefined?s.speed:100;
const speedWarn=document.getElementById('speed-warning');
if(speedWarn){if(speed!==100){speedWarn.style.display='block';speedWarn.innerHTML='â„¹ï¸ Pump speed is '+speed+'%. Calibration will apply to this speed. <a href="home.html">Change speed</a>';}
else{speedWarn.style.display='none';}}}catch(e){}}
let activePumpTimer=null;
let activePumpBtn=null;
let activePumpDuration=null;

async function pumpTest(duration){
const btn=document.getElementById('test-'+duration+'s');if(!btn)return;
btn.disabled=true;btn.style.background='#1976d2';btn.style.color='#fff';
activePumpBtn=btn;activePumpDuration=duration;
try{
  if (IS_CLOUD) {
    await API.post('/pump?sec='+duration);
  } else {
    await fetch('/api/pump/test?sec='+duration,{cache:'no-store'});
  }
  let remaining=duration;
  btn.textContent='ğŸ’§ '+remaining+'s';
  activePumpTimer=setInterval(()=>{
    remaining--;
    if(remaining>0){btn.textContent='ğŸ’§ '+remaining+'s';}
    else{clearPumpTimer();btn.textContent='âœ“ Done';btn.style.background='#4caf50';
      setTimeout(()=>{btn.textContent='Run '+duration+'s';btn.disabled=false;btn.style.background='';btn.style.color='';},1500);}
  },1000);
} catch(e){btn.textContent='âŒ Error';btn.style.background='#c62828';
  setTimeout(()=>{btn.textContent='Run '+duration+'s';btn.disabled=false;btn.style.background='';btn.style.color='';},2000);}}

function clearPumpTimer(){
  if(activePumpTimer){clearInterval(activePumpTimer);activePumpTimer=null;}
}

async function stopPump(){
const btn=document.getElementById('btn-stop-pump');
btn.disabled=true;btn.textContent='â³';
clearPumpTimer();
if(activePumpBtn){
  activePumpBtn.textContent='â¹ Stopped';activePumpBtn.style.background='#ff9800';
  setTimeout(()=>{activePumpBtn.textContent='Run '+activePumpDuration+'s';activePumpBtn.disabled=false;activePumpBtn.style.background='';activePumpBtn.style.color='';activePumpBtn=null;},1500);
}
try{
  if (IS_CLOUD) {
    await API.post('/pump/stop');
  } else {
    await fetch('/api/pump/stop',{method:'POST',cache:'no-store'});
  }
  btn.textContent='âœ“ Stopped';
  setTimeout(()=>{btn.textContent='â¹ Stop';btn.disabled=false;},2000);
} catch(e){btn.textContent='âŒ';setTimeout(()=>{btn.textContent='â¹ Stop';btn.disabled=false;},2000);}}
function calculateResults(){
const ml10=parseFloat(document.getElementById('ml-10s').value)||0;
const ml30=parseFloat(document.getElementById('ml-30s').value)||0;
const ml60=parseFloat(document.getElementById('ml-60s').value)||0;
let rates=[];let hasData=false;
if(ml10>0){const rate=ml10/10;document.getElementById('result-10s').textContent=rate.toFixed(2)+' ml/s';rates.push(rate);hasData=true;}
else{document.getElementById('result-10s').textContent='â€” ml/s';}
if(ml30>0){const rate=ml30/30;document.getElementById('result-30s').textContent=rate.toFixed(2)+' ml/s';rates.push(rate);hasData=true;}
else{document.getElementById('result-30s').textContent='â€” ml/s';}
if(ml60>0){const rate=ml60/60;document.getElementById('result-60s').textContent=rate.toFixed(2)+' ml/s';rates.push(rate);hasData=true;}
else{document.getElementById('result-60s').textContent='â€” ml/s';}
if(rates.length>=2){const avg=rates.reduce((a,b)=>a+b,0)/rates.length;
document.getElementById('avg-ml-per-sec').textContent=avg.toFixed(2)+' ml/s';
document.getElementById('pump-result').style.display='block';
const maxRate=Math.max(...rates);const minRate=Math.min(...rates);const variance=((maxRate-minRate)/avg)*100;
const warningDiv=document.getElementById('pump-warning');const warningText=document.getElementById('pump-warning-text');
if(variance>10){warningText.textContent='Variance '+variance.toFixed(1)+'% - check air bubbles';warningDiv.style.display='block';}
else{warningDiv.style.display='none';}}
else{document.getElementById('pump-result').style.display='none';document.getElementById('pump-warning').style.display='none';}}
async function saveCalibration(){
const avgText=document.getElementById('avg-ml-per-sec').textContent;const ml_per_sec=parseFloat(avgText);
if(!ml_per_sec||ml_per_sec<=0){alert('Invalid value');return;}
try{
  if (IS_CLOUD) {
    await API.post('/command', {command: 'set_pump_calibration', params: {ml_per_sec: ml_per_sec}});
    await new Promise(r=>setTimeout(r,2000));
  } else {
    await fetch('/api/pump/calibrate?ml_per_sec='+ml_per_sec,{cache:'no-store'});
  }
  alert('Saved: '+ml_per_sec.toFixed(2)+' ml/sec');loadPumpCalibration();
}catch(e){alert('Save failed');}}
async function resetPumpCalib(){
try{
  if (IS_CLOUD) {
    await API.post('/command', {command: 'reset_pump_calibration', params: {}});
    await new Promise(r=>setTimeout(r,2000));
  } else {
    await fetch('/api/pump/reset',{cache:'no-store'});
  }
  alert('Pump calibration reset to default (2.5 ml/sec)');loadPumpCalibration();
}catch(e){alert('Reset failed');}}
// Cloud mode: Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ device ID Ğ² header ÑÑ€Ğ°Ğ·Ñƒ
if (IS_CLOUD && DEVICE_ID) {
  document.getElementById('device-id-header').textContent = 'ğŸŒ± ' + DEVICE_ID;
  document.title = `${DEVICE_ID} â€” Calibration`;
}

// Cloud mode: show remote assistance notice (buttons work!)
if (IS_CLOUD) {
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.querySelector('.container');
    if (container) {
      const notice = document.createElement('div');
      notice.style.cssText = 'background:#e3f2fd;color:#1565c0;padding:12px 16px;border-radius:8px;margin-bottom:12px;font-size:14px';
      notice.innerHTML = '<b>ğŸ“ Remote Calibration</b> â€” You can calibrate remotely while someone assists at the device.';
      container.insertBefore(notice, container.firstChild);
    }
  });
}

loadAllData();loadSensor2Data();loadPumpCalibration();

// Time from common.js universal clock, battery/wifi separate
setInterval(updateBattery, 60000);
updateBattery();
if (!IS_CLOUD) {
  updateTime();
  setInterval(updateTime, 60000);
  setInterval(monitorWiFiMode, 5000);
  monitorWiFiMode();
}
</script>
</body></html>
